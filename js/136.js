(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[136],{27832:(e,i,t)=>{"use strict";e.exports=t.p+"images/objectColor.png"},74186:(e,i,t)=>{"use strict";e.exports=t.p+"images/objectIcon.png"},30749:(e,i,t)=>{"use strict";e.exports=t.p+"images/pinAnchor.png"},4592:(e,i,t)=>{"use strict";e.exports=t.p+"images/tagColor.png"},47247:(e,i,t)=>{"use strict";e.exports=t.p+"images/tagIcon.png"},55712:(e,i,t)=>{"use strict";t.d(i,{y:()=>DisableCursorMeshCommand});var n=t(93037);class DisableCursorMeshCommand extends n.m{constructor(e){super(),this.payload={disable:e}}}},63820:(e,i,t)=>{"use strict";t.r(i),t.d(i,{default:()=>CursorController});var n=t(57227),s=t(58193),a=t(22878),o=t(37363),d=t(72699),r=t(59057),c=t(53549),l=t(55712),h=t(61903),m=t(57312),u=t(45803),g=t(35784);class CursorController extends n.Y{constructor(){super(...arguments),this.name="cursor-controller",this.visibilityRules=[],this.disabled=!1}async init(e,i){[this.cursorMesh,this.cursorData]=await Promise.all([i.getModule(s.default),i.market.waitForData(u.Y)]),this.visibilityRules.push((()=>{const e=i.market.tryGetData(o.O);return!!e&&(0,a.Bw)(e.closestMode)}),(()=>{const e=i.market.tryGetData(c.Z);return!!e&&!e.isSweepUnaligned(e.currentSweep)}),(()=>{const e=i.market.tryGetData(d.k);return!!e&&!e.isTourActive()}),(()=>{const e=i.market.tryGetData(r.Z);return!!e&&!e.isMobile()}),(()=>{const e=i.market.tryGetData(h.e);return!!e&&e.tryGetProperty(m.b,!0)})),this.bindings.push(i.commandBinder.addBinding(l.y,(async e=>{this.disabled=e.disable})))}onUpdate(){this.updateCursorVisibility()}addVisibilityRule(e){this.visibilityRules.push(e)}removeVisibilityRule(e){const i=this.visibilityRules.indexOf(e);-1!==i&&this.visibilityRules.splice(i,1)}setFadeProps(e){const{fadeOut:i,fadeIn:t}=e;g.default.fadeOutDuration=i&&i.duration?i.duration:g.default.fadeOutDuration,g.default.fadeOutDelay=i&&i.delay?i.delay:g.default.fadeOutDelay,g.default.fadeInDuration=t&&t.duration?t.duration:g.default.fadeInDuration}updateCursorVisibility(){const e=!this.disabled&&this.visibilityRules.reduce(((e,i)=>e&&i()),!0);this.cursorMesh.setVisible(e)}setTexture(e){this.cursorData.texture=e}}},174:(e,i,t)=>{"use strict";t.d(i,{c:()=>n});const n=(e,i,t)=>{var n;return null!==(n=i.floorIdFromObject(t.object))&&void 0!==n?n:e.getClosestFloorAtHeight(t.point.y).id}},72136:(e,i,t)=>{"use strict";if(t.d(i,{z:()=>a,y:()=>MattertagEditorAnalytics}),984==t.j)var n=t(27696);if(984==t.j)var s=t(14909);var a;!function(e){e.DISC_COLOR="disc_color",e.STEM_VISIBLE="stem_visible",e.STEM_LENGTH="stem_length",e.TITLE="title",e.DESCRIPTION="description",e.MEDIA="media",e.LINKS="links",e.ENABLED="enabled",e.KEYWORDS="keywords"}(a||(a={}));class MattertagEditorAnalytics{constructor(){this.handlers=[{msgType:n.nP,func:(e,i)=>{const t={mattertag_sid:i.sid,mattertag_position:i.position,mattertag_distance_from_camera:i.distanceFromCamera};e.track("mattertag_add",t)}},{msgType:n.bF,func:(e,i)=>{const t={mattertag_sid:i.sid,mattertag_remove_method:i.removeMethod};e.track("mattertag_remove",t)}},{msgType:n.Y7,func:(e,i)=>{const t={mattertag_sid:i.sid,mattertag_character_count:i.characterCount};e.track("mattertag_add_title",t)}},{msgType:n.ug,func:(e,i)=>{const t={mattertag_sid:i.sid,mattertag_character_count:i.characterCount};let n=1;i.tagDescriptionChunks.forEach((e=>{"link"===e.type&&void 0!==e.link&&(t["mattertag_link_domain"+n++]=(0,s.QY)(e.link.url))})),e.track("mattertag_add_description",t)}},{msgType:n.dl,func:(e,i)=>{const t={mattertag_sid:i.sid,mattertag_property:i.property,mattertag_value:i.value};e.track("mattertag_edit",t)}},{msgType:n.sk,func:(e,i)=>{const t={mattertag_sid:i.sid,mattertag_position:i.position,mattertag_distance_from_camera:i.distanceFromCamera,mattertag_distance_moved:i.distanceMoved};e.track("mattertag_moved",t)}},{msgType:n.Qi,func:(e,i)=>{const t={mattertag_sid:i.sid,media_type:i.mediaType,media_src:i.mediaSrc};e.track("mattertag_add_media",t)}}]}}},27696:(e,i,t)=>{"use strict";t.d(i,{nP:()=>MattertagAddMessage,bF:()=>MattertagRemoveMessage,Y7:()=>MattertagAddTitleMessage,ug:()=>MattertagAddDescriptionMessage,Qi:()=>MattertagAddMediaMessage,dl:()=>MattertagEditedMessage,sk:()=>MattertagMovedMessage});var n=t(4117);class MattertagAddMessage extends n.v{constructor(e,i,t){super(),this.sid=e,this.position=i,this.distanceFromCamera=t}}class MattertagRemoveMessage extends n.v{constructor(e,i){super(),this.sid=e,this.removeMethod=i}}class MattertagAddTitleMessage extends n.v{constructor(e,i){super(),this.sid=e,this.characterCount=i}}class MattertagAddDescriptionMessage extends n.v{constructor(e,i,t){super(),this.sid=e,this.characterCount=i,this.tagDescriptionChunks=t}}class MattertagAddMediaMessage extends n.v{constructor(e,i,t){super(),this.sid=e,this.mediaType=i,this.mediaSrc=t}}class MattertagEditedMessage extends n.v{constructor(e,i,t){super(),this.sid=e,this.property=i,this.value=t}}class MattertagMovedMessage extends n.v{constructor(e,i,t,n){super(),this.sid=e,this.position=i,this.distanceFromCamera=t,this.distanceMoved=n}}},55187:(e,i,t)=>{"use strict";t.d(i,{n:()=>MeshPreviewSetPositonCommand});var n=t(93037);class MeshPreviewSetPositonCommand extends n.m{constructor(e,i,t){super(),this.id="MESH_PREVIEW_POSITION",this.payload={enabled:e,previewCirclePosition:i,size:t}}}},81653:(e,i,t)=>{"use strict";t.r(i),t.d(i,{default:()=>ObjectTagSuggestionsDataModule});var n,s,a,o=t(57227),d=t(2212),r=t(14832),c=t(39142),l=t(48730),h=t(18236),m=t(49315),u=t(65143),g=t(99380),p=t(40825),v=t(98461);!function(e){e.VISION="vision",e.USER="user"}(n||(n={})),function(e){e.UNREVIEWED="unreviewed",e.DISMISSED="dismissed",e.ACCEPTED="accepted",e.REJECTED="rejected"}(s||(s={})),function(e){e.FLOOR="FLOOR",e.TYPE="TYPE"}(a||(a={}));var b=t(91997),y=t(47357),T=t(29686),k=t(10854),w=t(19822),P=t(23400),C=t(81402),f=t(22149),D=t(14877);const{OBJECT_TAG_SUGGESTION:A}=k.Z.WORKSHOP;class ObjectTagSuggestionSearchResultItem extends T.K{constructor(e,i,t,n,s,a){super(e),this.suggestion=t,this.groupId=n,this.isEditable=s,this.mattertag=a,this.onToggleVisible=async e=>{this.suggestion.visible=!this.suggestion.visible,this.enabled=this.suggestion.visible,this.commandBinder.issueCommand(new v.Bh(this.suggestion.visible,this.suggestion.id)),e.stopPropagation();const i=this.suggestion.visible?"object_tags_show_click":"object_tags_hide_click";this.trackEvent(i)},this.onMattertagChange=()=>{this.updateLabels(),this.commandBinder.issueCommand(new f.s7)},this.updateLabels=()=>{var e,i;this.title=(null===(e=this.mattertag)||void 0===e?void 0:e.label)?this.mattertag.label:this.suggestion.displayLabel,this.description=(null===(i=this.mattertag)||void 0===i?void 0:i.description)?this.mattertag.description:this.suggestion.displayCategory},this.updateVisibility=()=>{this.enabled=this.suggestion.visible,this.actions&&(this.actions[0].icon=this.suggestion.visible?"eye-show":"eye-hide",this.actions[0].tooltipPhrasekey=this.suggestion.visible?A.SEARCH_ITEM_HIDE_TOOLTIP:A.SEARCH_ITEM_SHOW_TOOLTIP),this.commandBinder.issueCommand(new g.ik(this.suggestion.id,u.Er.OBJECT,this.suggestion.visible))},this.onEditClick=()=>{if(!this.suggestion.mattertagId){const e=this.suggestion.getMattertagOptions(),i=(0,C.O1)(11);this.commandBinder.issueCommand(new P.Mm(i,e)),this.suggestion.mattertagId=i}this.trackEvent("object_tags_edit_click"),this.commandBinder.issueCommand(new w.sf(this.suggestion.mattertagId,null,!0))},this.onDeleteClick=()=>{const e=this.suggestion.id;this.commandBinder.issueCommand(new v.AQ(e)),this.commandBinder.issueCommand(new g.OL(e,u.Er.OBJECT)),this.commandBinder.issueCommand(new h.Aj(e,y.J.OBJECT)),this.suggestion.mattertagId&&this.commandBinder.issueCommand(new w.T3(this.suggestion.mattertagId,"search_menu_object_tag")),this.trackEvent("object_tags_delete_click")},this.id=this.suggestion.id,this.title=this.suggestion.displayLabel,this.description=this.suggestion.displayCategory,this.icon="icon-simple-tag",this.color=this.suggestion.color,this.enabled=this.suggestion.visible,this.floorId=this.suggestion.floorId,this.actions=this.isEditable?[{icon:this.suggestion.visible?"eye-show":"eye-hide",labelPhrasekey:"",tooltipPhrasekey:"",handler:this.onToggleVisible}]:void 0,this.menuActions=this.isEditable?[[A.SEARCH_ITEM_EDIT,this.onEditClick],[A.SEARCH_ITEM_DELETE,this.onDeleteClick]]:void 0,this.onSelect=()=>{super.onSelect(),this.commandBinder.issueCommand(new h.yL),this.suggestion.visible&&this.commandBinder.issueCommand(new v.w$(this.suggestion.id))},this.updateVisibility(),this.updateLabels(),this.init(i)}async init(e){this.analytics=await e.getModuleBySymbol(D.y.ANALYTICS)}registerBindings(){var e;this.bindings.push(this.suggestion.onPropertyChanged("status",this.updateVisibility)),this.mattertag&&this.bindings.push(null===(e=this.mattertag)||void 0===e?void 0:e.onChanged(this.onMattertagChange))}trackEvent(e){this.analytics&&this.analytics.track("showcase_gui",{tool:"object_tags",gui_action:e})}}var S=t(9986),E=t(36032),I=t(30581);const{OBJECT_TAG_SUGGESTION:M}=k.Z.WORKSHOP,N="MP_OBJECT_SEARCH_GROUP";var V=t(57331),O=t(66225),B=t(98254),j=t(91988);class ObjectTagSuggestion extends B.T{constructor(e){super(),this.sweeps=[],this.position=new d.Vector3,this.stemDirection=new d.Vector3,this.stemLength=j.K,this.stemEnabled=!1,this.status=s.UNREVIEWED,this.enabled=!0,e&&(Object.assign(this,e),this.keywords=e.keywords||[])}get displayLabel(){return this.localizedName?this.localizedName:this.label}get displayCategory(){return this.localizedCategory?this.localizedCategory:""}get visible(){return this.status!==s.REJECTED&&this.status!==s.DISMISSED}set visible(e){this.status=e?s.ACCEPTED:s.REJECTED,this.commit()}getMattertagOptions(){return{color:new d.Color(this.color),description:this.localizedCategory,enabled:!0,floorId:this.floorId,label:this.localizedName,normal:this.stemDirection.clone(),objectAnnotationId:this.id,position:this.position.clone(),stemHeight:this.stemLength,stemVisible:!0,keywords:this.keywords.slice()}}}var R=t(63336),F=t(63387),x=t(5477);class MdsObjectTagSuggestionDeserializer{constructor(e){this.locale=e,this.log=new x.Z("Object-tag-deserializer")}deserialize(e){var i;if(!e||!this.validate(e))return null;const t=e.region,n=t.anchorPosition?F.ep.fromVisionVector(t.anchorPosition):void 0,s=t.stemNormal?F.ep.fromVisionVector(t.stemNormal):void 0,a=new ObjectTagSuggestion;return a.id=e.id,a.label=e.label,a.confidence=e.confidence,a.created=(0,R.p)(e.created),a.modified=(0,R.p)(e.modified),a.enabled=e.enabled,e.region.stemLength&&(a.stemLength=e.region.stemLength),a.sweeps=[],e.panos&&e.panos.forEach((e=>{e&&e.id&&a.sweeps.push(e.id)})),e.status&&(a.status=e.status),e.floor&&e.floor.id&&(a.floorId=e.floor.id),e.room&&e.room.id&&(a.roomId=e.room.id),n&&(a.position=n),s&&(a.stemDirection=s),a.mattertagId=null===(i=e.tag)||void 0===i?void 0:i.id,a.keywords=e.keywords||[],this.postProcess(a),a}validate(e){if(!e)return!1;const i=["id","label","created","modified","region"];for(const t of i){if(!(t in e))return this.log.error("Missing field: ",t),!1}return!0}postProcess(e){const[i,t]=e.label.split(".").slice(1),n="WORKSHOP.OBJECT_TAG_SUGGESTION.VISION.";i&&(e.localizedCategory=this.locale.t(n+i.toUpperCase())),t&&(e.localizedName=this.locale.t(n+t.toUpperCase())),e.color=this.getCategoryColor(i)}getCategoryColor(e){switch(e){case"appliances":return"#f54338";case"consumer_electronics":return"#53a56c";case"fixtures":return"#06a9f7";default:return"#cccccc"}}}class MdsObjectTagStore extends O.u{constructor(e,i,t,n){super(e),this.modelId=t,this.classifications=[],this.confidence=n||.9,this.deserializer=new MdsObjectTagSuggestionDeserializer(i)}async read(e){const i={modelId:this.getViewId(),minConfidence:this.confidence};return this.query(V.GetObjectAnnotations,i,e).then((e=>{var i,t;const n=null===(t=null===(i=null==e?void 0:e.data)||void 0===i?void 0:i.model)||void 0===t?void 0:t.objectAnnotations;if(!n||!Array.isArray(n))return[];const s=[];return n.map((e=>{const i=this.deserializer.deserialize(e);i&&s.push(i)})),s}))}async getClassifications(){const e={modelId:this.modelId};return this.query(V.GetObjectClassifications,e).then((e=>{var i,t;const n=null===(t=null===(i=null==e?void 0:e.data)||void 0===i?void 0:i.model)||void 0===t?void 0:t.objectClassifications;return n&&Array.isArray(n)?n:[]}))}async accept(...e){const i={modelId:this.modelId,objectAnnotationIds:e};return this.query(V.AcceptObjectAnnotations,i).then((e=>{var i,t;const n=null===(t=null===(i=null==e?void 0:e.data)||void 0===i?void 0:i.model)||void 0===t?void 0:t.objectAnnotations;if(!n||!Array.isArray(n))return[];const s=[];return n.map((e=>{const i=this.deserializer.deserialize(e);i&&s.push(i.id)})),s}))}async reject(...e){const i={modelId:this.modelId,objectAnnotationIds:e};return this.query(V.RejectObjectAnnotations,i).then((e=>{var i,t;const n=null===(t=null===(i=null==e?void 0:e.data)||void 0===i?void 0:i.model)||void 0===t?void 0:t.objectAnnotations;if(!n||!Array.isArray(n))return[];const s=[];return n.map((e=>{const i=this.deserializer.deserialize(e);i&&s.push(i.id)})),s}))}async dismiss(...e){const i={modelId:this.modelId,objectAnnotationIds:e};return this.query(V.DismissObjectAnnotations,i).then((e=>{var i,t;const n=null===(t=null===(i=null==e?void 0:e.data)||void 0===i?void 0:i.model)||void 0===t?void 0:t.objectAnnotations;if(!n||!Array.isArray(n))return[];const s=[];return n.map((e=>{const i=this.deserializer.deserialize(e);i&&s.push(i.id)})),s}))}async createObjectTag(e,i){const t={label:e.label,keywords:e.keywords||[],floorId:e.floorId,enabled:!0,vectorRegion:{anchorPosition:F.ep.toVisionVector(e.position),stemNormal:F.ep.toVisionVector(e.stemDirection),stemLength:e.stemLength}},n={modelId:this.modelId,objectAnnotation:t};return this.query(V.AddObjectAnnotation,n).then((e=>{var i;const t=null===(i=null==e?void 0:e.data)||void 0===i?void 0:i.addObjectAnnotation;if(t)return t}))}async toggleEnabled(e,...i){return e?this.accept(...i):this.reject(...i)}}var H=t(89034),_=t(27832),L=t(74186),G=t(61709);class ObjectTagSuggestionsDataModule extends o.Y{constructor(){super(...arguments),this.name="object-tag-suggestions-data",this.onPinFocusChange=async()=>{const{commandBinder:e}=this.engine,{focusedPin:i,selectedPin:t}=this.pinsViewData,{billboardAnnotation:n,dockedAnnotation:s}=this.annotationsViewData;i?(t&&t.pinType===u.Er.OBJECT&&(e.issueCommand(new g.RH(t.id,t.pinType)),e.issueCommand(new f.IL(null))),i.pinType===u.Er.OBJECT&&i.id!==(null==s?void 0:s.id)&&e.issueCommand(new h.Kw(i.id,y.J.OBJECT))):n&&n.annotationType===y.J.OBJECT&&n.id!==(null==t?void 0:t.id)&&await e.issueCommand(new h.Aj(n.id,y.J.OBJECT))},this.createObjectTag=async e=>{const{id:i,options:t,pendingAttachments:n,embed:s}=e,a=new ObjectTagSuggestion;a.label=t.label||"",a.floorId=t.floorId||"",a.keywords=t.keywords||[],a.stemDirection=t.normal||new d.Vector3,a.stemLength=t.stemHeight?Math.max(t.stemHeight,j.K):j.K,a.position=t.position||new d.Vector3;const o=await this.data.create(a);o&&(t.objectAnnotationId=o.id,this.engine.commandBinder.issueCommand(new w.QG(i,t,n,void 0,s)))}}async init(e,i){let t;super.init(e,i),this.engine=i,[this.locale,this.pinsViewData,this.annotationsViewData,t]=await Promise.all([i.getModule(c.default),i.market.waitForData(p.B),i.market.waitForData(m.A),i.market.waitForData(G.n)]);const n=new MdsObjectTagStore({readonly:!1,baseUrl:e.baseUrl},this.locale,e.modelId,e.minConfidence),a=await n.read(),o=await n.getClassifications();this.data=new b.h(n),this.data.add(...a),this.data.classifications=o,this.engine.market.register(this,b.h,this.data),async function(e,i,t){const n=await e.market.waitForData(S.pu),a=await e.getModuleBySymbol(I.y.ANALYTICS);let o=n.application===S.Mx.WORKSHOP;const d=[],r=[],c=i=>{let n;return i.mattertagId&&(n=t.getTag(i.mattertagId)),new ObjectTagSuggestionSearchResultItem(e.commandBinder,e,i,N,o,n)},l=(n,a,l=[])=>{d.length=0,r.length=0;let h=!0,m=!0;const u=!!a||l.length>0;for(const e of i.suggestions){const i=!(o||e.visible&&u);if(e.status===s.DISMISSED||i)continue;const a=[e.displayLabel,e.displayCategory],g=[...e.keywords];if(e.mattertagId){const i=t.getTag(e.mattertagId);a.length=0,g.length=0,a.push(i.label,i.description),g.push(...i.keywords)}let p=n(...a.filter((e=>!!e)));p&&l.length>0&&(p=g.length>0&&g.some((e=>l.includes(e)))),p&&(e.visible?m=!1:h=!1,d.push(c(e)),r.push(e.id))}return e.commandBinder.issueCommand(new v.yJ(r)),o&&e.commandBinder.issueCommand(new f.Np(N,P(m,h))),p(d),d},m=(n,a,l)=>{d.length=0,r.length=0;let h=!0,m=!0;const u=!!a||l.length>0;for(const e of i.suggestions){const i=!(o||e.visible&&u);if(e.status===s.DISMISSED||i)continue;const a={name:e.localizedName,category:e.localizedCategory};if(e.mattertagId){const i=t.getTag(e.mattertagId);a.category=i.description,a.name=i.label}n(a)&&(e.visible?m=!1:h=!1,d.push(c(e)),r.push(e.id))}return e.commandBinder.issueCommand(new v.yJ(r)),o&&e.commandBinder.issueCommand(new f.Np(N,P(m,h))),p(d),d},p=e=>{e.sort(((e,i)=>{var t;const n=e,s=i,a=null===(t=n.description)||void 0===t?void 0:t.localeCompare(s.description);return 0!==a?a:n.title.localeCompare(s.title)}))},b=i=>{e.commandBinder.issueCommand(new g.qN(u.Er.OBJECT,i)),e.commandBinder.issueCommand(new h.yL),i||e.commandBinder.issueCommand(new v.xN)},y=()=>{e.commandBinder.issueCommand(new v.Bh(!0,...r)),e.commandBinder.issueCommand(new f.Np(N,P(!1,!0))),a.track("showcase_gui",{tool:"object_tags",gui_action:"show_all_click"})},T=()=>{e.commandBinder.issueCommand(new v.Bh(!1,...r)),e.commandBinder.issueCommand(new f.Np(N,P(!0,!1))),a.track("showcase_gui",{tool:"object_tags",gui_action:"hide_all_click"})},k=()=>{e.commandBinder.issueCommand(new v.AQ(...r)),a.track("showcase_gui",{tool:"object_tags",gui_action:"delete_all_click"})},w=()=>{let e=[];return i.suggestions.forEach((i=>{i.visible&&i.keywords.length&&(e=e.concat(i.keywords))})),e},P=(e,i)=>[[M.SEARCH_GROUP_HIDE_ALL,T,e],[M.SEARCH_GROUP_SHOW_ALL,y,i],[M.SEARCH_GROUP_DELETE_ALL,k]],C=()=>{e.commandBinder.issueCommandWhenBound(new f.c6({id:N,groupPhraseKey:"WORKSHOP.OBJECT_TAG_SUGGESTION.SEARCH_GROUP_HEADER",getSimpleMatches:l,getAdvancedMatches:m,registerChangeObserver:e=>i.onChanged(e),onActivatedChanged:b,getKeywords:w,groupMenuActions:o?P(!1,!0):void 0}))},D=()=>{e.commandBinder.issueCommandWhenBound(new f.Pe(N))},A={renew:C,cancel:D},V=e=>{o=e===S.Mx.WORKSHOP,D(),C()},O=n.onPropertyChanged("application",V);return V(n.application),new E.V(A,O)}(i,this.data,t).then((e=>this.bindings.push(e)));const{commandBinder:d}=this.engine;this.bindings.push(d.addBinding(v.yJ,(({ids:e})=>this.filterTagSuggestions(...e))),d.addBinding(v.w$,(async({id:e})=>this.navigateToSuggestion(e))),d.addBinding(v.xN,(async()=>this.closeSelectedSuggestion())),d.addBinding(v.Bh,(async({ids:e,enabled:i})=>this.setTagsEnabled(i,...e))),d.addBinding(v.AQ,(async({ids:e})=>this.dismissTags(...e))),d.addBinding(v.I2,(async e=>this.createObjectTag(e))),this.pinsViewData.onSelectedPinChanged((()=>this.onPinSelectionChange())),this.pinsViewData.onFocusedPinChanged((()=>this.onPinFocusChange())),this.data.onChanged((()=>this.createSuggestionsPins()))),this.maskTexture=(0,H.p)(L),this.backgroundTexture=(0,H.p)(_),this.createSuggestionsPins(),e.debug&&this.registerSettings()}dispose(e){super.dispose(e),this.data&&e.market.unregister(this,b.h)}onPinSelectionChange(){const{commandBinder:e}=this.engine,{selectedPin:i}=this.pinsViewData,{billboardAnnotation:t}=this.annotationsViewData,n=this.data.suggestions.find((e=>e.id===(null==i?void 0:i.id)));if(!n)return void(t&&t.annotationType===y.J.OBJECT&&this.engine.commandBinder.issueCommand(new h.Aj(t.id,y.J.OBJECT)));const s=new ObjectTagSuggestionSearchResultItem(e,this.engine,n,N,!1);e.issueCommand(new f.IL(s)),e.issueCommand(new h.Kw(n.id,y.J.OBJECT))}createSuggestionsPins(){const e=[];this.data.suggestions.forEach((i=>{e.push({id:i.id,stemEnabled:!0,anchorPosition:i.position.clone(),stemNormal:i.stemDirection.clone(),stemLength:j.K,color:i.color,floorId:i.floorId,roomId:i.roomId,pinType:u.Er.OBJECT,backgroundTexture:this.backgroundTexture,maskTexture:this.maskTexture,visible:i.visible,scale:new d.Vector3(.75,.75,.75)})})),this.engine.commandBinder.issueCommand(new g.mE(e)),this.engine.commandBinder.issueCommand(new g.qN(u.Er.OBJECT,!1))}async filterTagSuggestions(...e){const i=this.data.suggestions;for(const t of i){const i=e.includes(t.id)&&t.visible;this.engine.commandBinder.issueCommand(new g.ik(t.id,u.Er.OBJECT,i))}}async navigateToSuggestion(e){const i=this.data.suggestions.find((i=>i.id===e));if(!i)return;const t={anchorPosition:i.position.clone(),stemNormal:i.stemDirection.clone(),stemLength:i.stemLength,stemEnabled:!0,color:"",floorId:i.floorId,roomId:i.roomId};await this.engine.commandBinder.issueCommand(new l.OR({pinPosition:t,transition:r.n.FadeToBlack})),this.engine.commandBinder.issueCommand(new g.Ar(e,u.Er.OBJECT,!1))}async closeSelectedSuggestion(){const e=this.pinsViewData.selectedPin;e&&e.pinType===u.Er.OBJECT&&this.engine.commandBinder.issueCommand(new g.RH(e.id,u.Er.OBJECT))}async setTagsEnabled(e,...i){0===i.length&&(i=this.data.getObjectTagIds()),await this.data.setEnabled(e,...i);for(const t of this.data.suggestions)i.includes(t.id)&&(t.status=e?s.ACCEPTED:s.REJECTED,t.commit());this.engine.commandBinder.issueCommand(new f.s7)}async dismissTags(...e){0===e.length&&(e=this.data.getObjectTagIds()),await this.data.dismiss(...e);for(const i of this.data.suggestions)e.includes(i.id)&&(i.status=s.DISMISSED,i.commit(),this.engine.commandBinder.issueCommand(new g.OL(i.id,u.Er.OBJECT)));this.engine.commandBinder.issueCommand(new f.s7);const i=this.annotationsViewData.billboardAnnotation;(null==i?void 0:i.annotationType)===y.J.OBJECT&&this.engine.commandBinder.issueCommand(new h.Aj(i.id,i.annotationType))}async registerSettings(){(await this.engine.getModuleBySymbol(D.y.SETTINGS)).registerMenuButton({header:"Object Tag Suggestions",buttonName:"Undelete suggestions (needs reload)",callback:()=>{const e=this.data.suggestions.filter((e=>e.status===s.DISMISSED)),i=[];e.map((e=>i.push(e.id))),this.setTagsEnabled(!0,...i),this.data.commit()}})}}},33768:(e,i,t)=>{"use strict";t.d(i,{j:()=>PinAnchorMesh});var n=t(99295),s=t(89034),a=t(2212),o=t(30749),d=t(45877);class PinAnchorMesh extends a.Mesh{constructor(e){super(new a.PlaneBufferGeometry(d.Z.anchor.size,d.Z.anchor.size),new a.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,map:PinAnchorMesh.getTexture(),side:a.DoubleSide})),this.visible=!1,this.layers.mask=e.mask,this.renderOrder=n.z.pins}static getTexture(){return PinAnchorMesh.anchorTexture||(PinAnchorMesh.anchorTexture=(0,s.p)(o)),PinAnchorMesh.anchorTexture}}},98865:(e,i,t)=>{"use strict";t.r(i),t.d(i,{CancelNewPinCommand:()=>z.tT,ChangePinOpacityByTypeCommand:()=>z.kb,ChangePinOpacityCommand:()=>z._Y,ChangePinVisibilityByTypeCommand:()=>z.qN,ChangePinVisibilityCommand:()=>z.ik,ClickOffPinCommand:()=>z.yR,CreatePinCommand:()=>z.fM,EnablePinCreationCommand:()=>z.Ki,MovePinCommand:()=>z.I$,NewPinReadyMessage:()=>$.cd,PinAddCancelledMessage:()=>$.hu,PinAnchorMesh:()=>G.j,PinClickedMessage:()=>$.F7,PinColorVariant:()=>_.K_,PinEditor:()=>PinEditor,PinEditorState:()=>_.V8,PinHeadMesh:()=>L.$,PinHoverChangeMessage:()=>$.tP,PinMovedMessage:()=>$.bV,PinPlacedMessage:()=>$.b0,PinPlacementCancelledMessage:()=>$.pe,PinPreviewDirection:()=>_.Od,PinRenderer:()=>PinRenderer,PinSelectedMessage:()=>$.Q4,PinType:()=>_.Er,PinUnselectedMessage:()=>$.WM,PinsViewData:()=>P.B,PlacePinCommand:()=>z.ip,RemovePinCommand:()=>z.OL,RemovePinsByTypeCommand:()=>z.zM,SelectPinCommand:()=>z.Ar,UnselectPinCommand:()=>z.RH,UpdatePinCommand:()=>z.tE,UpdatePinViewsCommand:()=>z.mE,default:()=>me});var n=t(2212),s=t(57227),a=t(14877),o=t(7692),d=t(2252),r=t(9986),c=t(82722),l=t(56044),h=t(59057),m=t(15099),u=t(53549),g=t(37363),p=t(22878),v=t(55712),b=t(10830),y=t(42226),T=t(12757),k=t(50084),w=t(46978),P=t(40825),C=t(36032),f=t(92165),D=t(96765),A=t(75977),S=t(174),E=t(91825),I=t(5477),M=t(16493),N=t(43816),V=t(8054),O=t(70399),B=t(3035),j=t(76922),R=t(94267),F=t(94113),x=t(19926),H=t(43985),_=t(65143),L=t(13773),G=t(33768),U=t(45877),z=t(99380),$=t(57183),J=t(39823),K=t(28757),W=t(48730),q=t(55187);class PinEditor{constructor(e,i,t,s){this.viewData=e,this.engine=i,this.input=t,this.pinRenderer=s,this.editEnabled=!1,this.handlersRegistered=!1,this.bindings=[],this.externalBehaviorsBlocked=!1,this.touchDevice=(0,d.Jm)(),this.longPressCreateThreshold=500,this.ndcPoint=new n.Vector3,this.movingPin=!1,this.anchored=!1,this.inAnchorClick=!1,this.startingPinData=void 0,this.log=new I.Z("pin-editor"),this.stopEventPropagation=()=>!0,this.updateMeshPreviewSphere=async(e,i)=>{this.engine.commandBinder.issueCommand(new q.n(e,i))},this.startPinCreation=()=>{this.editEnabled&&(this.addingHandlers.renew(),this.touchDevice||this.engine.commandBinder.issueCommand(new b.u(y.C.XHAIR)),this.engine.commandBinder.issueCommand(new K.ZD))},this.endPinCreation=()=>{this.editEnabled&&(this.draggingHandlers.cancel(),this.addingHandlers.cancel(),this.clearLongPressTimeout(),this.allowExternalBehaviors(!0),this.engine.commandBinder.issueCommand(new b.u(y.C.DEFAULT)),this.engine.commandBinder.issueCommand(new K.zd))},this.onSelectedPinChanged=()=>{const{selectedPin:e}=this.viewData;e?this.selectedHandlers.renew():this.selectedHandlers.cancel(),this.updateAnchorMesh()},this.onPinStateUpdated=()=>{const e=this.viewData.pinEditorState;switch(this.updateAnchorMesh(),e){case _.V8.PLACING:this.draggingHandlers.renew();break;case _.V8.IDLE:this.allowExternalBehaviors(!0)}},this.updateAnchorMesh=()=>{if(!this.editEnabled)return;const{selectedPin:e,pinEditorState:i,isPinEditable:t}=this.viewData;e&&i!==_.V8.CREATING?([_.V8.PLACING,_.V8.PLACED].includes(i)||t?(this.pinRenderer.showAnchorMesh(e.pinType,e.id,e),this.anchored=!0):this.removePinAnchorMesh(),this.editableSelectedHandlers.renew()):(this.editableSelectedHandlers.cancel(),this.anchored&&(this.removePinAnchorMesh(),this.updateMeshPreviewSphere(!1)))},this.clearLongPressTimeout=()=>{this.longPressStart=0,-1!==this.longPressTimeout&&window.clearTimeout(this.longPressTimeout),this.longPressTimeout=-1},this.placePin=()=>{this.viewData.pinEditorState===_.V8.PLACING&&(this.engine.commandBinder.issueCommand(new b.u(y.C.DEFAULT)),this.engine.commandBinder.issueCommand(new z.ip),this.engine.broadcast(new $.cd),this.updateMeshPreviewSphere(!1))},this.onDragEvent=e=>{e.buttons!==V.r3.PRIMARY&&(this.touchDevice||this.viewData.selectedPin)||this.positionPin(e)},this.onDragEnd=e=>{const{selectedPin:i,creatingNewPin:t,pinEditorState:n}=this.viewData;t&&!this.touchDevice&&n===_.V8.PLACING||i&&!t&&(this.engine.commandBinder.issueCommand(new z.I$(i.id,this.copyPinData(i),this.startingPinData)),this.updateMeshPreviewSphere(!1))},this.positionPin=(()=>{const e=new n.Vector3;return async i=>{if(this.touchDevice&&i.buttons!==V.r3.PRIMARY)return!1;const t=this.viewData,n=t.pinEditorState;if(n===_.V8.CREATING)this.engine.commandBinder.issueCommand(new v.y(!0));else if(n!==_.V8.PLACING&&!this.movingPin)return!1;const s=t.selectedPin;if(!s)return!1;this.saveScreenPosition(i.position.x,i.position.y);const a=this.getModelIntersection();if(a&&a.face){this.engine.commandBinder.issueCommand(new b.u(y.C.XHAIR)),t.setCanPlace(!0);const i=(0,S.c)(this.floorsData,this.meshQuery,a);if(null===i)return!1;const o=this.meshQuery.mdsRoomIdFromObject(a.object);return e.copy(s.stemNormal).setLength(s.stemLength),this.updateMeshPreviewSphere(!0,s.anchorPosition),t.updateSelectedPin({anchorPosition:s.anchorPosition.copy(a.point),stemNormal:s.stemNormal.copy(a.face.normal).normalize(),floorId:i,roomId:o}),n===_.V8.CREATING&&t.setPinEditorState(_.V8.PLACING),!0}return this.engine.commandBinder.issueCommand(new b.u(y.C.NOPE)),t.setCanPlace(!1),!1}})(),this.allowExternalBehaviors=async e=>{e||this.externalBehaviorsBlocked?e&&this.externalBehaviorsBlocked&&(this.dragInterceptor.cancel(),this.engine.commandBinder.issueCommand(new W.Lp),this.externalBehaviorsBlocked=!1):(this.dragInterceptor.renew(),this.engine.commandBinder.issueCommand(new W.ZK),this.externalBehaviorsBlocked=!0)},this.getModelIntersection=()=>{const e=.5*U.Z.anchor.size;return this.fatcaster.cast(e,N.Nr,D.a.Filter.CENTER_GROUP(e))},this.onPointerButton=e=>{e.down||this.viewData.pinEditorState!==_.V8.PLACED||(this.allowExternalBehaviors(!0),this.engine.commandBinder.issueCommand(new v.y(!1)))},this.onAnchorSelect=e=>{const{selectedPin:i,isPinEditable:t,pinEditorState:n}=this.viewData;!i||e.button!==V.MP.PRIMARY||n!==_.V8.PLACED&&n!==_.V8.IDLE||(t?e.down?(this.movingPin=!0,this.startingPinData=this.copyPinData(i),this.allowExternalBehaviors(!1),this.draggingHandlers.renew(),this.engine.commandBinder.issueCommand(new b.u(y.C.GRABBING)),this.engine.commandBinder.issueCommand(new v.y(!0)),this.inAnchorClick=!0):(this.doneMovingPin(),this.inAnchorClick=!1):this.log.debug("onAnchorSelect called on a non-editable pin"))},this.doneMovingPin=()=>{this.viewData.selectedPin&&this.movingPin&&(this.draggingHandlers.cancel(),this.engine.commandBinder.issueCommand(new b.u(null)),this.engine.commandBinder.issueCommand(new v.y(!1)),this.movingPin=!1,this.startingPinData=void 0,this.allowExternalBehaviors(!0),this.updateMeshPreviewSphere(!1))},this.onClickElsewhere=e=>{const{selectedPin:i,pinEditorState:t}=this.viewData;if(!(t===_.V8.CREATING&&i||this.inAnchorClick))return i&&(this.movingPin?this.doneMovingPin():this.engine.commandBinder.issueCommand(new z.yR)),!0},this.onLongPressStart=async e=>{if(e.buttons!==V.r3.PRIMARY)return;const i=this.viewData;i.pinEditorState===_.V8.CREATING&&(this.longPressStart=Date.now(),i.setPinEditorState(_.V8.PRESSING),this.allowExternalBehaviors(!1),this.saveScreenPosition(e.position.x,e.position.y),this.longPressTimeout=window.setTimeout((async()=>{i.setPinEditorState(_.V8.PLACING);await this.positionPin(e)||(i.setPinEditorState(_.V8.CREATING),i.setCanPlace(!1)),this.longPressTimeout=-1}),this.longPressCreateThreshold))},this.onLongPressEnd=()=>{const e=this.viewData.pinEditorState;e===_.V8.PRESSING?(this.log.debug("Did not press long enough"),this.endPinCreation()):e===_.V8.PLACING&&this.placePin()},this.onPointerEvent=e=>{const i=this.viewData.pinEditorState;i!==_.V8.PLACING&&i!==_.V8.CREATING||this.positionPin(e)},this.onClickToPlacePin=()=>{this.placePin()},this.onKeyEvent=e=>{if(e.state===x.M.PRESSED)switch(e.key){case H.R.ESCAPE:this.viewData.creatingNewPin&&this.engine.broadcast(new $.pe)}},Promise.all([i.market.waitForData(m.M_),i.market.waitForData(J.i),i.getModule(f.default),i.getModuleBySymbol(a.y.MESH_QUERY)]).then((([i,n,s,a])=>{this.cameraData=i,this.floorsData=n,this.fatcaster=s,this.meshQuery=a,this.bindings.push(t.registerPriorityHandler(O.er,L.$,this.stopEventPropagation),e.onSelectedPinChanged(this.onSelectedPinChanged)),this.selectedHandlers=new C.V(t.registerPriorityHandler(B.R,A.S,this.onClickElsewhere),t.registerPriorityHandler(B.R,E.i,this.onClickElsewhere)),this.selectedHandlers.cancel()}))}dispose(){this.removePinAnchorMesh(),this.updateMeshPreviewSphere(!1),this.dragInterceptor.cancel(),this.addingHandlers.cancel(),this.draggingHandlers.cancel(),this.selectedHandlers.cancel(),this.editableSelectedHandlers.cancel(),this.bindings.forEach((e=>{e.cancel()}))}update(){if(!this.editEnabled)return;const e=this.viewData;if(this.touchDevice&&e.pinEditorState===_.V8.PRESSING){const i=Math.min(1,(Date.now()-this.longPressStart)/this.longPressCreateThreshold);e.setProgress(i)}}toggleEditing(e){e!==this.editEnabled&&(this.editEnabled=e,e?(this.handlersRegistered?this.creationHandlers.renew():this.registerHandlers(),this.updateAnchorMesh()):(this.inAnchorClick=!1,this.anchored=!1,this.movingPin=!1,this.creationHandlers.cancel(),this.allowExternalBehaviors(!0),this.removePinAnchorMesh(),this.updateMeshPreviewSphere(!1)),this.dragInterceptor.cancel(),this.draggingHandlers.cancel(),this.addingHandlers.cancel(),this.editableSelectedHandlers.cancel())}registerHandlers(){const e=this.input,i=this.viewData;this.creationHandlers=new C.V(i.onPinEditorStateChanged(this.onPinStateUpdated)),this.dragInterceptor=new C.V(e.registerPriorityHandler(j._t,A.S,(()=>!0)),e.registerPriorityHandler(j._t,E.i,(()=>!0))),this.draggingHandlers=new C.V(e.registerUnfilteredHandler(j._t,this.onDragEvent),e.registerUnfilteredHandler(j._R,this.onDragEnd)),this.editableSelectedHandlers=new C.V(e.registerMeshHandler(O.er,M.s.isType(G.j),this.onAnchorSelect)),this.touchDevice?this.addingHandlers=new C.V(e.registerHandler(O.er,this.onPointerButton),e.registerUnfilteredHandler(R.Vh,this.onLongPressStart),e.registerUnfilteredHandler(R.pt,this.onLongPressEnd)):this.addingHandlers=new C.V(e.registerHandler(F.e,this.onKeyEvent),e.registerHandler(O.er,this.onPointerButton),e.registerUnfilteredHandler(B.R,this.onClickToPlacePin),e.registerHandler(O.mE,this.onPointerEvent))}removePinAnchorMesh(){this.pinRenderer.hideAnchorMesh(),this.anchored=!1}copyPinData(e){return{anchorPosition:e.anchorPosition.clone(),stemNormal:e.stemNormal.clone(),floorId:e.floorId,roomId:e.roomId,stemLength:e.stemLength,stemEnabled:e.stemEnabled,color:e.color}}saveScreenPosition(e,i){this.ndcPoint.set(e,i,0);const t=(0,o.fi)(this.cameraData.width,this.cameraData.height,this.ndcPoint);this.viewData.setScreenPosition(t)}}var Z=t(95847),Y=t(98878),Q=t(54374),X=t(65270),ee=t(99295),ie=t(6244);class PinSelectedMesh extends n.Mesh{constructor(e){super(new n.PlaneBufferGeometry(U.Z.anchor.size,U.Z.anchor.size),new ie.Dx),this.visible=!1,this.layers.mask=e.mask,this.renderOrder=ee.z.pinSelectedHalo}}class PinRenderer{constructor(e,i,t,s){this.input=e,this.layer=i,this.commandBinder=t,this.raycaster=s,this.container=new n.Object3D,this.floorIdToContainer=new Map,this.hexColorToColor=new Map,this.bindings=[],this.anchor=null,this.selected=null,this.haloEasing=(0,X.tf)(.5,.52,0,1.98),this.pinsWithOverrideTexture=new Set,this.updateAnchorPosition=(()=>{const e=new n.Vector3,i=new n.Vector3,t=new n.Vector3;return n=>{const s=this.anchorMesh;if(!s)return;const a=this.raycaster.picking;e.copy(n.stemNormal).normalize(),i.copy(e).multiplyScalar(.2).add(n.anchorPosition),t.copy(e).multiplyScalar(-1);const o=a.pick(i,t,(e=>e instanceof Q.g));if(o){const e=Math.min(.2,o.distance);s.position.copy(i).add(t.multiplyScalar(.999*e))}else s.position.copy(i).add(t.multiplyScalar(.999*n.stemLength));s.lookAt(i)}})(),this.onAnchorHover=()=>{this.commandBinder.issueCommand(new b.u(y.C.GRAB)),this.commandBinder.issueCommand(new v.y(!0))},this.onAnchorUnhover=()=>{this.commandBinder.issueCommand(new b.u(null)),this.commandBinder.issueCommand(new v.y(!1))}}init(){this.container.name="PinContainer",this.container.layers.mask=this.layer.mask,this.anchorMesh=new G.j(this.layer),this.anchorMesh.name="Anchor Mesh",this.container.add(this.anchorMesh),this.selectedMesh=new PinSelectedMesh(this.layer),this.selectedMesh.name="Selected Mesh",this.container.add(this.selectedMesh)}dispose(){this.container.parent&&this.container.parent.remove(this.container);for(const e of[this.anchorMesh,this.selectedMesh])e&&e.parent&&e.parent.remove(e)}activate(e){this.bindings.length>0||this.bindings.push(this.input.registerMeshHandler(Z.z,M.s.isType(G.j),this.onAnchorHover),this.input.registerMeshHandler(Z.A,M.s.isType(G.j),this.onAnchorUnhover))}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0}render(e){if(!this.selected)return;const{animation:i,hideWhenDoneAnimating:t}=this.selected,s=this.selectedMesh;if(s&&s.visible&&i){const e=this.pinHeadTransform(this.selected.id),a=new n.Vector3,o=new n.Quaternion,d=new n.Vector3;e.decompose(a,o,d),d.multiplyScalar(i.getUpdatedValue()),t&&!i.isAnimating?(s.visible=!1,this.selected=null):(s.position.copy(a),s.quaternion.copy(o),s.scale.copy(d))}}updatePin(e,i,t,n,s,a){this.anchorMesh&&this.anchorMesh.visible&&this.anchor&&this.anchor.pinType===i&&this.anchor.id===e&&this.updateAnchorPosition(t)}removePin(e){this.selected&&this.selected.id===e&&this.clearSelected()}removePinsByType(e){this.removePinsByPredicate((i=>i===e))}removePinsByPredicate(e){}setPinVisible(e,i){}setPinColorVariant(e,i){}setPinColorVariants(e,i){}setPinColorVariantByType(e,i,t){}setPinOpacity(e,i){}setPinOpacityByType(e,i,t){}fadePinOpacity(e,i){}fadePinOpacityByType(e,i,t=[]){}setPinRenderOverrides(e,i,t){i?(this.pinsWithOverrideTexture.add(e),this.selected&&this.selected.id===e&&this.clearSelected()):this.pinsWithOverrideTexture.delete(e)}setFloorsHidden(e){this.floorIdToContainer.forEach(((i,t)=>{i.visible=!e(t)}))}setPinTypeVisible(e,i){this.floorIdToContainer.forEach((t=>{t.userData.typeContainers[e].visible=i}))}showAnchorMesh(e,i,t){this.anchor={pinType:e,id:i},this.anchorMesh&&!this.anchorMesh.visible&&(this.anchorMesh.visible=!0,this.input.registerMesh(this.anchorMesh,!1)),this.updateAnchorPosition(t)}hideAnchorMesh(){this.anchorMesh&&this.anchorMesh.visible&&(this.anchorMesh.visible=!1,this.input.unregisterMesh(this.anchorMesh))}showSelectedMesh(e,i){const t=this.selected&&this.selected.pinType===e&&this.selected.id===i;this.selected&&t||this.pinsWithOverrideTexture.has(i)||(this.selected={pinType:e,id:i,hideWhenDoneAnimating:!1,animation:new Y.Z({startValue:10,endValue:14,duration:300,easingFunction:this.haloEasing})},this.selectedMesh.visible=!0)}hideSelectedMesh(){this.selected&&(this.selected.animation=new Y.Z({startValue:14,endValue:10,duration:300}),this.selected.hideWhenDoneAnimating=!0)}getFloorContainer(e){let i=this.floorIdToContainer.get(e);if(i)return i;i=new n.Object3D,i.name="Floor "+e,i.userData.typeContainers={},i.layers.mask=this.layer.mask;for(const e of Object.values(_.Er)){const t=new n.Object3D;t.name=e,t.layers.mask=this.layer.mask,i.add(t),i.userData.typeContainers[e]=t}return this.container.add(i),this.floorIdToContainer.set(e,i),i.userData.floorId=e,i}getColor(e){let i=this.hexColorToColor.get(e);if(i)return i;const t=new n.Color(e),s={h:0,s:0,l:0};t.getHSL(s);return i={baseColor:t,hoverColor:(new n.Color).setHSL(s.h,s.s,.8*s.l),dimmedColor:(new n.Color).setHSL(s.h,.5*s.s,s.l)},this.hexColorToColor.set(e,i),i}getViewportScale(e){return Math.sqrt(Math.min(e.width,e.height)/U.Z.pinHeadMesh.scale.baseViewportSize)}clearSelected(){this.selectedMesh.visible=!1,this.selected=null}}class PinStemMesh extends n.Line{constructor(e,i,t,s,a){const o=new n.BufferGeometry,d=new Float32Array(6);d[0]=d[1]=d[2]=0,d[3]=e.x,d[4]=e.y,d[5]=e.z,o.setAttribute("position",new n.BufferAttribute(d,3));const r=new ie.l0;super(o,r),this.geometry=o,this.layers.mask=t.mask,this.visible=i,this.vector=e.clone(),this.onBeforeRender=(e,i,t,n,o)=>{const d=o;d.uniforms.pinHeadMatrix.value.copy(s.matrixWorld),d.uniforms.resolution.value.set(a.width,a.height),d.uniformsNeedUpdate=!0},this.pinStemMaterial=r}dispose(){this.geometry.dispose()}updatePosition(e){this.vector.copy(e.stemNormal).setLength(Math.max(e.stemLength,.01));const i=this.geometry.getAttribute("position");i.setXYZ(1,this.vector.x,this.vector.y,this.vector.z),i.needsUpdate=!0}}function te(e,i){switch(i){case _.K_.DEFAULT:return e.baseColor;case _.K_.DIMMED:return e.dimmedColor;case _.K_.HIGHLIGHTED:return e.hoverColor}}var ne=t(41252);class PinMeshGroup extends n.Object3D{constructor(e,i,t,s,a,o,d,r){super(),this.pinId=e,this.pinType=i,this.pinColor=s,this.stemVector=new n.Vector3,this.stemEnabled=!0,this.currentColorVariant=_.K_.DEFAULT,this.baseOpacity=1,PinMeshGroup.pinHeadGeometry||(PinMeshGroup.pinHeadGeometry=new n.PlaneBufferGeometry(U.l,U.l));const c=(new n.Color).copy(s.baseColor);this.pinHeadMeshMaterial=new ie.Nv(c,d,r,1),this.pinHeadMesh=new L.$(e,PinMeshGroup.pinHeadGeometry,this.pinHeadMeshMaterial,a),this.add(this.pinHeadMesh),this.stemMesh=new PinStemMesh(t.stemNormal,t.stemEnabled,a,this.pinHeadMesh,o),this.add(this.stemMesh),this.updateMeshPosition(t),this.opacityAnimation=new ne.z(1)}dispose(){this.remove(this.pinHeadMesh),this.pinHeadMesh.material.dispose(),this.pinHeadMesh.dispose(),this.remove(this.stemMesh),this.stemMesh.dispose()}static disposeAll(){PinMeshGroup.pinHeadGeometry.dispose()}updateFromPin(e,i,t,n){this.position.copy(e.anchorPosition),this.pinHeadMesh.updatePosition(e),this.stemVector.copy(e.stemNormal).setLength(e.stemLength),this.stemEnabled=e.stemEnabled,this.stemMesh.updatePosition(e),this.stemMesh.visible=e.stemEnabled,i!==this.pinColor&&(this.pinColor=i,this.setColorVariant(this.currentColorVariant));const s=this.pinHeadMeshMaterial.uniforms;s.bg.value===t&&s.mask.value===n||(s.bg.value=t,s.mask.value=n,this.pinHeadMeshMaterial.uniformsNeedUpdate=!0)}setColorVariant(e){const i=te(this.pinColor,e);this.pinHeadMeshMaterial.uniforms.color.value.copy(i),this.currentColorVariant=e}setOpacity(e){this.baseOpacity=e,this.updateOpacity()}fadeOpacity(e){e>0&&(this.visible=!0),this.opacityAnimation.modifyAnimation(this.opacityAnimation.value,e,300).onComplete((()=>{e<=0&&(this.visible=!1)}))}setVisibility(e,i){this.visible=e,this.pinHeadMesh.visible=e,this.stemMesh.visible=e&&i}setStemEnabled(e){this.stemMesh.visible=this.visible&&e}updateMeshPosition(e){this.position.copy(e.anchorPosition),this.pinHeadMesh.updatePosition(e),this.stemMesh.updatePosition(e)}update(e,i,t,n){this.pinHeadMesh.update(i,t,n);const s=this.opacityAnimation.active;this.opacityAnimation.tick(e),s&&this.updateOpacity()}setRenderOverrides(e,i){this.pinHeadMesh.material=e?new ie.m0(e,!1):this.pinHeadMeshMaterial,i?this.pinHeadMesh.geomScale.copy(i):this.pinHeadMesh.geomScale.set(1,1,1),this.setOpacity(this.pinHeadMeshMaterial.opacity)}updateOpacity(){const e=this.opacityAnimation.value*this.baseOpacity;if(this.pinHeadMeshMaterial.opacity=e,this.pinHeadMeshMaterial.uniforms.alpha.value=e,this.pinHeadMesh.material!==this.pinHeadMeshMaterial){this.pinHeadMesh.material.opacity=e;const i=this.pinHeadMesh.material;i&&i.uniforms&&i.uniforms.alpha&&(i.uniforms.alpha.value=e)}this.stemMesh.pinStemMaterial.uniforms.alpha.value=e}}class NonInstancedPinRenderer extends PinRenderer{constructor(e,i,t,n,s,a,o){super(e,n,s,a),this.camera=i,this.canvasData=t,this.idToMesh=new Map,this.inputCallbacks=o}dispose(){super.dispose(),this.removePinsByPredicate((()=>!0)),PinMeshGroup.disposeAll()}activate(e){this.bindings.length>0||(super.activate(e),this.bindings.push(this.input.registerPriorityHandler(B.R,L.$,((e,i)=>{const t=i.parent;return this.inputCallbacks.onClick(t.pinId,t.pinType),!0}))),(0,d.Jm)()||(this.bindings.push(this.input.registerMeshHandler(Z.z,M.s.isType(L.$),((e,i)=>{const t=i.parent;this.inputCallbacks.onHover(t.pinId,t.pinType)}))),this.bindings.push(this.input.registerMeshHandler(Z.A,M.s.isType(L.$),((e,i)=>{const t=i.parent;this.inputCallbacks.onUnhover(t.pinId,t.pinType)})))))}render(e){const i=this.getViewportScale(this.canvasData);this.idToMesh.forEach((t=>{t.update(e,this.camera,i,this.canvasData)})),super.render(e)}updatePin(e,i,t,n,s,a){var o,d;super.updatePin(e,i,t,n,s,a);const r=this.getColor(t.color);let c=this.idToMesh.get(e);c||(c=new PinMeshGroup(e,i,t,r,this.layer,this.canvasData,n,s),this.idToMesh.set(e,c),this.input.registerMesh(c.pinHeadMesh,!1)),void 0!==a&&(c.visible=a),c.updateFromPin(t,r,n,s);const l=t.floorId;c.parent&&(null===(o=c.parent)||void 0===o?void 0:o.userData.floorId)===l||(c.parent&&(null===(d=c.parent)||void 0===d||d.remove(c)),this.getFloorContainer(l).userData.typeContainers[i].add(c))}removePin(e){var i;super.removePin(e);const t=this.idToMesh.get(e);t&&(this.idToMesh.delete(e),null===(i=t.parent)||void 0===i||i.remove(t),this.input.unregisterMesh(t.pinHeadMesh),t.dispose())}removePinsByPredicate(e){this.idToMesh.forEach(((i,t)=>{e(i.pinType)&&this.removePin(t)}))}setPinVisible(e,i){const t=this.idToMesh.get(e);t&&(t.visible=i)}setPinColorVariant(e,i){const t=this.idToMesh.get(e);t&&t.setColorVariant(i)}setPinColorVariants(e,i){this.idToMesh.forEach((t=>{t.pinId!==i&&t.setColorVariant(e)}))}setPinColorVariantByType(e,i,t){this.idToMesh.forEach((n=>{n.pinType===e&&n.pinId!==t&&n.setColorVariant(i)}))}setPinOpacity(e,i){const t=this.idToMesh.get(e);t&&t.setOpacity(i)}fadePinOpacity(e,i){const t=this.idToMesh.get(e);t&&t.fadeOpacity(i)}setPinOpacityByType(e,i,t){this.idToMesh.forEach((n=>{n.pinType===e&&n.pinId!==t&&n.setOpacity(i)}))}fadePinOpacityByType(e,i,t=[]){this.idToMesh.forEach((n=>{n.pinType!==e||t.includes(n.pinId)||n.fadeOpacity(i)}))}setPinRenderOverrides(e,i,t){super.setPinRenderOverrides(e,i,t);const n=this.idToMesh.get(e);n&&n.setRenderOverrides(i,t)}pinHeadTransform(e){const i=this.idToMesh.get(e);return i?i.pinHeadMesh.matrixWorld:new n.Matrix4}}var se=t(78261),ae=t(74170),oe=t(85111),de=t(77280),re=t(15019);const ce=new ie.uW,le=new I.Z("InstancedPinHeads");class InstancedPinLines extends n.InstancedMesh{constructor(e){const i=new n.BufferGeometry,t=new Float32Array(6);t[0]=t[1]=t[2]=0,t[3]=1,t[4]=1,t[5]=1,i.setAttribute("position",new n.BufferAttribute(t,3));const s=new Float32Array(3*e),a=new n.InstancedBufferAttribute(s,3);i.setAttribute("stemVector",a);const o=new Float32Array(e),d=new n.InstancedBufferAttribute(o,1);i.setAttribute("instanceAlpha",d);const r=[],c=[];for(let t=0;t<4;t++){const s=new Float32Array(4*e),a=new n.InstancedBufferAttribute(s,4);i.setAttribute(`pinHeadMatrixCol${t}`,a),r.push(s),c.push(a)}super(i,ce,e),this.maxCount=e,this.stemVectorArray=s,this.stemVectorAttrib=a,this.pinHeadMatrixArray=r,this.pinHeadMatrixAttrib=c,this.opacityArray=o,this.opacityAttrib=d,this.renderOrder=ee.z.lines,this.posMatrix=new n.Matrix4,this.isLine=!0,this.isMesh=!1}update(e,i){let t=0;for(const i of e){if(!i.visible||!i.stemEnabled||i.stemLength<.001)continue;if(t>=this.maxCount){le.error("Instance count is too small!");continue}this.posMatrix.setPosition(i.anchorPosition),this.setMatrixAt(t,this.posMatrix),this.opacityArray[t]=i.opacity*i.opacityAnimation.value;const e=3*t;i.pinHeadObjPosition.toArray(this.stemVectorArray,e);let n=0;for(let e=0;e<4;e++)for(let s=0;s<4;s++)this.pinHeadMatrixArray[e][s+4*t]=i.pinHeadMatrix.elements[n++];t++}this.count=t,this.visible=this.count>0,this.instanceMatrix.needsUpdate=!0,this.stemVectorAttrib.needsUpdate=!0;for(const e of this.pinHeadMatrixAttrib)e.needsUpdate=!0;this.opacityAttrib.needsUpdate=!0,ce.uniforms.resolution.value.set(i.width,i.height),ce.uniformsNeedUpdate=!0}}const he=new I.Z("InstancedPinRenderer");class InstancedPinRenderer extends PinRenderer{constructor(e,i,t,s,a,o,d){super(e,s,a,o),this.camera=i,this.canvasData=t,this.pins=new Map,this.idToPin=new Map,this.keyToRenderObjs=new Map,this.updatePinHeadMatrix=(()=>{const e=new n.Vector3,i=new n.Vector3,t=new n.Vector3,s=new n.Vector3,a=new n.Vector3,o=new n.Vector3,d=new n.Vector3;return n=>{const r=U.Z.pinHeadMesh.scale,c=this.getViewportScale(this.canvasData),l=1+r.responsiveness/100*(c-1);this.camera.getWorldPosition(o);const h=this.camera.quaternion,m=this.canvasData;for(const c of n){d.copy(c.pinHeadObjPosition).add(c.anchorPosition);const n=o.distanceTo(d),u=r.maxSize-(r.maxSize-r.minSize)*(0,se.C)(n,r.nearBound,r.farBound);i.copy(d).project(this.camera),t.set(m.width/2,m.height/2,1).multiply(i),s.set(u/2,0,0).add(t),a.set(2/m.width,2/m.height,1).multiply(s);const g=a.unproject(this.camera).distanceTo(d)*l,p=(0,ae.uZ)(g,oe.Z.epsilon,g),v=c.geomScale||de.f.UNIT;e.set(p*v.x,p*v.y,p*v.z),c.pinHeadMatrix.compose(d,h,e)}}})(),this.inputCallbacks=d}dispose(){super.dispose()}activate(e){this.bindings.length>0||(super.activate(e),this.bindings.push(this.input.registerPriorityHandler(B.R,re.z,((e,i,t)=>{if(!t||void 0===t.instanceId)return!0;const n=i.renderedPins[t.instanceId];return this.inputCallbacks.onClick(n.id,n.pinType),!0}))),(0,d.Jm)()||(this.bindings.push(this.input.registerMeshHandler(Z.z,M.s.isType(re.z),((e,i,t)=>{if(!t||void 0===t.instanceId)return;const n=i.renderedPins[t.instanceId];this.lastHoverId=n.id,this.lastHoverType=n.pinType,this.inputCallbacks.onHover(n.id,n.pinType)}))),this.bindings.push(this.input.registerMeshHandler(Z.A,M.s.isType(re.z),(()=>{this.inputCallbacks.onUnhover(this.lastHoverId,this.lastHoverType)})))))}render(e){for(const i of this.pins.values()){const t=Array.from(i.values());if(0===t.length)continue;const n=this.keyFromPin(t[0]),s=this.keyToRenderObjs.get(n);if(!s){he.error("Expecting renderObjs for this key.",this.keyToRenderObjs,this.keyFromPin(t[0]));continue}let{lines:a,pinHeads:o}=s;if(t.forEach((i=>i.opacityAnimation.tick(e))),this.updatePinHeadMatrix(t),a.maxCount<t.length){const e=a.parent;if(!e){he.error("Expecting a parent.");continue}e.remove(a),a.dispose(),e.remove(o),this.input.unregisterMesh(o);const{backgroundTexture:i,maskTexture:n,overrideTexture:d}=t[0];o.dispose(),Object.assign(s,this.createInstances(e,s.id,t.length+16,i,n,d)),a=s.lines,o=s.pinHeads}a.update(t,this.canvasData),o.update(t)}super.render(e)}updatePin(e,i,t,s,a,o){var d;super.updatePin(e,i,t,s,a,o);let r=this.idToPin.get(e);const c=t.floorId,l=this.getColor(t.color).baseColor,h=`${c}_${i}_${(null===(d=null==r?void 0:r.overrideTexture)||void 0===d?void 0:d.uuid)||s.uuid}`;if(!r){r=Object.assign(Object.assign({id:e},t),{visible:!0,opacity:1,pinType:i,opacityAnimation:new ne.z(1),backgroundTexture:s,maskTexture:a,pinHeadMatrix:new n.Matrix4,pinHeadObjPosition:new n.Vector3,pinColor:l,colorVariant:_.K_.DEFAULT,overrideTexture:null,geomScale:null}),this.idToPin.set(e,r);let o=this.pins.get(h);o||(o=new Map,this.pins.set(h,o)),o.set(e,r),this.createRenderObjsForPin(r)}const m=this.keyFromPin(r);Object.assign(r,t,{pinType:i,textureId:s.uuid}),this.changePinHeadGroupIfNeeded(m,h,r),r.pinHeadObjPosition.copy(r.stemNormal).setLength(r.stemLength),r.pinColor=te(this.getColor(r.color),r.colorVariant),void 0!==o&&this.setPinVisible(e,o)}removePin(e){super.removePin(e);const i=this.idToPin.get(e);if(!i)return;this.idToPin.delete(e);const t=this.keyFromPin(i),n=this.pins.get(t);n&&(n.delete(e),this.cleanupRenderObjIfNeeded(t))}removePinsByPredicate(e){this.idToPin.forEach(((i,t)=>{e(i.pinType)&&this.removePin(t)}))}setPinVisible(e,i){const t=this.idToPin.get(e);t?t.visible=i:he.error("setPinVisible on a pin that doesn't exist.",e)}setPinColorVariant(e,i){const t=this.idToPin.get(e);t?(t.colorVariant=i,t.pinColor=te(this.getColor(t.color),i)):he.error("setPinColorVariant on a pin that doesn't exist.")}setPinColorVariants(e,i){this.idToPin.forEach(((t,n)=>{n!==i&&this.setPinColorVariant(n,e)}))}setPinColorVariantByType(e,i,t){this.idToPin.forEach(((n,s)=>{n.pinType===e&&s!==t&&this.setPinColorVariant(s,i)}))}setPinOpacity(e,i){const t=this.idToPin.get(e);t?t.opacity=i:he.error("setPinOpacity on a pin that doesn't exist.")}fadePinOpacity(e,i){const t=this.idToPin.get(e);t?(i>0&&this.setPinVisible(e,!0),t.opacityAnimation.modifyAnimation(t.opacityAnimation.value,i,300).onComplete((()=>{i<=0&&this.setPinVisible(e,!1)}))):he.error("setPinVisible on a pin that doesn't exist.",e)}setPinOpacityByType(e,i,t){this.idToPin.forEach(((n,s)=>{n.pinType===e&&s!==t&&this.setPinOpacity(s,i)}))}fadePinOpacityByType(e,i,t=[]){this.idToPin.forEach(((n,s)=>{n.pinType!==e||t.includes(s)||this.fadePinOpacity(s,i)}))}setPinRenderOverrides(e,i,t){super.setPinRenderOverrides(e,i,t);const n=this.idToPin.get(e);if(!n)return void he.error("setPinRenderOverrides on a pin that doesn't exist.");const s=this.keyFromPin(n);if(!this.keyToRenderObjs.get(s))return void he.error("Expecting renderObjs while setting override material");n.overrideTexture=i,n.geomScale=t;const a=this.keyFromPin(n);this.changePinHeadGroupIfNeeded(s,a,n)}pinHeadTransform(e){const i=this.idToPin.get(e);return i?i.pinHeadMatrix:(he.error("pinHeadTransform on a pin that doesn't exist."),new n.Matrix4)}keyFromPin(e){return`${e.floorId}_${e.pinType}_${e.overrideTexture?e.overrideTexture.uuid:e.backgroundTexture.uuid}`}createRenderObjsForPin(e){const{backgroundTexture:i,maskTexture:t,overrideTexture:n}=e,s=this.keyFromPin(e);if(this.keyToRenderObjs.get(s))return;const a=this.getFloorContainer(e.floorId).userData.typeContainers[e.pinType];a.userData||(a.userData={});const o=e.overrideTexture?e.overrideTexture.uuid:e.backgroundTexture.uuid;if(!a.userData[o]){const e=this.createInstances(a,o,16,i,t,n);a.userData[o]=e,this.keyToRenderObjs.set(s,e)}}createInstances(e,i,t,n,s,a){const o=new InstancedPinLines(t);o.layers.mask=this.layer.mask,e.add(o);const d=new re.z(t,a||n,a?null:s,!a);return d.layers.mask=this.layer.mask,e.add(d),this.input.registerMesh(d,!1),{lines:o,pinHeads:d,id:i}}changePinHeadGroupIfNeeded(e,i,t){if(e!==i){let n=this.pins.get(i);n||(n=new Map,this.pins.set(i,n)),n.set(t.id,t),this.createRenderObjsForPin(t);const s=this.pins.get(e);s&&(null==s||s.delete(t.id),this.cleanupRenderObjIfNeeded(e))}}cleanupRenderObjIfNeeded(e){const i=this.pins.get(e),t=this.keyToRenderObjs.get(e);if(i&&0===i.size&&t){const i=t.lines.parent;if(this.input.unregisterMesh(t.pinHeads),this.pins.delete(e),this.keyToRenderObjs.delete(e),!i)return void he.error("Expecting pinTypeObj!");i.userData[t.id]=void 0,i.remove(t.lines),i.remove(t.pinHeads)}}}class PinsModule extends s.Y{constructor(){super(...arguments),this.name="pins",this.editActivated=!1,this.editBindings=[],this.touchDevice=(0,d.Jm)(),this.worldPosition=new n.Vector3,this.visibilityChanged=()=>{const e=!this.in360View(),i=!this.interactionmodeData.isVR();this.pinRenderer.container.visible=e&&i;const{floorsViewData:t}=this,n=this.viewmode===p.Ey.Dollhouse||this.viewmode===p.Ey.Floorplan,s=t.transition.progress.active?()=>!0:t.isHidden;this.pinRenderer.setFloorsHidden(n?s:()=>!1)},this.viewmodeChanged=e=>{this.viewmode=e.toMode,this.visibilityChanged()},this.onEnablePinEditing=async e=>{e.enabled?this.enableEditing():this.disableEditing()},this.updateCurrentPin=()=>{const{pinEditorState:e,selectedPin:i,focusedPin:t}=this.viewData;if(e!==_.V8.CREATING){const e=t||i;if(this.pinEditor.updateAnchorMesh(),e){const{id:i,pinType:t,backgroundTexture:n,maskTexture:s}=e;this.pinRenderer.updatePin(i,t,e,n,s),this.pinRenderer.setPinColorVariant(i,_.K_.HIGHLIGHTED),this.pinRenderer.setPinColorVariants(_.K_.DEFAULT,i)}else this.pinRenderer.setPinColorVariants(_.K_.DEFAULT)}},this.onUpdatePin=async e=>{const{id:i,pinType:t,properties:n}=e,s=this.viewData.getPin(i);if(s&&s.pinType===t){const{selectedPin:e,focusedPin:t}=this.viewData,a=Object.assign(Object.assign({},s),n);this.viewData.updatePin(a),this.pinRenderer.updatePin(a.id,a.pinType,a,a.backgroundTexture,a.maskTexture),(null==e?void 0:e.id)===i&&(this.saveScreenPosition(a),this.viewData.updateSelectedPin(a)),(null==t?void 0:t.id)===i&&this.saveScreenPosition(a)}else this.log.debug(`Cannot update non-existent ${t} pin`)},this.onUpdatePinViews=async e=>{const{pinViews:i}=e,{selectedPin:t}=this.viewData;i.forEach((e=>{this.viewData.updatePin(e),this.pinRenderer.updatePin(e.id,e.pinType,e,e.backgroundTexture,e.maskTexture,e.visible),(null==t?void 0:t.id)===e.id&&this.viewData.updateSelectedPin(e),void 0!==e.opacity&&this.pinRenderer.setPinOpacity(e.id,e.opacity),void 0!==e.scale&&this.pinRenderer.setPinRenderOverrides(e.id,null,e.scale)}))},this.onChangePinVisibility=async e=>{const{id:i,pinType:t,visible:n}=e,s=this.viewData.getPin(i);if(s&&s.pinType===t){this.pinRenderer.setPinVisible(i,n);const{selectedPin:e,focusedPin:t}=this.viewData;n||(null==e?void 0:e.id)!==i||this.changeSelectedPin(null),n||(null==t?void 0:t.id)!==i||this.viewData.setFocusedPin(null)}else this.log.debug(`Cannot change visibility of non-existent ${t} pin`)},this.onChangePinVisibilityByType=async e=>{const{pinType:i,visible:t}=e;this.pinRenderer.setPinTypeVisible(i,t)},this.onChangePinOpacity=async e=>{const{id:i,pinType:t,opacity:n}=e,s=this.viewData.getPin(i);s&&s.pinType===t?this.pinRenderer.setPinOpacity(i,n):this.log.debug(`Cannot change opacity of non-existent ${t} pin`)},this.onChangePinOpacityByType=async e=>{const{pinType:i,opacity:t,skipIds:n}=e;this.pinRenderer.fadePinOpacityByType(i,t,n)},this.onUnselectPin=async e=>{const{pinType:i,id:t}=e,{selectedPin:n}=this.viewData;(null==n?void 0:n.pinType)===i&&(null==n?void 0:n.id)===t&&this.changeSelectedPin(null)},this.onStartPinCreation=async e=>{const{id:i,pin:t,pinType:n,backgroundTexture:s,maskTexture:a}=e,o=this.viewData,d=Object.assign(Object.assign({id:i,pinType:n},t),{backgroundTexture:s,maskTexture:a});o.setEditablePin(!0),o.setPinEditorState(_.V8.CREATING),this.changeSelectedPin(d),this.pinEditor.startPinCreation()},this.saveScreenPosition=(()=>{const e=new n.Vector3;return i=>{const t=this.viewData;e.copy(i.stemNormal).setLength(i.stemLength),this.worldPosition.copy(i.anchorPosition).add(e);const n=(0,o.q9)(this.cameraData,this.worldPosition);t.setScreenPosition(n.ndcPosition.z>1?null:n.screenPosition)}})(),this.onCameraUpdate=()=>{const{creatingNewPin:e,focusedPin:i,selectedPin:t}=this.viewData;!e&&i?this.saveScreenPosition(i):t&&this.saveScreenPosition(t)},this.handleSweepChange=()=>this.handleSweepAndViewModeChange(),this.handleViewModeChange=()=>this.handleSweepAndViewModeChange(),this.cancelPinCreation=()=>{const{creatingNewPin:e,selectedPin:i}=this.viewData;e&&i&&(this.engine.broadcast(new $.hu(i.id,i.pinType)),this.removePin(i.id,i.pinType),this.resetEditingState())},this.resetEditingState=()=>{const e=this.viewData;e.setPinEditorState(_.V8.IDLE),e.setEditablePin(!1),e.setCanPlace(!0),e.setCanAdd(!this.in360View())},this.onPinPlacementCancelled=()=>{this.cancelPinCreation()},this.onCancelNewPin=async e=>{const{pinType:i,id:t}=e;this.removePin(t,i),this.resetEditingState()},this.handleRemovingPin=async e=>{const{pinType:i,id:t}=e;this.removePin(t,i)},this.handleRemovingPinsByType=async e=>{const{pinType:i}=e;if(i===_.Er.MATTERTAG&&!this.tagsEnabled)return;this.viewData.removePinsByType(i),this.pinRenderer.removePinsByType(i);const{selectedPin:t,focusedPin:n}=this.viewData;(null==t?void 0:t.pinType)===i&&this.changeSelectedPin(null),(null==n?void 0:n.pinType)===i&&this.viewData.setFocusedPin(null)},this.onPinClicked=e=>{const{pinType:i,id:t}=e;if(i===_.Er.MATTERTAG&&!this.tagsEnabled)return;const{selectedPin:n,creatingNewPin:s}=this.viewData,a=t===(null==n?void 0:n.id)&&i===(null==n?void 0:n.pinType);if(n&&a){if(s)return;this.changeSelectedPin(null)}else if(s)this.cancelPinCreation();else{if(!(t===(null==n?void 0:n.id)&&i===(null==n?void 0:n.pinType))){const e=this.viewData.getPin(t);e&&(this.changeSelectedPin(e),this.engine.broadcast(new $.Q4(t,i)))}}},this.onHoverChanged=e=>{const{pinType:i,id:t,hovering:n}=e;if(i===_.Er.MATTERTAG&&!this.tagsEnabled)return;const{creatingNewPin:s,focusedPin:a,selectedPin:o}=this.viewData;if(!s)if(n){if(o&&o.id===t&&o.pinType===i)return;const e=this.viewData.getPin(t);if(!e)return void this.log.debug("Cannot find pin to focus");this.saveScreenPosition(e),this.viewData.setFocusedPin(e),this.pinRenderer.setPinColorVariantByType(i,_.K_.DEFAULT,null==a?void 0:a.id),this.pinRenderer.setPinColorVariant(t,_.K_.HIGHLIGHTED)}else a&&(this.pinRenderer.setPinColorVariant(a.id,_.K_.DEFAULT),this.viewData.setFocusedPin(null))},this.onSelectPin=async e=>{const{id:i,pinType:t,editable:n}=e,s=this.viewData,{selectedPin:a,isPinEditable:o}=s;if(s.setPinEditorState(_.V8.IDLE),i===(null==a?void 0:a.id)&&n===o)return void this.log.debug("Pin is already selected");const d=this.viewData.getPin(i);d&&d.pinType===t?(s.setEditablePin(n),this.changeSelectedPin(d),s.setFocusedPin(null)):this.log.debug(`Cannot select ${t} pin`)},this.clickOffPin=async()=>{this.viewData.creatingNewPin||this.changeSelectedPin(null)},this.movePin=async e=>{const{selectedPin:i,isPinEditable:t}=this.viewData;t&&(i&&i.id===e.id?(this.viewData.updateSelectedPin(e.pos),this.engine.broadcast(new $.bV(i.id,i.pinType,e.pos,e.previousPos))):this.log.debug("Cannot move the pin, not open for edit"))},this.placePin=async e=>{const{selectedPin:i,isPinEditable:t,canPlace:n}=this.viewData;t&&(i&&n?(this.viewData.setPinEditorState(_.V8.PLACED),this.engine.broadcast(new $.b0(i.id,i.pinType,i))):(this.log.debug("Cannot place pin because there is no open pin"),this.cancelPinCreation()))}}async init(e,i){this.engine=i,this.tagsEnabled=e.newTagsEnabled;const[t,n,s,o,d]=await Promise.all([i.getModuleBySymbol(a.y.INPUT),i.getModuleBySymbol(a.y.WEBGL_RENDERER),i.market.waitForData(c.W),i.market.waitForData(r.pu),i.getModuleBySymbol(a.y.RAYCASTER)]);this.input=t;const p={onClick:(e,t)=>{i.broadcast(new $.F7(e,t))},onHover:(e,t)=>{i.broadcast(new $.tP(e,!0,t)),i.commandBinder.issueCommand(new b.u(y.C.FINGER)),i.commandBinder.issueCommand(new v.y(!0))},onUnhover(e,t){i.broadcast(new $.tP(e,!1,t)),i.commandBinder.issueCommand(new b.u(null)),i.commandBinder.issueCommand(new v.y(!1))}},C=i.claimRenderLayer(this.name);this.pinRenderer=n.supportsInstancing()?new InstancedPinRenderer(t,n.getCamera(),s,C,i.commandBinder,d,p):new NonInstancedPinRenderer(t,n.getCamera(),s,C,i.commandBinder,d,p),n.getScene().add(this.pinRenderer.container),i.addComponent(this,this.pinRenderer),[this.floorsViewData,this.viewmodeData,this.interactionmodeData,this.sweepData,this.cameraData]=await Promise.all([i.market.waitForData(l.c),i.market.waitForData(g.O),i.market.waitForData(h.Z),i.market.waitForData(u.Z),i.market.waitForData(m.M_)]),this.viewData=new P.B,this.pinEditor=new PinEditor(this.viewData,this.engine,this.input,this.pinRenderer),this.floorsViewData.iterate((e=>this.pinRenderer.getFloorContainer(e.id))),this.viewmode=this.viewmodeData.currentMode,this.bindings.push(i.commandBinder.addBinding(z.Ki,this.onEnablePinEditing),i.commandBinder.addBinding(z.Ar,this.onSelectPin),i.commandBinder.addBinding(z.RH,this.onUnselectPin),i.commandBinder.addBinding(z.yR,this.clickOffPin),i.commandBinder.addBinding(z.tE,this.onUpdatePin),i.commandBinder.addBinding(z.mE,this.onUpdatePinViews),i.commandBinder.addBinding(z.ik,this.onChangePinVisibility),i.commandBinder.addBinding(z.qN,this.onChangePinVisibilityByType),i.commandBinder.addBinding(z._Y,this.onChangePinOpacity),i.commandBinder.addBinding(z.kb,this.onChangePinOpacityByType),i.commandBinder.addBinding(z.fM,this.onStartPinCreation),i.commandBinder.addBinding(z.OL,this.handleRemovingPin),i.commandBinder.addBinding(z.zM,this.handleRemovingPinsByType),i.commandBinder.addBinding(z.I$,this.movePin),this.interactionmodeData.onChanged(this.visibilityChanged),this.floorsViewData.onChanged(this.visibilityChanged),this.viewmodeData.makeModeChangeSubscription(this.visibilityChanged),i.subscribe(T.Z,this.visibilityChanged),i.subscribe(w.a,this.viewmodeChanged),i.subscribe(k.Z,this.viewmodeChanged),i.subscribe($.F7,this.onPinClicked),this.viewData.onPinEditorStateChanged(this.updateCurrentPin),this.viewData.onSelectedPinChanged(this.updateCurrentPin),this.viewData.onFocusedPinChanged(this.updateCurrentPin),this.viewData.onPinEditableChanged(this.updateCurrentPin),this.cameraData.onChanged(this.onCameraUpdate)),this.touchDevice||this.bindings.push(i.subscribe($.tP,this.onHoverChanged));let f=o.application;this.bindings.push(o.onPropertyChanged("application",(e=>{e!==f&&(this.visibilityChanged(),this.viewData.creatingNewPin?this.cancelPinCreation():(this.changeSelectedPin(null),this.viewData.setFocusedPin(null),this.resetEditingState()),f=e)}))),this.visibilityChanged(),i.market.register(this,P.B,this.viewData)}dispose(e){this.disableEditing(),this.viewData.setPinEditorState(_.V8.IDLE),this.pinEditor.dispose(),this.pinRenderer.dispose(),this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],this.editBindings=[],super.dispose(e)}onUpdate(){this.editActivated&&this.pinEditor.update()}in360View(){const e=this.sweepData.currentSweep?this.sweepData.currentSweep:"";return this.viewmodeData.isInside()&&this.sweepData.isSweepUnaligned(e)}enableEditing(){if(!this.editActivated){if(this.editActivated=!0,this.pinEditor.toggleEditing(!0),0===this.editBindings.length){const e=this.engine,i=e.commandBinder;this.editBindings.push(i.addBinding(z.ip,this.placePin),i.addBinding(z.tT,this.onCancelNewPin),this.sweepData.makeSweepChangeSubscription(this.handleSweepChange),e.subscribe(k.Z,this.handleViewModeChange),e.subscribe($.pe,this.onPinPlacementCancelled))}else this.editBindings.forEach((e=>{e.renew()}));this.handleSweepAndViewModeChange()}}disableEditing(){this.editActivated&&(this.editActivated=!1,this.pinEditor.toggleEditing(!1),this.resetEditingState(),this.editBindings.forEach((e=>{e.cancel()})))}changeSelectedPin(e){const{selectedPin:i}=this.viewData;(null==e?void 0:e.id)!==(null==i?void 0:i.id)?(i&&(this.engine.broadcast(new $.WM(i.id,i.pinType)),this.pinRenderer.hideSelectedMesh()),e?(this.saveScreenPosition(e),this.viewData.setSelectedPin(e),this.pinRenderer.showSelectedMesh(e.pinType,e.id)):(this.viewData.setScreenPosition(null),this.viewData.setSelectedPin(null))):this.log.debug("Pin selection did not change")}handleSweepAndViewModeChange(){const e=this.viewData,i=!this.in360View();e.creatingNewPin&&!i?(this.cancelPinCreation(),this.resetEditingState()):e.setCanAdd(i)}removePin(e,i){if(i===_.Er.MATTERTAG&&!this.tagsEnabled)return;this.viewData.removePin(e),this.pinRenderer.removePin(e);const{selectedPin:t,focusedPin:n}=this.viewData;(null==t?void 0:t.id)===e&&(null==t?void 0:t.pinType)===i&&this.changeSelectedPin(null),(null==n?void 0:n.id)===e&&(null==n?void 0:n.pinType)===i&&this.viewData.setFocusedPin(null)}}const me=PinsModule},10634:(e,i,t)=>{"use strict";t.r(i),t.d(i,{CancelNewTagCommand:()=>K.$g,CloseTagCommand:()=>K.xb,DeleteTagCommand:()=>K.T3,DockLeftTagCommand:()=>K.sf,EditTagCommand:()=>K.zt,OpenTagCommand:()=>K.lt,ResumeTagVisibilityUpdates:()=>K.yo,SaveTagCommand:()=>K.QG,SaveTagOrderCommand:()=>K.Bz,SaveTagVisibilityCommand:()=>K.bg,SetTagsModeCommand:()=>K.Li,StartNewTagCommand:()=>K.$J,SuspendTagVisibilityUpdates:()=>K.$D,TagsMode:()=>ie.U,TagsToolToggleCommand:()=>K.yU,TagsViewData:()=>J.n,ToggleDirtyTagStateCommand:()=>K.q4,default:()=>ae});var n=t(2212),s=t(57227),a=t(14877),o=t(39142),d=t(10854),r=t(81402),c=t(89034),l=t(4592),h=t(47247),m=t(52549),u=t(47063),g=t(14832),p=t(48730),v=t(20585),b=t(64921),y=t(1001),T=t(12757),k=t(36742),w=t(47497),P=t(11679),C=t(27696),f=t(72136),D=t(99380),A=t(65143),S=t(40825),E=t(57183),I=t(18236),M=t(47357),N=t(49315),V=t(50566),O=t(23676),B=t(68168),j=t(25986),R=t(34612),F=t(71843),x=t(57524),H=t(28253),_=t(86413),L=t(24497),G=t(18253),U=t(23400),z=t(484),$=t(61709),J=t(69826),K=t(19822),W=t(87443),q=t(85553),Z=t(9986),Y=t(56044),Q=t(53549),X=t(61903),ee=t(37363),ie=t(59483),te=t(56396),ne=t(15099),se=t(39823);class TagsModule extends s.Y{constructor(){super(...arguments),this.name="tags-module",this.opening=null,this.activated=!1,this.registered=!1,this.activeBindings=[],this.updatePerSettings=()=>{if(this.viewData.suspendVisibilityUpdates)return;const e=this.settingsData.tryGetProperty(G.re,!1),i=!this.in360View();this.engine.commandBinder.issueCommand(new D.qN(A.Er.MATTERTAG,i&&e))},this.tagsToolToggled=async e=>{e.opened?this.activateTool():this.deactivateTool()},this.updateViewingControls=()=>{const{openTagView:e}=this.viewData,i=this.toolsData.toolPanelLayout===O.wS.BOTTOM_PANEL,t=!this.activated||!i&&!e;this.engine.broadcast(new B.ps(t))},this.onCloseTag=async()=>{this.closeTag()},this.pinAddCancelled=e=>{e.pinType===A.Er.MATTERTAG&&this.cancelTagCreation(!1)},this.onCancelNewTag=async()=>{this.cancelTagCreation(!0)},this.cancelTagCreation=e=>{var i;const t=this.viewData,n=null===(i=t.openTagView)||void 0===i?void 0:i.id;this.cancelAttachmentChanges(),t.setOpenTagView(null),t.creatingTag=!1,t.dirtyTagState=!1,t.commit(),n&&(e&&this.engine.commandBinder.issueCommand(new D.tT(n,A.Er.MATTERTAG)),this.engine.commandBinder.issueCommand(new I.Aj(n,M.J.TAG)))},this.tagsWereChanged=()=>{this.viewData.updateViewData(),this.displayTags()},this.onOpenTagViewChanged=()=>{const e=this.viewData.openTagView;e&&this.updateTagPin(e)},this.startTagCreation=async()=>{const e=this.viewData;e.setTagsMode(ie.U.DEFAULT),await this.closeTag();let i=(0,r.O1)(11);for(;this.tagsData.getTag(i);)i=(0,r.O1)(11);const t=new z.U;t.sid=i,t.floorId=this.floorsViewData.getHighestVisibleFloor().id;const n=e.createTagView(t);e.creatingTag=!0,e.dirtyTagState=!0,e.commit(),e.setOpenTagView(n),this.engine.commandBinder.issueCommand(new D.fM(n.id,n,A.Er.MATTERTAG,n.backgroundTexture,n.maskTexture))},this.saveTag=async e=>{const{id:i,properties:t,pendingAttachments:n,removedAttachments:s,embed:a}=e,o=this.viewData,{openTagView:d,creatingTag:r}=o;if(!d)return void this.log.debug("No open tag");const c=Object.assign({},d,t);this.trackChanges(i,c,a),r?await this.engine.commandBinder.issueCommand(new U.Mm(i,c,n,a)):await this.engine.commandBinder.issueCommand(new U.qq(i,c,n,s,a)),this.selectPin(i,!0),o.creatingTag=!1,o.dirtyTagState=!1,o.commit(),await this.engine.commandBinder.issueCommand(new W.x9),this.closeTag()},this.saveTagVisibility=async e=>{const{id:i,visible:t}=e;this.engine.commandBinder.issueCommand(new D.ik(i,A.Er.MATTERTAG,this.getTagVisibility(i,t)));const n={enabled:t};return this.trackChanges(i,n),this.engine.commandBinder.issueCommand(new U.qq(i,n))},this.onToggleTagDirty=async e=>{this.viewData.dirtyTagState=e.dirty,this.viewData.commit()},this.onDeleteTag=async e=>{const i=e.id;this.tagsData.getTag(i)?(this.engine.commandBinder.issueCommand(new F.rE),this.engine.broadcast(new C.bF(i,e.removalMethod)),this.engine.commandBinder.issueCommand(new U.Gn(i)).then((()=>{this.saveTags().then((()=>{this.engine.commandBinder.issueCommand(new D.OL(i,A.Er.MATTERTAG));const e=this.viewData.openTagView;e&&e.id===i&&this.closeTag()}))}))):this.log.debug("Cannot delete a non-existent tag")},this.onEditTag=async e=>{const{tagId:i}=e;this.tagsData.getTag(i)?(await this.openTag(i,g.n.FadeToBlack,!0),this.openAnnotation(i,!0),this.selectPin(i,!0)):this.log.debug("Cannot edit a non-existent tag")},this.onSaveTagOrder=async e=>{const i=e.ids.map((e=>({id:e,type:x.l.TAG})));await this.engine.commandBinder.issueCommand(new H.wg(L.q,i)),this.viewData.setTagSortOrder(this.getSavedTagOrder())},this.pinMoved=e=>{const{id:i,pinType:t,pinPos:n,previousPos:s}=e,a=this.viewData.openTagView;if(a&&t===A.Er.MATTERTAG&&i===a.id){if(this.tagsData.getTag(i)){const e={position:n.anchorPosition,normal:n.stemNormal,floorId:n.floorId};this.engine.broadcast(new C.sk(i,e.position,e.position.distanceTo(this.cameraData.pose.position),s?e.position.distanceTo(s.anchorPosition):0)),this.engine.commandBinder.issueCommand(new U.qq(i,e))}else this.log.debug("Cannot move a non-existent tag")}},this.pinPlaced=e=>{const i=this.viewData.openTagView;i&&e.pinType===A.Er.MATTERTAG&&e.id===i.id&&(this.viewData.updateOpenTagView(e.pinPos),this.openAnnotation(i.id,!0))},this.handlePinFocusChange=async()=>{const{openTagView:e,creatingTag:i}=this.viewData;if(i)return;const{commandBinder:t}=this.engine,{focusedPin:n,selectedPin:s}=this.pinsViewData,{billboardAnnotation:a}=this.annotationsViewData;if(!n)return void(a&&a.annotationType===M.J.TAG&&a.id!==(null==s?void 0:s.id)&&await t.issueCommand(new I.Aj(a.id,M.J.TAG)));const o=this.getSelectedTag(),d=o&&(null==o?void 0:o.id)===(null==e?void 0:e.id),r=e&&(null==e?void 0:e.id)===(null==n?void 0:n.id);if(e&&d&&!r&&this.closeTag(),n.pinType===A.Er.MATTERTAG){const i=this.viewData.getTagView(n.id);if(!i)return void this.log.debug("Focused pin changed, but no tag view.");i.id!==(null==e?void 0:e.id)&&t.issueCommand(new I.Kw(i.id,M.J.TAG))}},this.handlePinSelectionChange=async()=>{const{openTagView:e,dirtyTagState:i}=this.viewData,{selectedPin:t}=this.pinsViewData;if(i||(null==e?void 0:e.id)===(null==t?void 0:t.id))return;const n=this.appData.application===Z.Mx.WORKSHOP;if(e&&!t)!n&&this.activated?this.deactivateTool():this.closeTag();else if(t&&t.pinType===A.Er.MATTERTAG){const e=this.isTagDocked(),i=n&&this.activated&&!!e,s=!(0,v.OR)()||i;await this.openTag(t.id,g.n.Interpolate,s),this.openAnnotation(t.id,s)}},this.handleAnnotationsChanged=async()=>{const{openTagView:e,creatingTag:i}=this.viewData;if(i||this.opening)return;const t=this.getDockedTag(),n=this.getSelectedTag(),s=t||n,a=!!t,{dockedAnnotation:o}=this.annotationsViewData;e&&!s&&(null==o?void 0:o.annotationType)!==M.J.OBJECT?this.closeTag():s&&s.id!==(null==e?void 0:e.id)&&(await this.openTag(s.id,g.n.Interpolate,a),this.selectPin(s.id,a)),this.toggleToolForDocking(a)},this.handleViewingAttachment=e=>{const{annotationType:i,id:t,attachmentId:n}=e;if(i!==M.J.TAG)return;const s=this.viewData.getTagView(t);if(!s)return void this.log.debug("Cannot view attachment for a non-existent tag");const a=s.attachments,o=a.find((e=>e.id===n));if(o&&(0,q.lV)(o)){const e=a.filter((e=>(0,q.lV)(e)));this.engine.commandBinder.issueCommand(new W.xW(!0,e,n))}},this.dockLeftTag=async e=>{const i=e.tagId,t=this.viewData.getTagView(i);this.engine.commandBinder.issueCommand(new I.bd(i,M.J.OBJECT)),this.viewData.setOpenTagView(t),this.selectPin(i,!0)},this.onOpenTag=async e=>{const{tagId:i,dock:t,transition:n}=e,s=null!==t?t:this.isTagDocked();await this.openTag(i,n,s),this.openAnnotation(i,s),this.selectPin(i,s)},this.suspendTagVisibilityUpdates=async()=>{this.viewData.suspendVisibilityUpdates=!0,this.viewData.commit()},this.resumeTagVisibilityUpdates=async()=>{this.viewData.suspendVisibilityUpdates=!1,this.viewData.commit()},this.setTagsMode=async({mode:e})=>{e===ie.U.REORDERING&&this.closeTag(),this.viewData.setTagsMode(e)}}async init(e,i){const[t,n,s,r,m,u,g,p,v,w,P]=await Promise.all([i.market.waitForData(ne.M_),i.market.waitForData($.n),i.market.waitForData(j.t),i.market.waitForData(Q.Z),i.market.waitForData(X.e),i.market.waitForData(ee.O),i.market.waitForData(N.A),i.market.waitForData(Z.pu),i.market.waitForData(Y.c),i.market.waitForData(_.W),i.getModule(o.default)]),[C,f,D]=await Promise.all([i.market.waitForData(se.i),i.market.waitForData(te.O),i.getModuleBySymbol(a.y.DEEP_LINKS)]);this.cameraData=t,this.tagsData=n,this.toolsData=s,this.sweepData=r,this.settingsData=m,this.viewmodeData=u,this.annotationsViewData=g,this.appData=p,this.floorsViewData=v,this.orderedListData=w,this.engine=i,this.maskTexture=(0,c.p)(h),this.backgroundTexture=(0,c.p)(l),this.descriptionParser=new y.$({model:e.viewId,supportLinks:!0,keepLinkLabels:!0});const A=new b.v({links:!0,hashtags:!1}),E=this.getSavedTagOrder();this.viewData=new J.n(this.tagsData,C,f,E,A,D,P.t(d.Z.WORKSHOP.MATTERTAGS.DEFAULT_TAG_TITLE),this.backgroundTexture,this.maskTexture,e.keywordsEnabled),this.pinsViewData=await i.market.waitForData(S.B),this.bindings.push(m.onPropertyChanged(G.re,this.updatePerSettings),i.commandBinder.addBinding(K.yU,this.tagsToolToggled),i.subscribe(V.qk,this.handleViewingAttachment),i.subscribe(T.Z,this.updatePerSettings),i.subscribe(k.m,this.updatePerSettings),u.makeModeChangeSubscription(this.updatePerSettings),i.commandBinder.addBinding(K.xb,this.onCloseTag),i.commandBinder.addBinding(K.lt,this.onOpenTag),i.commandBinder.addBinding(K.Li,this.setTagsMode),i.commandBinder.addBinding(K.sf,this.dockLeftTag),i.commandBinder.addBinding(K.QG,this.saveTag),i.commandBinder.addBinding(K.q4,this.onToggleTagDirty),i.commandBinder.addBinding(K.T3,this.onDeleteTag),this.pinsViewData.onSelectedPinChanged(this.handlePinSelectionChange),this.pinsViewData.onFocusedPinChanged(this.handlePinFocusChange),this.annotationsViewData.onChanged(this.handleAnnotationsChanged),this.viewData.onOpenTagViewChanged(this.onOpenTagViewChanged),this.tagsData.onChanged(this.tagsWereChanged),i.commandBinder.addBinding(K.$D,this.suspendTagVisibilityUpdates),i.commandBinder.addBinding(K.yo,this.resumeTagVisibilityUpdates),this.viewData.onPropertyChanged("suspendVisibilityUpdates",this.updatePerSettings)),i.market.register(this,J.n,this.viewData),this.updatePerSettings(),this.displayTags()}dispose(e){this.deactivateTool(!0),this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],this.activeBindings=[],this.engine.commandBinder.issueCommand(new D.zM(A.Er.MATTERTAG)),this.maskTexture.dispose(),this.backgroundTexture.dispose(),super.dispose(e)}onUpdate(){}activateTool(){this.activated||(this.engine.commandBinder.issueCommand(new I.yL(M.J.TAG)),this.engine.commandBinder.issueCommand(new D.Ki(!0)),this.registered?this.activeBindings.forEach((e=>{e.renew()})):this.registerHandlers(),this.activated=!0)}deactivateTool(e){if(!this.activated)return;const{creatingTag:i,openTagView:t,tagsMode:n}=this.viewData;n!==ie.U.DEFAULT&&this.viewData.setTagsMode(ie.U.DEFAULT),i?this.cancelTagCreation(!0):t&&this.closeTag(),this.engine.commandBinder.issueCommand(new D.Ki(!1)),this.activeBindings.forEach((e=>{e.cancel()})),this.activated=!1}registerHandlers(){const e=this.engine.commandBinder;this.activeBindings.push(this.engine.subscribe(E.b0,this.pinPlaced),this.engine.subscribe(E.bV,this.pinMoved),this.engine.subscribe(E.hu,this.pinAddCancelled),e.addBinding(K.bg,this.saveTagVisibility),e.addBinding(K.$J,this.startTagCreation),e.addBinding(K.$g,this.onCancelNewTag),e.addBinding(K.zt,this.onEditTag),e.addBinding(K.Bz,this.onSaveTagOrder),this.viewData.onOpenTagViewChanged(this.updateViewingControls),this.viewData.onPropertyChanged("creatingTag",this.updateViewingControls)),this.registered=!0}in360View(){const e=this.sweepData.currentSweep?this.sweepData.currentSweep:"";return this.viewmodeData.isInside()&&this.sweepData.isSweepUnaligned(e)}async closeTag(){const{commandBinder:e}=this.engine,i=this.viewData,{openTagView:t,dirtyTagState:n}=i;if(n&&(i.dirtyTagState=!1,i.commit()),t){const{id:n,enabled:s}=t;i.setOpenTagView(null),this.cancelAttachmentChanges(),e.issueCommand(new W.xW(!1));this.tagsData.getTag(n)&&(e.issueCommand(new D.RH(n,A.Er.MATTERTAG)),e.issueCommand(new D.ik(n,A.Er.MATTERTAG,this.getTagVisibility(n,s)))),await e.issueCommand(new I.Aj(n,M.J.TAG))}}getTagVisibility(e,i){const{openTagView:t}=this.viewData;return(null==t?void 0:t.id)===e||i}displayTags(){const e=[];this.viewData.tagViewList.forEach((i=>{i.objectAnnotationId||e.push(Object.assign(Object.assign({},i),{pinType:i.objectAnnotationId?A.Er.OBJECT:A.Er.MATTERTAG,backgroundTexture:this.backgroundTexture,maskTexture:this.maskTexture,visible:this.getTagVisibility(i.id,i.enabled)}))})),this.engine.commandBinder.issueCommand(new D.mE(e))}updateTagPin(e){if(e.objectAnnotationId)return;const i=Object.assign(Object.assign({},e),{pinType:A.Er.MATTERTAG,backgroundTexture:this.backgroundTexture,maskTexture:this.maskTexture,visible:this.getTagVisibility(e.id,e.enabled)});this.engine.commandBinder.issueCommand(new D.mE([i]))}async cancelAttachmentChanges(){return this.engine.commandBinder.issueCommand(new W.Ze)}getSavedTagOrder(){const e=this.orderedListData.getOrderedList(L.q);return e?e.entries.map((e=>e.id)):[]}async saveTags(){this.engine.commandBinder.issueCommand(new u.VQ({dataTypes:[m.g.MATTERTAGS]}))}openAnnotation(e,i){i?this.engine.commandBinder.issueCommand(new I.bd(e,M.J.TAG)):this.engine.commandBinder.issueCommand(new I.oM(e,M.J.TAG))}async selectPin(e,i=!1){const t=i&&this.activated&&this.appData.application===Z.Mx.WORKSHOP;await this.engine.commandBinder.issueCommand(new D.Ar(e,A.Er.MATTERTAG,t))}async openTag(e,i,t){const n=this.viewData,s=n.getTagView(e);if(s){const{openTagView:a,tagsMode:o}=this.viewData,{commandBinder:d}=this.engine,{dockedAnnotation:r,selectedAnnotation:c}=this.annotationsViewData;t&&o===ie.U.REORDERING&&n.setTagsMode(ie.U.DEFAULT),t&&this.toolsData.panelCollapsed&&this.activated&&d.issueCommand(new R.zK(!1));const l=(null==a?void 0:a.id)===e;if(l&&this.activated===t)return void this.log.debug("Tag is already open and "+(t?"docked":"undocked"));t!==!!r&&(await this.toggleToolForDocking(t),r&&await this.engine.commandBinder.issueCommand(new I.Aj(r.id,r.annotationType))),l||this.opening===e||(this.opening=e,d.issueCommand(new F.rE),c&&c.id!==e&&await this.engine.commandBinder.issueCommand(new I.Aj(c.id,c.annotationType)),n.setOpenTagView(s),null!==i&&await this.engine.commandBinder.issueCommand(new p.OR({pinPosition:s,transition:i})),this.opening=null)}else this.log.debug("Cannot open a non-existent tag")}isTagDocked(){const{dockedAnnotation:e}=this.annotationsViewData;return(null==e?void 0:e.annotationType)===M.J.TAG}getDockedTag(){const{dockedAnnotation:e}=this.annotationsViewData;return e&&e.annotationType===M.J.TAG?this.viewData.getTagView(e.id):null}getSelectedTag(){const{billboardAnnotation:e,billboardSelected:i}=this.annotationsViewData;return e&&i&&e.annotationType===M.J.TAG||(null==e?void 0:e.annotationType)===M.J.OBJECT?this.viewData.getTagView(e.id):null}async toggleToolForDocking(e){if(e===this.activated)return;this.appData.application===Z.Mx.WORKSHOP&&!e||await this.engine.commandBinder.issueCommand(new R.tT(O.w1.TAGS,e))}trackChanges(e,i,t){const s=this.tagsData.getTag(e),{position:a,color:o,description:d,label:r,stemHeight:c,stemVisible:l,enabled:h,keywords:m}=i;if(!s&&a)return void this.engine.broadcast(new C.nP(e,a,a.distanceTo(this.cameraData.pose.position)));if(void 0!==h&&s.enabled!==h&&this.engine.broadcast(new C.dl(e,f.z.ENABLED,h)),o){const i=new n.Color(o.r,o.g,o.b).getHexString();s.color.getHexString()!==i&&this.engine.broadcast(new C.dl(e,f.z.DISC_COLOR,`#${i}`))}if(void 0!==c&&s.stemHeight!==c&&this.engine.broadcast(new C.dl(e,f.z.STEM_LENGTH,c)),void 0!==l&&s.stemVisible!==l&&this.engine.broadcast(new C.dl(e,f.z.STEM_VISIBLE,l)),void 0!==r&&s.label!==r&&(this.engine.broadcast(new C.dl(e,f.z.TITLE,r.length)),this.engine.broadcast(new C.Y7(e,r.length))),void 0!==d&&s.description!==d){this.engine.broadcast(new C.dl(e,f.z.DESCRIPTION,d.length));const i=this.descriptionParser.parse(d);this.engine.broadcast(new C.ug(e,d.length,i));const t=y.$.getNumLinks(i);y.$.getNumLinks(s.parsedDescription)!==t&&this.engine.broadcast(new C.dl(e,f.z.LINKS,t))}if(t){const i=t?t.src:"",n=t?(0,w.F5)(t.mediaType):P.z.none;s.mediaSrc===i&&s.mediaType===n||(this.engine.broadcast(new C.dl(e,f.z.MEDIA,n)),this.engine.broadcast(new C.Qi(e,n,i)))}const u=s.keywords.every((e=>m&&m.includes(e)));if((null==m?void 0:m.length)!==s.keywords.length||!u){const i=(null==m?void 0:m.length)||0;this.engine.broadcast(new C.dl(e,f.z.KEYWORDS,i))}}}const ae=TagsModule},57331:e=>{var i={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetInferenceEvents"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"ids"}},type:{kind:"ListType",type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"inferenceEvents"},arguments:[{kind:"Argument",name:{kind:"Name",value:"ids"},value:{kind:"Variable",name:{kind:"Name",value:"ids"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"InferenceEventDetails"},directives:[]}]}}]}}]}},{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetObjectAnnotations"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"inferenceEvents"}},type:{kind:"ListType",type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"minConfidence"}},type:{kind:"NamedType",name:{kind:"Name",value:"Float"}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"ids"}},type:{kind:"ListType",type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"objectAnnotations"},arguments:[{kind:"Argument",name:{kind:"Name",value:"inferenceEvents"},value:{kind:"Variable",name:{kind:"Name",value:"inferenceEvents"}}},{kind:"Argument",name:{kind:"Name",value:"minimumConfidenceOverride"},value:{kind:"Variable",name:{kind:"Name",value:"minConfidence"}}},{kind:"Argument",name:{kind:"Name",value:"ids"},value:{kind:"Variable",name:{kind:"Name",value:"ids"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}}]}},{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetObjectClassifications"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"objectClassifications"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"defaultKeywords"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"defaultConfidenceThreshold"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"detectionModels"},arguments:[],directives:[]}]}}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"PatchObjectAnnotation"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelIdField"}},type:{kind:"NamedType",name:{kind:"Name",value:"ModelIdField"}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"data"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ObjectAnnotationPatch"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"patchObjectAnnotation"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"field"},value:{kind:"Variable",name:{kind:"Name",value:"modelIdField"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotationId"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationId"}}},{kind:"Argument",name:{kind:"Name",value:"patch"},value:{kind:"Variable",name:{kind:"Name",value:"data"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"AcceptObjectAnnotations"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationIds"}},type:{kind:"ListType",type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"acceptObjectAnnotations"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotationIds"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationIds"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"DismissObjectAnnotations"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelIdField"}},type:{kind:"NamedType",name:{kind:"Name",value:"ModelIdField"}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationIds"}},type:{kind:"ListType",type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"dismissObjectAnnotations"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"field"},value:{kind:"Variable",name:{kind:"Name",value:"modelIdField"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotationIds"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationIds"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"RejectObjectAnnotations"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelIdField"}},type:{kind:"NamedType",name:{kind:"Name",value:"ModelIdField"}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationIds"}},type:{kind:"ListType",type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"rejectObjectAnnotations"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"field"},value:{kind:"Variable",name:{kind:"Name",value:"modelIdField"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotationIds"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationIds"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"AddObjectAnnotation"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotation"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ObjectAnnotationDetails"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"addObjectAnnotation"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotation"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotation"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}},{kind:"FragmentDefinition",name:{kind:"Name",value:"InferenceEventDetails"},typeCondition:{kind:"NamedType",name:{kind:"Name",value:"InferenceEvent"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"created"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"filename"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"detectionModelName"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"detectionModelVersion"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"detectionModelConfiguration"},arguments:[],directives:[]}]}},{kind:"FragmentDefinition",name:{kind:"Name",value:"ObjectAnnotationDetailInfo"},typeCondition:{kind:"NamedType",name:{kind:"Name",value:"ObjectAnnotationDetails"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"floorId"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"roomId"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"enabled"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"keywords"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"classification"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"vectorRegion"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"InlineFragment",typeCondition:{kind:"NamedType",name:{kind:"Name",value:"VectorRegion"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"anchorPosition"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"x"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"y"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"z"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"stemNormal"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"x"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"y"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"z"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"stemLength"},arguments:[],directives:[]}]}}]}}]}},{kind:"FragmentDefinition",name:{kind:"Name",value:"ObjectAnnotationInfo"},typeCondition:{kind:"NamedType",name:{kind:"Name",value:"ObjectAnnotation"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"created"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"modified"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"model"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"floor"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"room"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"enabled"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"confidence"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"panos"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"region"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"InlineFragment",typeCondition:{kind:"NamedType",name:{kind:"Name",value:"VectorRegion"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"anchorPosition"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"x"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"y"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"z"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"stemNormal"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"x"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"y"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"z"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"stemLength"},arguments:[],directives:[]}]}}]}},{kind:"Field",name:{kind:"Name",value:"status"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"tag"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"keywords"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"classification"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"defaultKeywords"},arguments:[],directives:[]}]}}]}}],loc:{start:0,end:2928}};i.loc.source={body:"# Object Tag Suggestions\n# Reference: https://matterport-confluence.atlassian.net/wiki/spaces/PP/pages/2678521926/Datafication+Object+Detection+Schema+Proposal\n\n\nquery GetInferenceEvents($modelId: ID!, $ids: [ID!]) {\n  model(id: $modelId) {\n    inferenceEvents(ids: $ids) {\n      ...InferenceEventDetails\n    }\n  }\n}\n\nquery GetObjectAnnotations($modelId: ID!, $inferenceEvents: [ID!], $minConfidence: Float, $ids: [ID!]) {\n  model(id: $modelId) {\n    objectAnnotations(inferenceEvents: $inferenceEvents, minimumConfidenceOverride: $minConfidence, ids: $ids) {\n      ...ObjectAnnotationInfo\n    }\n  }\n}\n\nquery GetObjectClassifications($modelId: ID!) {\n  model(id: $modelId) {\n    objectClassifications {\n      id,\n      label,\n      defaultKeywords,\n      defaultConfidenceThreshold,\n      detectionModels\n    }\n  }\n}\n\nmutation PatchObjectAnnotation($modelId: ID!, $modelIdField: ModelIdField, $objectAnnotationId: ID!, $data: ObjectAnnotationPatch!) {\n  patchObjectAnnotation(modelId: $modelId, field: $modelIdField, objectAnnotationId: $objectAnnotationId, patch: $data) {\n    ...ObjectAnnotationInfo\n  }\n}\n\nmutation AcceptObjectAnnotations($modelId: ID!, $objectAnnotationIds: [ID!]) {\n  acceptObjectAnnotations(modelId: $modelId, objectAnnotationIds: $objectAnnotationIds) {\n    ...ObjectAnnotationInfo\n  }\n}\n\nmutation DismissObjectAnnotations($modelId: ID!, $modelIdField: ModelIdField, $objectAnnotationIds: [ID!]) {\n  dismissObjectAnnotations(modelId: $modelId, field: $modelIdField, objectAnnotationIds: $objectAnnotationIds) {\n    ...ObjectAnnotationInfo\n  }\n}\n\nmutation RejectObjectAnnotations($modelId: ID!, $modelIdField: ModelIdField, $objectAnnotationIds: [ID!]) {\n  rejectObjectAnnotations(modelId: $modelId, field: $modelIdField, objectAnnotationIds: $objectAnnotationIds) {\n    ...ObjectAnnotationInfo\n  }\n}\n\nmutation AddObjectAnnotation($modelId: ID!, $objectAnnotation: ObjectAnnotationDetails!) {\n  addObjectAnnotation(modelId: $modelId, objectAnnotation: $objectAnnotation) {\n    ...ObjectAnnotationInfo\n  }\n}\n\nfragment InferenceEventDetails on InferenceEvent {\n  id\n  created\n  filename\n  detectionModelName\n  detectionModelVersion\n  detectionModelConfiguration\n}\n\nfragment ObjectAnnotationDetailInfo on ObjectAnnotationDetails {\n  floorId\n  roomId\n  enabled\n  label\n  keywords\n  classification\n  vectorRegion {\n    ... on VectorRegion {\n      anchorPosition {\n        x, y, z\n      }\n      stemNormal {\n        x, y, z\n      }\n      stemLength\n    }\n  }\n}\n\nfragment ObjectAnnotationInfo on ObjectAnnotation {\n  id\n  created\n  modified\n  model {\n    id\n  }\n  floor {\n    id\n  }\n  room {\n    id\n  }\n  enabled\n  label\n  confidence\n  panos {\n    id\n  }\n  region {\n    ... on VectorRegion {\n      anchorPosition {\n        x, y, z\n      }\n      stemNormal {\n        x, y, z\n      }\n      stemLength\n    }\n  }\n  status\n  tag {\n    id\n  }\n  keywords\n  classification {\n    id,\n    label,\n    defaultKeywords\n  }\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function t(e,i){if("FragmentSpread"===e.kind)i.add(e.name.value);else if("VariableDefinition"===e.kind){var n=e.type;"NamedType"===n.kind&&i.add(n.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){t(e,i)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){t(e,i)})),e.definitions&&e.definitions.forEach((function(e){t(e,i)}))}var n={};function s(e,i){for(var t=0;t<e.definitions.length;t++){var n=e.definitions[t];if(n.name&&n.name.value==i)return n}}function a(e,i){var t={kind:e.kind,definitions:[s(e,i)]};e.hasOwnProperty("loc")&&(t.loc=e.loc);var a=n[i]||new Set,o=new Set,d=new Set;for(a.forEach((function(e){d.add(e)}));d.size>0;){var r=d;d=new Set,r.forEach((function(e){o.has(e)||(o.add(e),(n[e]||new Set).forEach((function(e){d.add(e)})))}))}return o.forEach((function(i){var n=s(e,i);n&&t.definitions.push(n)})),t}i.definitions.forEach((function(e){if(e.name){var i=new Set;t(e,i),n[e.name.value]=i}})),e.exports=i,e.exports.GetInferenceEvents=a(i,"GetInferenceEvents"),e.exports.GetObjectAnnotations=a(i,"GetObjectAnnotations"),e.exports.GetObjectClassifications=a(i,"GetObjectClassifications"),e.exports.PatchObjectAnnotation=a(i,"PatchObjectAnnotation"),e.exports.AcceptObjectAnnotations=a(i,"AcceptObjectAnnotations"),e.exports.DismissObjectAnnotations=a(i,"DismissObjectAnnotations"),e.exports.RejectObjectAnnotations=a(i,"RejectObjectAnnotations"),e.exports.AddObjectAnnotation=a(i,"AddObjectAnnotation"),e.exports.InferenceEventDetails=a(i,"InferenceEventDetails"),e.exports.ObjectAnnotationDetailInfo=a(i,"ObjectAnnotationDetailInfo"),e.exports.ObjectAnnotationInfo=a(i,"ObjectAnnotationInfo")}}]);