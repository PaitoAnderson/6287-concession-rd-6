(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[828],{41843:(e,t,s)=>{"use strict";s.r(t),s.d(t,{BatchToggleBlurVisibilityCommand:()=>BatchToggleBlurVisibilityCommand,BlurToolChangeCommand:()=>BlurToolChangeCommand,BlurToolState:()=>i,HideBlursCommand:()=>HideBlursCommand,NavigateToBlurCommand:()=>NavigateToBlurCommand,SetBlurBrushScaleCommand:()=>SetBlurBrushScaleCommand,ShowBlursCommand:()=>ShowBlursCommand,ToggleBlurVisibilityCommand:()=>ToggleBlurVisibilityCommand,default:()=>BlurEditorModule});var i,a=s(93037);class BlurToolChangeCommand extends a.m{constructor(e){super(),this.id="BLUR_TOOL_CHANGE",this.payload={state:e}}}class SetBlurBrushScaleCommand extends a.m{constructor(e){super(),this.id="SET_BLUR_BRUSH_SCALE",this.payload={scale:e}}}class NavigateToBlurCommand extends a.m{constructor(e,t=!1){super(),this.id="NAVIGATE_TO_BLUR",this.payload={blur:e,resetBlurTool:t}}}class ToggleBlurVisibilityCommand extends a.m{constructor(e){super(),this.id="TOGGLE_BLUR_VISIBILITY",this.payload={id:e}}}class ShowBlursCommand extends a.m{constructor(...e){super(),this.id="SHOW_BLURS",this.payload={ids:e}}}class HideBlursCommand extends a.m{constructor(...e){super(),this.id="HIDE_BLURS",this.payload={ids:e}}}class BatchToggleBlurVisibilityCommand extends a.m{constructor(e){super(),this.id="BATCH_TOGGLE_BLUR_VISIBILITY",this.payload={ids:e}}}!function(e){e.OFF="off",e.IDLE="idle",e.PAINTING="painting",e.SUGGESTING="suggesting"}(i||(i={}));var n,r=s(2212),o=s(57227),l=s(14877),d=s(91183),u=s(53549),c=s(3035),h=s(70399),g=s(94113),m=s(73501),p=s(22937),b=s(56454),S=s(91885),f=s(15099),v=s(10830),B=s(42226),C=s(368),T=s(37363),w=s(22878),y=s(48730),E=s(14832),x=s(77280),I=s(63387),D=s(23676),k=s(34612),O=s(68168),R=s(25986),P=s(29410),L=s(33299),_=s(99295),N=s(74170),A=s(5477),M=s(76922),G=s(7692),U=s(591),j=s(36032),F=s(67779);!function(e){e.DISABLED="disabled",e.IDLE="idle",e.PAINTING="painting"}(n||(n={}));class SphereBrushCursor extends r.Object3D{constructor(){super(),this._radius=.1,this._thickness=.005,this.name="SphereBrushCursor";const e=new r.MeshBasicMaterial({color:16777215,side:r.DoubleSide,depthTest:!1,transparent:!0}),t=this.getGeometry();this.mesh=new r.Mesh(t,e),this.mesh.renderOrder=_.z.reticule,this.add(this.mesh)}getGeometry(){return new r.RingGeometry(this._radius,this._radius+this._thickness,64)}updateCursorMesh(){this.mesh.geometry.dispose(),this.mesh.geometry=this.getGeometry()}get radius(){return this._radius}set radius(e){this._radius=e,this.updateCursorMesh()}dispose(){this.mesh.material.dispose(),this.mesh.geometry.dispose()}}const V=new A.Z("pano-brush");class PanoBrush{constructor(e,t,s,i,a=L.o.ALL){this.sweepData=e,this.cameraData=t,this.scene=s,this.input=i,this.cameraVector=new r.Vector3,this.lastPaint=new r.Vector3,this.mouseCursorEnabled=!1,this.needsUpdate=!0,this.observables={size:new F.f(.1),scale:new F.f(.2),feather:new F.f(.1),pressure:new F.f(.1),opacity:new F.f(1),state:new F.f(n.DISABLED)},this.position=new r.Vector3,this.direction=new r.Vector3,this.sizeRange=[.1,.5],this.featherRange=[.005,.125],this.pressureRange=[.0063,.0125],this.onPointerButton=e=>e.down?this.startPainting():this.stopPainting(),this.onPointerMove=e=>{const t=(0,G.st)(this.cameraData,e.position);if(this.setPosition(t),this.state===n.PAINTING&&this.onPaint){const e=(0,I.et)(this.observables.size.value,this.sizeRange[0],this.sizeRange[1],.005,.03);if(this.lastPaint.length()>0){const t=this.direction.clone().sub(this.lastPaint).setLength(e),s=this.lastPaint.clone();for(;s.angleTo(this.direction)>e;)s.add(t).normalize(),this.lastPaint.copy(s),this.onPaint(s,this.observables.size.value,this.observables.feather.value,this.observables.pressure.value)}else this.lastPaint.copy(this.direction),this.onPaint(this.direction,this.observables.size.value,this.observables.feather.value,this.observables.pressure.value)}},this.onClick=e=>{const t=(0,G.st)(this.cameraData,e.position);this.setPosition(t),this.onPaint&&this.onPaint(this.direction,this.observables.size.value,this.observables.feather.value,this.observables.pressure.value)},this.onMouseMove=e=>{const{tagName:t}=e.target||{},s=this.mouseCursorEnabled||!t||"CANVAS"!==t?null:B.C.NONE;s!==this.mouseCursor&&(this.engine.commandBinder.issueCommand(new v.u(s)),this.mouseCursor=s)},this.brushCursor=new SphereBrushCursor,this.brushCursor.renderOrder=_.z.reticule,this.brushCursor.layers.mask=a.mask}init(){this.bindings=new j.V(this.input.registerPriorityHandler(M._t,r.Mesh,(()=>!0)),this.input.registerHandler(h.mE,this.onPointerMove),this.input.registerHandler(h.er,this.onPointerButton),this.input.registerUnfilteredHandler(c.R,this.onClick),new U.r(document.body,"mousemove",this.onMouseMove)),this.bindings.cancel()}render(){this.state!==n.DISABLED&&this.needsUpdate&&(this.brushCursor.position.copy(this.position),this.brushCursor.lookAt(this.scene.camera.getWorldPosition(this.cameraVector)),this.needsUpdate=!1)}dispose(){this.brushCursor.dispose()}activate(e){this.engine=e}deactivate(e){this.disable()}enable(){V.debug("Enabled"),this.observables.state.value=n.IDLE,this.bindings.renew(),this.scene.add(this.brushCursor)}disable(){V.debug("Disabled"),this.observables.state.value=n.DISABLED,this.bindings.cancel(),this.scene.remove(this.brushCursor),this.engine.commandBinder.issueCommand(new v.u(null))}onPropertyChanged(e,t){return this.observables[e].onChanged(t)}getSizeRange(){return this.sizeRange}setSizeRange(e,t){this.sizeRange=[e,t],this.scale=this.observables.scale.value}get scale(){return this.observables.scale.value}set scale(e){const t=(0,N.uZ)(e,0,1),s=(0,I.dS)(t,0,1,this.sizeRange[0],this.sizeRange[1]),i=(0,I.dS)(t,0,1,this.featherRange[0],this.featherRange[1]),a=(0,I.dS)(t,0,1,this.pressureRange[0],this.pressureRange[1]);this.brushCursor.radius=s,this.observables.size.value=s,this.observables.scale.value=t,this.observables.feather.value=i,this.observables.pressure.value=a,V.debug(`Set brush scale to ${100*t}% (${s})`)}get state(){return this.observables.state.value}get size(){return this.observables.size.value}set size(e){const t=(0,N.uZ)(e,this.sizeRange[0],this.sizeRange[1]),s=(0,I.dS)(t,this.sizeRange[0],this.sizeRange[1],0,1),i=(0,I.dS)(t,this.sizeRange[0],this.sizeRange[1],this.featherRange[0],this.featherRange[1]),a=(0,I.dS)(t,this.sizeRange[0],this.sizeRange[1],this.pressureRange[0],this.pressureRange[1]);this.brushCursor.radius=t,this.observables.size.value=t,this.observables.scale.value=s,this.observables.feather.value=i,this.observables.pressure.value=a,V.debug(`Set brush size to ${t} (${100*s}%)`)}toggleMouseCursor(e){this.mouseCursorEnabled=e}startPainting(){this.observables.state.value=n.PAINTING}stopPainting(){this.observables.state.value=n.IDLE,this.lastPaint.set(0,0,0)}setPosition(e){const t=this.sweepData.currentSweepObject;if(!t)return;const s=e.clone().sub(t.position).normalize(),i=t.position.clone().add(s);this.position.copy(i),this.direction.copy(s),this.needsUpdate=!0}}class BlurMesh extends r.InstancedMesh{}var z=s(70446),H=s(80122),Q=s(93093),W=s(65171);const $={brush:{uniforms:{opacity:{type:"v3",value:new r.Vector3(1,1,1)},color:{type:"c",value:new r.Color},radius:{type:"v3",value:new r.Vector3(.1,.1,.1)},feather:{type:"v3",value:new r.Vector3(0,0,0)}},vertexShader:s(682),fragmentShader:s(20959)},combineBlurs:{uniforms:{maskMatrix:{type:"m4",value:new r.Matrix4},maskTexture:{type:"t",value:null},panoMatrix1:{type:"m4",value:new r.Matrix4},panoMatrix2:{type:"m4",value:new r.Matrix4},panoBlurredMap0:{type:"t",value:null},panoBlurredMap1:{type:"t",value:null},panoBlurredMap2:{type:"t",value:null},panoBlurredMap3:{type:"t",value:null}},vertexShader:s(65697),fragmentShader:s(10385)}};var Z=s(3157);const q=new r.Matrix4;function K(e){const t=new r.WebGLCubeRenderTarget(e,{format:r.RGBAFormat,generateMipmaps:!1,depthBuffer:!1,stencilBuffer:!1});return t.texture.image={},t.texture.image.width=e,t.texture.image.height=e,t}class BlurRenderTarget{constructor(e,t,s){this.inputSize=e,this.outputSize=t,this.sigma=s,this.input=K(e),this.output=K(t)}get texture(){return this.output.texture}}class BlurOverlayRenderer{constructor(e,t){this.renderToTexture=e,this.renderer=t,this.renderTarget=new r.WebGLCubeRenderTarget(2048,{format:r.RGBAFormat,generateMipmaps:!1,depthBuffer:!1,stencilBuffer:!1}),this.camera=new r.Camera,this.blurRTs=Z.TW.map((e=>((e,t,s)=>{const i=new BlurRenderTarget(e,t,s);return{renderTarget:i,cubeCamera:new r.CubeCamera(.1,1e3,i.output)}})(e.size,2*e.size,e.sigma))),this.debug={};const s=r.UniformsUtils.clone($.combineBlurs.uniforms);this.material=new r.RawShaderMaterial({fragmentShader:$.combineBlurs.fragmentShader,vertexShader:$.combineBlurs.vertexShader,uniforms:s,side:r.DoubleSide,name:"CubemapRendererMaterial"}),this.mesh=new r.Mesh(new r.BoxBufferGeometry(100,100,100),this.material),this.material.uniforms.panoBlurredMap0.value=this.blurRTs[0].renderTarget.texture,this.material.uniforms.panoBlurredMap1.value=this.blurRTs[1].renderTarget.texture,this.material.uniforms.panoBlurredMap2.value=this.blurRTs[2].renderTarget.texture,this.material.uniforms.panoBlurredMap3.value=this.blurRTs[3].renderTarget.texture,this.renderTarget.texture.image={},this.renderTarget.texture.image.height=2048,this.renderTarget.texture.image.width=2048}setDebug(e,t){t?this.debug[e]=!0:this.debug[e]&&delete this.debug[e],this.material.defines=this.debug,this.material.needsUpdate=!0,this.render()}render(){this.renderToTexture.render(this.renderTarget,this.mesh,this.camera)}get texture(){return this.renderTarget.texture}setMaskTexture(e,t=q){this.material.uniforms.maskTexture.value=e,this.material.uniforms.maskMatrix.value.copy(t)}setPano(e,t,s=q,i=q){if(e!==this.currentSweepId||this.currentPanoTexture!==t){this.currentSweepId=e,this.currentPanoTexture=t;for(const e of this.blurRTs){const s=e.renderTarget,i=.5/s.input.width;this.renderer.copyCubemap(t,s.input),this.renderer.blurCubemap(s.input.texture,e.cubeCamera,s.sigma,i)}this.material.uniforms.panoMatrix1.value.copy(s),this.material.uniforms.panoMatrix2.value.copy(i)}}reset(){this.currentSweepId=null,this.currentPanoTexture=null}}class BrushMaterial extends r.RawShaderMaterial{constructor(e,t,s,i){const a=r.UniformsUtils.clone($.brush.uniforms);a.radius.value.copy(e),a.feather.value.copy(t),a.opacity.value.copy(s),a.color.value.set(1,0,0),super(Object.assign(Object.assign({},i),{fragmentShader:$.brush.fragmentShader,vertexShader:$.brush.vertexShader,uniforms:a,side:r.FrontSide,transparent:!0,blending:r.AdditiveBlending,name:"brushMaterial"}))}get color(){return this.uniforms.color.value}set color(e){this.uniforms.color.value=e}}var Y=s(19945),J=s(62029);const X=new r.Color(16711680),ee=new r.Color(65280),te=new r.Color(255);class BlurRenderer{constructor(e,t,s,i,a,n,o){this.sweepData=e,this.blurEditorData=t,this.scene=s,this.input=i,this.panoRenderer=o,this.root=new r.Group,this.meshes={},this.maskRenderTarget=new r.WebGLCubeRenderTarget(1024,{format:r.RGBAFormat,generateMipmaps:!1}),this.maskCamera=new r.Camera,this.maskBackground=new r.Mesh(new r.BoxGeometry(10,10,10),new r.MeshBasicMaterial({color:0,side:r.DoubleSide})),this.maskVisible=!1,this.dirty=!0,this.updating=!1,this.bindings=[],this.blurs=[],this.renderBlurredOverlay=(()=>{const e=new r.Matrix4,t=new r.Matrix4,s=new r.Quaternion;return async i=>{this.maskCamera.position.copy(i.position),this.maskBackground.position.copy(i.position),await this.engine.commandBinder.issueCommand(new Q.sp(this.maskRenderTarget,this.root,this.maskCamera));const a=this.maskRenderTarget.texture,n=this.panoRenderer.useTexture(i.id);e.makeRotationFromQuaternion(s.copy(i.rotation).invert()),t.makeScale(-1,1,1),this.overlayRenderer.setPano(i.id,n,e,t),this.overlayRenderer.setMaskTexture(a),this.overlayRenderer.render(),this.panoRenderer.freeTexture(i.id),await this.engine.after(z.A.Begin),await this.engine.commandBinder.issueCommand(new H.M(i.id,this.overlayRenderer.texture,new r.Quaternion))}})(),this.currentSweep=this.sweepData.currentSweepObject||null,this.overlayRenderer=new BlurOverlayRenderer(a,n)}setBlurs(e){this.blurs!==e&&(this.blurs=e,this.dirty=!0)}init(){this.root.add(this.maskBackground)}async activate(e){const[t]=await Promise.all([e.getModuleBySymbol(l.y.SETTINGS)]);this.engine=e,this.meshes={},this.bindings.push(this.blurEditorData.onChanged((()=>this.dirty=!0)),e.subscribe(W.Z,(e=>{this.currentSweep=this.sweepData.getSweep(e.toSweep),this.dirty=!0})),e.subscribe(J.Xq,(()=>{this.overlayRenderer.reset(),this.currentSweep&&this.renderBlurredOverlay(this.currentSweep)}))),t.registerButton("Blur Debug","Toggle blur level coloration",(()=>{this.overlayRenderer.setDebug("DEBUG_BLUR_COLORS",!this.overlayRenderer.debug.DEBUG_BLUR_COLORS),this.currentSweep&&this.renderBlurredOverlay(this.currentSweep)})),t.registerButton("Blur Debug","Toggle blur test",(()=>{this.overlayRenderer.setDebug("DEBUG_BLUR_LEVELS",!this.overlayRenderer.debug.DEBUG_BLUR_LEVELS),this.currentSweep&&this.renderBlurredOverlay(this.currentSweep)})),this.maskRenderTarget.texture.image={},this.maskRenderTarget.texture.image.width=1024,this.maskRenderTarget.texture.image.height=1024}dispose(){this.root.traverse((e=>{e instanceof r.Mesh&&e.geometry.dispose()}))}render(){this.dirty&&!this.updating&&(this.updating=!0,this.dirty=!1,this.update().finally((()=>{this.updating=!1})))}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0}getBlursForSweep(e){return this.blurs.filter((t=>t.sweepId===e))}async update(){var e,t;if(!this.currentSweep)return;const s=this.currentSweep,a=this.getBlursForSweep(s.id),n={};for(const e of a)for(const[t,s]of e.dots.entries())n[`${e.id}-${t}`]=s;let o=!1;for(const e in this.meshes){const t=this.meshes[e];n[e]&&n[e].directions.length===t.count||(this.root.remove(t),this.input.unregisterMesh(t),delete this.meshes[e],o=!0)}const l=new r.Vector3,d=new r.Vector3,u=new r.Vector3,c=new r.Matrix4,h=new r.Vector3;for(const e of a)for(const[t,i]of e.dots.entries()){const a=`${e.id}-${t}`;if(0===i.directions.length||this.meshes[a])continue;l.set(i.radius,i.radius-i.feather,i.radius),d.set(i.feather,i.feather,i.feather),u.set(i.strength,1,i.strength);const n=new BrushMaterial(l,d,u,{defines:{USE_INSTANCING:!0},depthTest:!1,depthWrite:!1}),r=new BlurMesh((0,Y.fc)(),n,i.directions.length);r.blurId=e.id,i.directions.forEach(((e,t)=>{const a=2*(i.radius+i.feather),n=se(e,s);c.lookAt(s.position,n,x.f.UP),c.scale(h.set(a,a,a)),c.setPosition(n),r.setMatrixAt(t,c)})),this.meshes[a]=r,this.root.add(r),this.input.registerMesh(r,!1),o=!0}const g=new r.Color,{toolState:m,selectedBlur:p,hoveredBlur:b}=this.blurEditorData;for(const s in this.meshes){const a=this.meshes[s],n=a.material;g.copy(X);let r=_.z.reticule+.1;const l=null===(e=null==b?void 0:b.editable)||void 0===e||e,d=null===(t=null==p?void 0:p.editable)||void 0===t||t;m!==i.PAINTING&&(l&&a.blurId===(null==b?void 0:b.id)&&(g.add(te),r=_.z.reticule+.2),d&&a.blurId===(null==p?void 0:p.id)&&(g.add(ee),r=_.z.reticule+.3)),n.color.equals(g)&&a.renderOrder===r||(n.color.copy(g),a.renderOrder=r,o=!0)}o&&await this.renderBlurredOverlay(s)}setMaskVisibility(e){this.maskVisible!==e&&(e?this.scene.add(this.root):this.scene.remove(this.root),this.maskVisible=e)}}function se(e,t){const s=e.clone().applyQuaternion(t.rotation).normalize();return t.position.clone().add(s)}var ie=s(35424),ae=s(98254),ne=s(66910);class BlurEditorState extends ae.T{constructor(){super(...arguments),this.selected=!1,this.hovered=!1}}class BlurEditorInteractions extends ae.T{constructor(){super(...arguments),this.openedTool=!1,this.createdBlur=!1}}class BlurEditorData extends ie.V{constructor(){super(...arguments),this.name="blur-editor",this.toolState=i.IDLE,this.brushCursorVisibility=!1,this.interactions=new BlurEditorInteractions,this.showMouseCursor=!1,this.states=new ne.v,this._selectedBlur=null,this._hoveredBlur=null}getState(e){let t=this.states.get(e);return t||(t=new BlurEditorState,this.states.set(e,t)),t}get selectedBlur(){return this._selectedBlur}set selectedBlur(e){if(this.selectedBlur===e)return;const t=this.selectedBlur;if(this._selectedBlur=e,this.commit(),e){const t=this.getState(e.id);t.selected=!0,t.commit()}if(t){const e=this.getState(t.id);e.selected=!1,e.commit()}}onSelectedBlurChanged(e){return this.onPropertyChanged("_selectedBlur",e)}get hoveredBlur(){return this._hoveredBlur}set hoveredBlur(e){if(this.hoveredBlur===e)return;const t=this.hoveredBlur;if(this._hoveredBlur=e,this.commit(),e){const t=this.getState(e.id);t.hovered=!0,t.commit()}if(t){const e=this.getState(t.id);e.hovered=!1,e.commit()}}onHoveredBlurChanged(e){return this.onPropertyChanged("_hoveredBlur",e)}}var re=s(56709),oe=s(19926),le=s(43985),de=s(78114),ue=s(60649),ce=s(56044),he=s(14279),ge=s(18253),me=s(65453),pe=s(24486),be=s(73156),Se=s(6058),fe=s(88337);class BlurToolManager{constructor(e,t){this.engine=e,this.settingsData=t,this.initialized=!1,this.toggledAssets={[he.U]:!1,[ge.re]:!1,[be.Mp]:!1,[me.Nj]:!1,[pe.s]:!1},this.settingsToggler=new Se.u(this.settingsData,this.toggledAssets)}async activate(){if(!this.initialized){this.initialized=!0;const{market:e}=this.engine,[t,s,i,a,n]=await Promise.all([e.waitForData(b.f),e.waitForData(BlurEditorData),e.waitForData(ce.c),e.waitForData(ue.D),e.waitForData(T.O)]),r=new fe.Q(t.blurs);r.sort(((e,t)=>e.index-t.index)),r.priority=fe.K.LOW,this.dataMap={blurData:t,blurEditorData:s,blurList:r,floorsViewData:i,settings:this.settingsData,sweepViewData:a,viewmodeData:n}}this.settingsToggler.toggle(!0),this.toggleBlurTool(i.IDLE)}async deactivate(){this.settingsToggler.toggle(!1),this.toggleBlurTool(i.OFF)}async toggleBlurTool(e){this.engine.commandBinder.issueCommand(new BlurToolChangeCommand(e))}}var ve=s(10854),Be=s(12622),Ce=s(83233),Te=s(19387),we=s(58843),ye=s(53100),Ee=s(15032),xe=s(4254),Ie=s(71907);const{SUGGESTIONS:De}=ve.Z.WORKSHOP;class BlurToolManager_BlurToolManager{constructor(e,t){this.engine=e,this.settingsData=t,this.initialized=!1,this.toggledAssets={[he.U]:!1,[ge.re]:!1,[be.Mp]:!1,[me.Nj]:!1,[pe.s]:!1},this.navigateToNextSuggestion=(e,t)=>{let s;for(let i=0;i<e.length;i++){const a=e[i],n=a.items.indexOf(t);if(-1!==n){const t=n+1;t<a.items.length?s=a.items[t]:e[i+1]&&e[i+1].items.length&&(s=e[i+1].items[0]);break}}s&&this.engine.commandBinder.issueCommand(new NavigateToBlurCommand(s,!1))},this.debouncedNavigateToNextSuggestion=(0,Ce.D)(this.navigateToNextSuggestion,500),this.settingsToggler=new Se.u(this.settingsData,this.toggledAssets)}async activate(){var e;if(!this.initialized){this.initialized=!0;const{market:e}=this.engine,[t,s,i,a,n]=await Promise.all([e.waitForData(b.f),e.waitForData(BlurEditorData),e.waitForData(ce.c),e.waitForData(ue.D),e.waitForData(T.O)]),r=new fe.Q(t.blurs);let o,l;r.sort(((e,t)=>e.index-t.index)),r.priority=fe.K.LOW,this.settingsData.tryGetProperty(ye.M,!1)?(o=await e.waitForData(Te.a),l=new fe.Q(o.suggestions),l.setFilter("accepted",(e=>null===e.accepted)),l.sort(((e,t)=>t.index-e.index))):l=new fe.Q(new ne.v),this.dataMap={blurData:t,blurEditorData:s,blurList:r,floorsViewData:i,settings:this.settingsData,suggestionData:o,suggestionList:l,sweepViewData:a,viewmodeData:n}}const t=null===(e=this.dataMap.sweepViewData.data.currentSweepObject)||void 0===e?void 0:e.isAligned(),s=this.dataMap.viewmodeData.canStartTransition()&&this.dataMap.viewmodeData.currentMode!==w.Ey.Panorama;s&&!t&&await this.engine.commandBinder.issueCommand(new Be._i(Be.BD.INSIDE)),this.settingsToggler.toggle(!0),this.toggleBlurTool(i.IDLE),s&&t&&await this.engine.commandBinder.issueCommand(new Be._i(Be.BD.INSIDE))}async deactivate(){this.settingsToggler.toggle(!1),this.toggleBlurTool(i.OFF)}async toggleBlurTool(e){this.engine.commandBinder.issueCommand(new BlurToolChangeCommand(e))}async rejectAllSuggestions(){const{suggestionData:e}=this.dataMap;if(!e)return!1;const t=e.getByAccepted(null).map((e=>e.id));if(!t.length)return!1;const s=(0,Ee.P)(t.length,De.TYPE);return await this.engine.commandBinder.issueCommand(new Ie.Q(Ie.f.DISPLAY,s))!==xe.U.CLOSE&&(this.engine.commandBinder.issueCommand(new we.oA(...t)),!0)}}var ke=s(85893),Oe=s(67294),Re=s(61068),Pe=s(94184),Le=s.n(Pe),_e=s(60405),Ne=s(57340),Ae=s(87982),Me=s(61445),Ge=s(56759);class ActionBar extends Oe.Component{addChildClasses(e){return!!e&&(0,Oe.cloneElement)(e,{className:`action-bar-item ${e.props.className||""}`})}render(){const{children:e}=this.props;return(0,ke.jsx)("div",Object.assign({className:"action-bar"},{children:Oe.Children.map(e,this.addChildClasses)}))}}var Ue,je=s(2252);!function(e){e.size="size",e.scale="scale",e.feather="feather",e.pressure="pressure",e.opacity="opacity",e.state="state"}(Ue||(Ue={}));var Fe=function(e,t,s,i){var a,n=arguments.length,r=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,s,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(r=(n<3?a(r):n>3?a(t,s,r):a(t,s))||r);return n>3&&r&&Object.defineProperty(t,s,r),r};const{BLURS:Ve}=ve.Z.WORKSHOP;var ze;!function(e){e.CREATE="create",e.BRUSH_SIZE="brushsize"}(ze||(ze={}));let He=class BlurToolOverlay extends Oe.Component{constructor(e){super(e),this.bindings=[],this.onToolStateChange=e=>{let{creating:t}=this.state;e===i.IDLE?t=!1:e===i.PAINTING&&(t=!0),this.setState({toolState:e,creating:t})},this.onBrushStateChange=e=>{this.setState({brushState:e})},this.onSelectedBlurChange=e=>{this.setState({selectedBlur:e})},this.onBrushSizeChange=e=>{const t=Math.round((0,I.et)(e,0,1,1,100));this.setState({brushSize:t})},this.onBrushSizeSliderChange=e=>{const{commandBinder:t}=this.context;this.dismissTooltip(ze.BRUSH_SIZE);const s=(0,I.et)(e,1,100,0,1);t.issueCommand(new SetBlurBrushScaleCommand(s))},this.onDeleteClick=async()=>{const{toolState:e}=this.state;await this.deleteSelectedBlur(),e===i.PAINTING&&this.context.commandBinder.issueCommand(new BlurToolChangeCommand(i.IDLE))},this.onCreateClick=()=>{this.dismissTooltip(ze.CREATE);let e=i.IDLE;this.state.toolState===i.IDLE&&(e=i.PAINTING),this.context.commandBinder.issueCommand(new BlurToolChangeCommand(e))},this.dismissTooltip=e=>{const t=Object.assign({},this.state.showTooltips);t[e]=!1,this.setState({showTooltips:t})};const{viewmodeData:t}=this.props.manager.dataMap;this.state={toolState:i.IDLE,brushState:n.DISABLED,viewmode:t.currentMode,brushSize:20,selectedBlur:null,showHints:!0,creating:!1,showTooltips:{[ze.CREATE]:!0,[ze.BRUSH_SIZE]:!0}}}componentDidMount(){const{blurEditorData:e,viewmodeData:t}=this.props.manager.dataMap;this.bindings.push(e.onPropertyChanged("toolState",this.onToolStateChange),e.onSelectedBlurChanged(this.onSelectedBlurChange),e.brush.onPropertyChanged(Ue.scale,this.onBrushSizeChange),e.brush.onPropertyChanged(Ue.state,this.onBrushStateChange),e.interactions.onPropertyChanged("createdBlur",(()=>{this.setState({showHints:!1})})),t.makeModeChangeSubscription((e=>{this.setState({viewmode:e})}))),this.onBrushSizeChange(e.brush.scale)}componentWillUnmount(){for(const e of this.bindings)e.cancel();this.bindings=[]}deleteSelectedBlur(){const{selectedBlur:e}=this.state,{commandBinder:t}=this.context;if(!e)throw new Error("Cannot delete, no Blur selected");t.issueCommand(new m.TL(e.id))}renderBrushControls(){const{brushSize:e,toolState:t}=this.state;return t!==i.PAINTING?null:(0,ke.jsxs)("div",Object.assign({className:"brush-controls"},{children:[this.renderBrushSizeTooltip(),(0,ke.jsx)("div",Object.assign({className:"brush-size-control"},{children:(0,ke.jsx)(Re.ZP,{min:1,max:100,step:1,included:!0,dots:!1,value:e,onChange:this.onBrushSizeSliderChange})}))]}))}renderOverlayMessage(){const{locale:e}=this.context,{toolState:t,showHints:s}=this.state;if(!s||t!==i.PAINTING)return null;const a=e.t((0,je.Jm)()?Ve.OVERLAY_MESSAGE_TOUCH:Ve.OVERLAY_MESSAGE);return(0,ke.jsxs)("div",Object.assign({className:"overlay-message"},{children:[(0,ke.jsx)("div",{className:"icon icon-brush-outline"}),(0,ke.jsx)("span",Object.assign({className:"message"},{children:a}))]}))}renderCreateTooltip(){const{showTooltips:e}=this.state;if(!e[ze.CREATE])return null;const t=this.context.locale.t(Ve.CREATE_TOOLTIP_TITLE),s=this.context.locale.t(Ve.CREATE_TOOLTIP_MESSAGE);return(0,ke.jsx)(Ge.u,{className:"tooltip-simple-medium",open:!0,closeButton:!0,title:t,onClose:()=>this.dismissTooltip(ze.CREATE),message:(0,ke.jsx)("div",Object.assign({className:"message"},{children:s})),arrowPos:Ge.x.BOTTOM_CENTER})}renderBrushSizeTooltip(){const{showTooltips:e}=this.state;if(!e[ze.BRUSH_SIZE])return null;const t=this.context.locale.t(Ve.BRUSH_TOOLTIP_TITLE),s=this.context.locale.t(Ve.BRUSH_TOOLTIP_MESSAGE);return(0,ke.jsx)(Ge.u,{className:"tooltip-simple-medium",open:!0,closeButton:!0,title:t,onClose:()=>this.dismissTooltip(ze.BRUSH_SIZE),message:(0,ke.jsx)("div",Object.assign({className:"message"},{children:s})),arrowPos:Ge.x.BOTTOM_CENTER})}render(){const{locale:e}=this.context,{brushState:t,toolState:s,selectedBlur:a,viewmode:r}=this.state,o=s===i.PAINTING&&a?"icon-checkmark":"icon-plus",l=Me.BN.ENABLED,d=r===w.Ey.Panorama?Me.BN.ENABLED:Me.BN.DISABLED,u=Le()("overlay-cta-btn",{"overlay-cta-cancel":s===i.PAINTING&&!a}),c=Le()("overlay blur-tool-overlay",{painting:t===n.PAINTING}),h=s===i.SUGGESTING,g=a&&e.t(h?Ve.SUGGESTED_BLUR:Ve.DEFAULT_BLUR_NAME,{number:a.index});return(0,ke.jsxs)("div",Object.assign({className:c},{children:[a&&(0,ke.jsx)("div",Object.assign({className:"overlay-top-center"},{children:(0,ke.jsx)("div",Object.assign({className:"overlay-info"},{children:g}))})),!h&&(0,ke.jsxs)(ke.Fragment,{children:[this.renderOverlayMessage(),(0,ke.jsxs)(ActionBar,{children:[(0,ke.jsxs)("div",Object.assign({className:"overlay-cta"},{children:[this.renderCreateTooltip(),(0,ke.jsx)(Ae.hU,{className:u,iconClass:o,buttonStyle:Ae.Dd.PRIMARY,buttonState:d,onClick:this.onCreateClick}),a&&a.editable&&(0,ke.jsx)(Ae.hU,{className:"overlay-cta-button-outer",buttonStyle:Ae.Dd.OVERLAY,iconClass:"icon-delete",buttonState:l,onClick:this.onDeleteClick})]})),this.renderBrushControls()]})]})]}))}};He.contextType=_e.I,He=Fe([Ne.Z],He);var Qe=s(46317),We=s(14374);var $e,Ze=s(41345),qe=s(54119),Ke=s(13855),Ye=s(34506);!function(e){e.SCANS="scans",e.FLOORS="floors"}($e||($e={}));const{BLURS:Je}=ve.Z.WORKSHOP,Xe=({value:e,onChange:t})=>{const s=(0,Ze.b)(),i=[{text:s.t(Je.BLUR_STATUS_ALL),value:"all",selected:"all"===e},{text:s.t(Je.BLUR_STATUS_PENDING),value:S.Q.PENDING,selected:e===S.Q.PENDING},{text:s.t(Je.BLUR_STATUS_APPLIED),value:S.Q.APPLIED,selected:e===S.Q.APPLIED},{text:s.t(Je.BLUR_STATUS_FAILED),value:S.Q.FAILED,selected:e===S.Q.FAILED}];return(0,ke.jsx)(Ye.S,{className:"blur-filter blur-filter-status",menuStyle:Ye.K.DROPDOWN,onChange:t,options:i,placeholder:s.t(Je.STATUS)})},et=({value:e,onChange:t})=>{const s=(0,Ze.b)(),i=[{text:s.t(Je.GROUP_BY_SCAN),value:$e.SCANS,selected:e===$e.SCANS},{text:s.t(Je.GROUP_BY_FLOOR),value:$e.FLOORS,selected:e===$e.FLOORS}];return(0,ke.jsx)(Ye.S,{className:"blur-filter blur-filter-groupby",menuStyle:Ye.K.DROPDOWN,onChange:t,options:i,placeholder:s.t(Je.GROUP_BY)})},tt=({value:e,onChange:t})=>{const s=(0,Ze.b)(),i=[{text:s.t(Je.SORT_CREATED_DESC),value:"CREATED_DESC",selected:"CREATED_DESC"===e},{text:s.t(Je.SORT_CREATED_ASC),value:"CREATED_ASC",selected:"CREATED_ASC"===e}];return(0,ke.jsx)(Ye.S,{className:"blur-filter blur-filter-sort",menuStyle:Ye.K.DROPDOWN,onChange:t,options:i,placeholder:s.t(Je.SORT)})};var st=s(80312),it=s(25379),at=s(20302);const nt=(0,at.u)(BlurEditorData);function rt(){const[e,t]=(0,Oe.useState)(null),s=nt();return(0,Oe.useEffect)((()=>{const e=[];return s&&(e.push(s.onSelectedBlurChanged((e=>t(e)))),t(s.selectedBlur)),()=>{e.forEach((e=>e.cancel()))}}),[s]),e}function ot(){const[e,t]=(0,Oe.useState)(null),s=nt();return(0,Oe.useEffect)((()=>{const e=[];return s&&(e.push(s.onHoveredBlurChanged((e=>t(e)))),t(s.hoveredBlur)),()=>{e.forEach((e=>e.cancel()))}}),[s]),e}const{BLURS:lt}=ve.Z.WORKSHOP;function dt({blur:e}){const{commandBinder:t}=(0,Oe.useContext)(_e.I),s=nt(),i=rt(),a=ot(),n=(0,Ze.b)(),r=(0,st.z)(),o=(0,Oe.useCallback)((()=>{t.issueCommand(new NavigateToBlurCommand(e,!0))}),[t,e]),l=(0,Oe.useCallback)((s=>{const i=e.visible;s.stopPropagation(),i?t.issueCommand(new HideBlursCommand(e.id)):t.issueCommand(new ShowBlursCommand(e.id)),r.trackToolGuiEvent("blur","blur_list_click_"+(i?"hide":"show"))}),[t,e,r]),d=(0,Oe.useCallback)((()=>{t.issueCommand(new m.TL(e.id)),r.trackToolGuiEvent("blur","blur_list_click_delete")}),[t,e,r]),u=(0,Oe.useCallback)((()=>{s&&(s.hoveredBlur=e)}),[e,s]),c=(0,Oe.useCallback)((()=>{s&&(s.hoveredBlur=null)}),[s]),h=(0,ke.jsxs)("span",{children:[n.t(lt.DEFAULT_BLUR_NAME,{number:e.index}),e.status!==S.Q.PENDING&&(0,ke.jsx)("span",Object.assign({className:"blur-status"},{children:e.status}))]}),g=(0,ke.jsxs)(qe.hE,{children:[e.status!==S.Q.APPLIED&&(0,ke.jsx)(qe.zx,{icon:e.visible?"eye-show":"eye-hide",onClick:l}),(0,ke.jsx)(it.n,{id:e.id,disabled:!e.editable,menu:[[lt.DELETE_BLUR_CTA,d]],closeOnMenuItemClick:!0,accordion:!0})]}),p=Le()("blur-list-item",{active:i&&i.id===e.id},{hover:a&&a.id===e.id});return(0,ke.jsx)(qe.HC,{className:p,onClick:o,onMouseEnter:u,onMouseLeave:c,actions:g,title:h})}const ut="other",{BLURS:ct,SCANS:ht,VIEWS_360:gt}=ve.Z.WORKSHOP;function mt(e,t){const[s,i]=(0,Oe.useState)($e.SCANS),[a,n]=(0,Oe.useState)([]),r=(0,Ze.b)(),o=(0,Oe.useCallback)((()=>{const{sweepViewData:s}=t.dataMap,i=s.getAlignedSweeps(!1),a={};if(e){const t=e.groupBy("sweepId");for(const e in t){const n=s.getSweep(e);let o=r.t(ht.LIST_ITEM_TEXT,n.index+1);if(!n.isAligned()){const e=i.findIndex((e=>e.id===n.id))||0;o=n.name||r.t(gt.DEFAULT_NAME,{index:e+1})}a[e]={id:`sweep-${n.id}`,data:n,title:o,items:t[e]}}}return a}),[e,r,t.dataMap]),l=(0,Oe.useCallback)((()=>{const{floorsViewData:s}=t.dataMap,i={};if(e){const t=e.groupBy("floorId");s.floors.iterate((e=>{i[e.id]={id:e.id,data:e,title:e.name,items:t[e.id]||[]}})),t.null&&(i.other={id:ut,title:r.t(ct.OTHER_GROUP_LABEL),items:t.null})}return i}),[e,r,t.dataMap]),d=(0,Oe.useCallback)((()=>{const e=s===$e.SCANS?o():l(),t=Object.values(e).sort(((e,t)=>e.title.localeCompare(t.title,void 0,{numeric:!0})));n(t)}),[o,l,s]);return(0,Oe.useEffect)((()=>{const t=[e.onChanged((()=>{d()}))];return d(),()=>{t.forEach((e=>e.cancel()))}}),[e,s,r,t.dataMap,d]),{groups:a,groupBy:s,setGroupBy:i}}const pt=(0,at.u)(Te.a);const{BLURS:bt}=ve.Z.WORKSHOP;let St=!1;const ft=()=>{const e=function(){const e=pt(),[t,s]=(0,Oe.useState)(0);return(0,Oe.useEffect)((()=>{if(!e)return()=>{};const t=()=>{s(e.getByAccepted(null).length)},i=e.onChanged(t);return t(),()=>i.cancel()}),[e]),t}(),{commandBinder:t}=(0,Oe.useContext)(_e.I),s=(0,Ze.b)(),a=(0,st.z)(),n=(0,Oe.useCallback)((()=>{a.trackToolGuiEvent("blur","blur_click_view_suggestions"),t.issueCommand(new BlurToolChangeCommand(i.SUGGESTING))}),[t,a]);if(!e)return null;const r=s.t(bt.SUGGESTIONS_AVAILABLE_MESSAGE,e),o=(0,ke.jsxs)(qe.zx,Object.assign({size:qe.qE.SMALL,variant:qe.Wu.SECONDARY,onClick:n,theme:"dark"},{children:[(0,ke.jsx)(qe.o3,{theme:"dark"}),(0,ke.jsx)("span",{children:s.t(bt.VIEW_SUGGESTIONS)})]}));return St||(St=!0,a.trackToolGuiEvent("blur","blur_suggestions_banner_shown")),(0,ke.jsx)(qe.jL,{layout:"horizontal",text:r,actions:o,className:"blur-list-banner"})};var vt=s(57599);const{BLURS:Bt}=ve.Z.WORKSHOP,Ct=({group:e})=>{const{id:t,title:s,items:i}=e;return(0,ke.jsx)(vt.u,{group:{name:s,id:t,items:i}})},Tt=({group:e})=>{const{id:t,title:s,items:i}=e;return(0,ke.jsx)(qe._m,{id:t,title:`${s} (${i.length})`})},wt=({item:e})=>{const t=(0,Ze.b)();if(!e){const e=t.t(Bt.MULTI_FLOOR_EMPTY_MESSAGE);return(0,ke.jsx)(qe.gQ,{message:e})}return(0,ke.jsx)(dt,{blur:e})},yt=({className:e="",manager:t})=>{const{blurList:s}=t.dataMap,i=(0,Ze.b)(),a=(0,st.z)(),[n,r]=(0,Oe.useState)(null),{groups:o,groupBy:l,setGroupBy:d}=mt(s,t),u=(0,Oe.useCallback)((e=>{(0,Ke.p)(S.Q,e)?s.setFilter("status",(t=>t.status===e)):s.clearFilter("status"),null!==e&&a.trackToolGuiEvent("blur",`blur_list_filter_by_${e}`),r(e)}),[s,a]),[c,h]=(0,Oe.useState)(null),g=(0,Oe.useCallback)((e=>{switch(e){case"CREATED_DESC":s.sort(((e,t)=>e.created.getTime()-t.created.getTime()||e.index-t.index));break;case"CREATED_ASC":s.sort(((e,t)=>t.created.getTime()-e.created.getTime()||t.index-e.index))}null!==e&&a.trackToolGuiEvent("blur",`blur_list_sort_by_${e.toLowerCase()}`),h(e)}),[s,a]),m=(0,Oe.useCallback)((e=>{a.trackToolGuiEvent("blur",`blur_list_group_by_${e.toLowerCase()}`),d(e)}),[d,a]),p=Le()(e,"blur-list"),b=i.t(Bt.NO_BLURS);return(0,ke.jsxs)("div",Object.assign({className:p},{children:[(0,ke.jsxs)("header",Object.assign({className:"blur-list-header"},{children:[(0,ke.jsx)(ft,{}),(0,ke.jsxs)(qe.w0,{children:[(0,ke.jsx)(et,{value:l,onChange:m}),(0,ke.jsx)(Xe,{value:n,onChange:u}),(0,ke.jsx)(tt,{value:c,onChange:g})]})]})),(0,ke.jsx)("div",Object.assign({className:"blur-list-content"},{children:0===o.length?(0,ke.jsx)(qe.gQ,{message:b,itemHeight:60}):(0,ke.jsx)(qe.UQ,{data:o,itemHeight:60,renderItem:wt,renderGroup:l===$e.FLOORS?Ct:Tt})}))]}))};const{BLURS:Et}=ve.Z.WORKSHOP,xt=({suggestion:e,onResolved:t})=>{const{commandBinder:s}=(0,Oe.useContext)(_e.I),i=(0,st.z)(),a=(0,Ze.b)(),n=nt(),r=ot(),o=rt(),[l,d]=(0,Oe.useState)(null),u=(0,Oe.useCallback)((()=>{s.issueCommand(new we.rf(e.id)),i.trackToolGuiEvent("blur","blur_suggestion_list_click_accept"),t(e,!0)}),[i,s,e,t]),c=(0,Oe.useCallback)((()=>{s.issueCommand(new we.oA(e.id)),i.trackToolGuiEvent("blur","blur_suggestion_list_click_reject"),t(e,!1)}),[i,s,e,t]),h=(0,Oe.useCallback)((e=>{l||(d("accepted"),setTimeout(u,500),e.stopPropagation())}),[u,l]),g=(0,Oe.useCallback)((e=>{l||(d("rejected"),setTimeout(c,500),e.stopPropagation())}),[c,l]),m=(0,Oe.useCallback)((t=>{const a=e.visible;a?s.issueCommand(new we.mA(e.id)):s.issueCommand(new we.ee(e.id)),i.trackToolGuiEvent("blur","blur_suggestion_list_click_"+(a?"hide":"show")),t.stopPropagation()}),[i,s,e]),p={placement:"top"},b=(0,Oe.useCallback)((()=>{n&&(n.hoveredBlur=e)}),[e,n]),S=(0,Oe.useCallback)((()=>{n&&(n.hoveredBlur=null)}),[n]),f=(0,ke.jsxs)(qe.hE,{children:[(0,ke.jsx)(qe.zx,{icon:e.visible?"eye-show":"eye-hide",onClick:m,tooltip:e.visible?a.t(Et.HIDE_LIST_ITEM_TOOLTIP_MESSAGE):a.t(Et.SHOW_LIST_ITEM_TOOLTIP_MESSAGE),tooltipOptions:p}),(0,ke.jsx)(qe.zx,{icon:"checkmark",onClick:h,tooltip:a.t(Et.ACCEPT_SUGGESTION_TOOLTIP),tooltipOptions:p}),(0,ke.jsx)(qe.zx,{icon:"close",onClick:g,tooltip:a.t(Et.REJECT_SUGGESTION_TOOLTIP),tooltipOptions:p})]}),v=a.t(Et.SUGGESTED_BLUR,{number:e.index}),B=Le()("blur-suggestion-list-item",{active:o&&o.id===e.id,hover:r&&r.id===e.id,accepted:"accepted"===l,rejected:"rejected"===l});return(0,ke.jsx)(qe.HC,{actions:f,className:B,title:v,onClick:()=>{s.issueCommand(new NavigateToBlurCommand(e,!1))},onMouseEnter:b,onMouseLeave:S})},{BLURS:It}=ve.Z.WORKSHOP,Dt=({onClose:e,manager:t})=>{const s=(0,Ze.b)(),i=(0,st.z)(),{commandBinder:a}=(0,Oe.useContext)(_e.I),{suggestionList:n}=t.dataMap,r=(0,Oe.useCallback)((()=>{a.issueCommand(new we.rf),i.trackToolGuiEvent("blur","blur_suggestion_list_click_accept_all"),e()}),[a,e,i]),o=(0,Oe.useCallback)((async()=>{await t.rejectAllSuggestions()&&(i.trackToolGuiEvent("blur","blur_suggestion_list_click_reject_all"),e())}),[t,e,i]);if(!(null==n?void 0:n.length))return null;const l=n.length,d=s.t(It.SUGGESTIONS_FOUND_MESSAGE,l),u=(0,ke.jsxs)(qe.hE,Object.assign({spacing:"small"},{children:[(0,ke.jsx)(qe.zx,{variant:qe.Wu.PRIMARY,size:qe.qE.SMALL,onClick:r,label:s.t(It.ACCEPT_ALL_SUGGESTIONS),theme:"dark"}),(0,ke.jsx)(qe.zx,{variant:qe.Wu.TERTIARY,size:qe.qE.SMALL,onClick:o,label:s.t(It.REJECT_ALL_SUGGESTIONS),theme:"dark"})]}));return(0,ke.jsx)("div",Object.assign({className:"suggestion-list-header"},{children:(0,ke.jsx)(qe.jL,{text:d,actions:u})}))},{BLURS:kt}=ve.Z.WORKSHOP,Ot=({group:e})=>{const{id:t,title:s,items:i}=e;return(0,ke.jsx)(qe._m,{id:t,title:`${s} (${i.length})`})},Rt=({group:e})=>{const{id:t,title:s,items:i}=e;return(0,ke.jsx)(vt.u,{group:{name:s,id:t,items:i}})},Pt=({item:e,onResolved:t})=>{const s=(0,Ze.b)();if(!e){const e=s.t(kt.NO_SUGGESTIONS_ON_FLOOR);return(0,ke.jsx)(qe.gQ,{message:e})}return(0,ke.jsx)(xt,{suggestion:e,onResolved:t})},Lt=({className:e,manager:t,onClose:s})=>{const{suggestionList:i}=t.dataMap,a=(0,st.z)(),n=(0,Ze.b)(),{groups:r,groupBy:o,setGroupBy:l}=mt(i,t),d=(0,Oe.useCallback)((e=>{a.trackToolGuiEvent("blur",`blur_suggestion_list_group_by_${e.toLowerCase()}`),l(e)}),[a,l]),u=(0,Oe.useCallback)(((e,s)=>{t.debouncedNavigateToNextSuggestion(r,e)}),[t,r]);if(!i)return null;const c=Le()(e,"suggestion-list"),h=n.t(kt.NO_SUGGESTIONS);return(0,ke.jsxs)("div",Object.assign({className:c},{children:[(0,ke.jsxs)("header",Object.assign({className:"suggestion-list-header"},{children:[(0,ke.jsx)(Dt,{manager:t,onClose:s}),(0,ke.jsx)(qe.w0,{children:(0,ke.jsx)(et,{value:o,onChange:d})})]})),(0,ke.jsx)("div",Object.assign({className:"suggestion-list-content"},{children:0===r.length?(0,ke.jsx)(qe.gQ,{message:h,itemHeight:42}):(0,ke.jsx)(qe.UQ,{data:r,itemHeight:42,renderItem:Pt,renderItemProps:{onResolved:u},renderGroup:o===$e.FLOORS?Rt:Ot})}))]}))},{BLURS:_t}=ve.Z.WORKSHOP;function Nt({manager:e,className:t}){const s=function(e){const t=(0,We.N)();return(0,Oe.useEffect)((()=>{t();const s=e.onChanged(t);return()=>{s.cancel()}}),[e,t]),e}(e.dataMap.blurList),{commandBinder:a,toolsData:n}=(0,Oe.useContext)(_e.I),r=(0,Ze.b)(),o=function(){const e=nt(),[t,s]=(0,Oe.useState)(i.OFF);return(0,Oe.useEffect)((()=>{const t=[];if(e){const i=()=>{s(e.toolState)};t.push(e.onPropertyChanged("toolState",i)),i()}return()=>{t.forEach((e=>e.cancel()))}}),[e]),t}()===i.SUGGESTING,l=Le()(t,"blurs-panel"),d=(0,Oe.useCallback)((e=>{const t=o?i.IDLE:i.SUGGESTING;a.issueCommand(new BlurToolChangeCommand(t)),e&&e.stopPropagation()}),[o,a]);let u;return u=o?(0,ke.jsx)(qe.zx,Object.assign({size:qe.qE.LARGE,variant:qe.Wu.TERTIARY,onClick:d,icon:"back"},{children:r.t(_t.CLOSE_SUGGESTIONS)})):r.t(_t.NUM_TYPE,s.length),(0,ke.jsxs)(Qe.L,Object.assign({active:!0,className:l,toolPanelLayout:n.toolPanelLayout,title:u},{children:[o&&(0,ke.jsx)(Lt,{className:"blurs-panel-contents",manager:e,onClose:d}),!o&&(0,ke.jsx)(yt,{className:"blurs-panel-contents",manager:e})]}))}class BlurToolUi{constructor(e,t){this.renderPanel=()=>(0,ke.jsx)(Nt,{manager:this.manager}),this.renderActionBar=()=>(0,ke.jsx)(He,{manager:this.manager}),this.manager=e}}var At=s(97024),Mt=s(44936),Gt=s(58477),Ut=s(14153),jt=s(13729),Ft=s(56278),Vt=s(54787),zt=s(98807),Ht=s(41270);const{BLURS:Qt}=ve.Z.WORKSHOP;class BlurListItem_BlurListItem extends Oe.Component{constructor(e){super(e),this.bindings=[],this.onBlurChanged=()=>{const e=this.getBlur();this.setState({status:e.status,visible:e.visible,editable:e.editable,index:e.index})},this.onSelectedChanged=()=>{const{selected:e}=this.getBlurState();this.setState({selected:e})},this.selectItem=()=>{const{commandBinder:e}=this.context,t=this.getBlur();e.issueCommand(new NavigateToBlurCommand(t,!0))},this.deleteItem=()=>{this.context.commandBinder.issueCommand(new m.TL(this.props.sid))},this.toggleVisibility=e=>{e.stopPropagation(),this.context.commandBinder.issueCommand(new ToggleBlurVisibilityCommand(this.props.sid))};const t=this.getBlur(),s=this.getBlurState();this.state={selected:s.selected,status:t.status,visible:t.visible,editable:t.editable,index:t.index}}componentDidMount(){this.createSubscriptions()}componentDidUpdate(e){e.sid!==this.props.sid&&(this.cancelSubscriptions(),this.createSubscriptions())}componentWillUnmount(){this.cancelSubscriptions()}createSubscriptions(){const e=this.getBlur(),t=this.getBlurState();this.bindings=[e.onChanged(this.onBlurChanged),t.onPropertyChanged("selected",this.onSelectedChanged)];const s={selected:t.selected,status:e.status,visible:e.visible,editable:e.editable,index:e.index};this.setState(s)}cancelSubscriptions(){for(const e of this.bindings)e.cancel()}getBlur(){return this.props.manager.dataMap.blurData.get(this.props.sid)}getBlurState(){return this.props.manager.dataMap.blurEditorData.getState(this.props.sid)}blurStatusToPhraseKey(e){switch(e){case S.Q.PROCESSING:return Qt.BLUR_STATUS_PROCESSING;case S.Q.APPLIED:return Qt.BLUR_STATUS_APPLIED;case S.Q.FAILED:return Qt.BLUR_STATUS_FAILED;case S.Q.PENDING:default:return}}render(){const{locale:e}=this.context,{sid:t,selectMode:s,selectedItems:i,onSelectItem:a,onCheckboxClick:n}=this.props,{visible:r,editable:o,selected:l,status:d,index:u}=this.state,c=o?a:void 0,h=Le()({"accordion-item-with-options":o,"accordion-item-with-toggle":o,"accordion-item-without-toggle":!s}),g=e.t(Qt.DEFAULT_BLUR_NAME,{number:u}),m=this.blurStatusToPhraseKey(d),p=m?e.t(m):"";return(0,ke.jsxs)(Vt.Q,Object.assign({sid:t,enabled:r,selected:l,className:h,onSelect:s?c:this.selectItem},{children:[!s&&(0,ke.jsx)(zt.Z,{id:t,visible:r,showTooltip:Qt.SHOW_LIST_ITEM_TOOLTIP_MESSAGE,hideTooltip:Qt.HIDE_LIST_ITEM_TOOLTIP_MESSAGE,forceDisable:!o,onClick:this.toggleVisibility}),s&&(0,ke.jsx)("div",Object.assign({className:"accordion-checkbox"},{children:(0,ke.jsx)(Ht.X,{enabled:o,checked:i&&i.has(t),id:t,onChange:n,stopPropagation:!0,dataValue:t})})),(0,ke.jsxs)("span",Object.assign({className:"accordion-item-text"},{children:[g,p&&(0,ke.jsx)("span",Object.assign({className:"accordion-item-status"},{children:p}))]})),o&&!s&&(0,ke.jsx)(it.n,{id:t,menu:[[Qt.DELETE_BLUR_CTA,this.deleteItem]],accordion:!0})]}),t)}}BlurListItem_BlurListItem.contextType=_e.I;const{BLURS:Wt}=ve.Z.WORKSHOP;class BlurListGroupComponent extends Oe.Component{constructor(e){super(e),this.bindings=[],this.onFloorChange=()=>{const{currentFloor:e}=this.props.manager.dataMap.floorsViewData;this.state.isCurrentFloor&&e&&e.id!==this.props.group.id&&this.setState({isCurrentFloor:!1}),!this.state.isCurrentFloor&&e&&e.id===this.props.group.id&&this.setState({isCurrentFloor:!0})};const{currentFloor:t}=this.props.manager.dataMap.floorsViewData;this.state={isCurrentFloor:!!t&&t.id===this.props.group.id,sortedItems:BlurListGroupComponent.sortItems(this.props.group.items)}}componentDidMount(){const{floorsViewData:e}=this.props.manager.dataMap;this.bindings.push(e.makeFloorChangeSubscription(this.onFloorChange))}componentWillUnmount(){for(const e of this.bindings)e.cancel()}static sortItems(e){return e.sort(((e,t)=>e.index-t.index))}render(){const{locale:e}=this.context,{isCurrentFloor:t}=this.state,{group:s,manager:i,multiFloor:a}=this.props,n=!a||t,r=e.t(a?Wt.MULTI_FLOOR_EMPTY_MESSAGE:Wt.SINGLE_FLOOR_EMPTY_MESSAGE),o=(0,ke.jsx)(Ft.K,{group:s,multiFloor:a,selectMode:this.props.selectMode,onSelectGroup:this.props.onSelectGroup,isGroupSelected:this.props.isGroupSelected});return(0,ke.jsx)(jt.b,Object.assign({id:s.id,open:n,emptyMessage:r,header:o,collapsible:!0,onExpandChange:this.props.onExpandChange},{children:s.items.map((e=>(0,ke.jsx)(BlurListItem_BlurListItem,{manager:i,sid:e.id,selectMode:this.props.selectMode,selectedItems:this.props.selectedItems,onCheckboxClick:this.props.onCheckboxClick,onSelectItem:this.props.onSelectItem},e.id)))}))}}BlurListGroupComponent.contextType=_e.I;const{BLURS:$t}=ve.Z.WORKSHOP,Zt="other";class BlursList extends Oe.Component{constructor(e){super(e),this.onBlursChanged=()=>{const{blurList:e}=this.props.manager.dataMap;e.length!==this.state.numberOfBlurs&&this.updateList()},this.onBlurProcessingChange=()=>{const{selectMode:e,toggleSelectMode:t}=this.props,{blurData:s}=this.props.manager.dataMap,i=s.hasProcessingBlurs();i&&e&&t(),this.setState({blursApplying:i})},this.onBlurToolStateChange=()=>{const{selectMode:e,toggleSelectMode:t}=this.props,{toolState:s}=this.props.manager.dataMap.blurEditorData;s!==i.IDLE&&e&&t(),this.setState({toolState:s})},this.batchDelete=async()=>{const{selectedItems:e,clearSelected:t}=this.props,{blurData:s}=this.props.manager.dataMap;for(const t of e){if(!s.get(t).editable)return this.alert($t.ALREADY_PROCESSING_ALERT_MESSAGE,$t.ALREADY_PROCESSING_ALERT_TITLE),!1}return this.context.commandBinder.issueCommand(new m.TL(...e)),t(),!0},this.batchToggleVisibility=async()=>{const{selectedItems:e}=this.props;return this.context.commandBinder.issueCommand(new BatchToggleBlurVisibilityCommand(Array.from(e))),!0},this.selectAll=()=>{this.props.onSelectAll(this.state.groups)},this.state={groups:{},renamingItem:null,blursApplying:this.props.manager.dataMap.blurData.hasProcessingBlurs(),toolState:this.props.manager.dataMap.blurEditorData.toolState,numberOfBlurs:this.props.manager.dataMap.blurList.length}}componentDidMount(){const{blurList:e,blurData:t,blurEditorData:s}=this.props.manager.dataMap;this.bindings=new j.V(e.onChanged(this.onBlursChanged),t.makeProcessingSubscription(this.onBlurProcessingChange),s.onPropertyChanged("toolState",this.onBlurToolStateChange)),this.onBlurProcessingChange(),this.updateList()}componentWillUnmount(){this.bindings.cancel()}updateList(){const{locale:e}=this.context,{blurList:t,floorsViewData:s}=this.props.manager.dataMap,i={},a=t.groupBy("floorId");s.floors.iterate((e=>{i[e.id]={id:e.id,name:e.name,items:a[e.id]||[]}})),a.null&&(i.other={id:Zt,name:e.t($t.OTHER_GROUP_LABEL),items:a.null}),this.setState({groups:i,numberOfBlurs:t.length})}alert(e,t=$t.DEFAULT_ALERT_TITLE,s=$t.DEFAULT_ALERT_CONFIRMATION){const{commandBinder:i}=this.context;i.issueCommand(new Ie.Q(Ie.f.DISPLAY,{title:t,message:e,cancellable:!0,confirmPhraseKey:s}))}getListTitle(){const{locale:e}=this.context,{numberOfBlurs:t}=this.state;return e.t($t.NUM_TYPE,t)}renderListTitle(){return(0,ke.jsx)("div",Object.assign({className:"list-panel-title"},{children:this.getListTitle()}))}renderSelectorHeader(){const{batchSelectEnabled:e,selectMode:t,selectedItems:s,toggleSelectMode:a}=this.props,{blursApplying:n,toolState:r}=this.state,o=(null==s?void 0:s.size)>0,l=r!==i.IDLE||n;return(0,ke.jsx)(At.y,{selectMode:!!t,selectAllCallback:this.selectAll,selectButtonCallback:a,disableToggle:l,hasSelectedItems:o,batchSupported:e})}renderSelectorFooter(){const{batchSelectEnabled:e,selectMode:t,selectedItems:s}=this.props;if(!e)return null;const{blursApplying:a,toolState:n}=this.state,r=(null==s?void 0:s.size)>0&&n===i.IDLE&&!a;return(0,ke.jsx)(Ut.n,{active:!!t,enabled:r,leftButtonCallback:this.batchDelete,rightButtonCallback:this.batchToggleVisibility})}renderSelectorContent(){const{selectMode:e,selectedItems:t,isGroupBatchSelected:s}=this.props,{groups:i}=this.state,a=Object.keys(i).length>1;return(0,ke.jsx)(Mt.t,Object.assign({selectMode:e},{children:Object.values(i).map((i=>(0,ke.jsx)(BlurListGroupComponent,{group:i,multiFloor:a,selectMode:e,selectedItems:t,manager:this.props.manager,onCheckboxClick:this.props.onCheckboxClick,onExpandChange:this.props.onExpandChange,onSelectGroup:this.props.onSelectGroup,onSelectItem:this.props.onSelectItem,isGroupSelected:s(i)},i.id)))}))}render(){const{toolPanelLayout:e}=this.context.toolsData,t=this.renderSelectorHeader(),s=this.renderSelectorFooter(),i=this.renderSelectorContent();return(0,ke.jsx)(Qe.L,Object.assign({active:!0,toolPanelLayout:e,title:this.renderListTitle(),subheader:t,footer:s||void 0},{children:(0,ke.jsx)("div",Object.assign({className:"list-contents"},{children:i}))}))}}BlursList.contextType=_e.I;const qt=(0,Gt.A)(BlursList,(e=>e.editable));var Kt=s(27396);class BlurToolUi_BlurToolUi{constructor(e,t){this.renderPanel=()=>{const e=this.settings.tryGetProperty(Kt.x,!1);return(0,ke.jsx)(qt,{manager:this.manager,batchSelectEnabled:e})},this.renderActionBar=()=>(0,ke.jsx)(He,{manager:this.manager}),this.manager=e,this.settings=t}}var Yt=s(61903),Jt=s(48697),Xt=s(52012),es=s(94772);class BlurEditorModule extends o.Y{constructor(){super(...arguments),this.name="blur_editor",this.activeBindings=[],this.setMeshCursorVisibility=()=>!this.data.hoveredBlur&&this.data.toolState!==i.PAINTING,this.changeToolState=e=>{const t=this.data.toolState;e!==t&&(e!==i.SUGGESTING||this.config.suggestionsEnabled?(this.data.toolState=e,this.data.commit(),this.onToolStateChange(e,t)):this.log.error("Suggestions not available"))},this.navigateToBlur=(e,t)=>{if(!e)throw new Error("Cannot navigate to non-existant blur");let s;const a=this.getFocalPoint(e.dots);if(a){const t=this.sweepData.getSweep(e.sweepId);a.applyQuaternion(t.rotation),s=(0,I.Z)((new r.Quaternion).setFromUnitVectors(x.f.FORWARD,a))}const n=new y.ju({transition:E.n.Interpolate,sweep:e.sweepId,rotation:s}),o=this.engine.commandBinder.issueCommand(n).then((()=>{this.data.selectedBlur=e||null}));return t&&this.engine.commandBinder.issueCommand(new BlurToolChangeCommand(i.IDLE)),this.toolData.toolPanelLayout===D.wS.BOTTOM_PANEL&&this.engine.commandBinder.issueCommand(new k.zK(!0)),o},this.onToolStateChange=(e,t)=>{const{brush:s}=this.data;t===i.PAINTING&&this.engine.commandBinder.issueCommand(new m.o8),e===i.PAINTING?(s.enable(),this.engine.broadcast(new O.ps(!1))):(s.disable(),this.engine.broadcast(new O.ps(!0))),e===i.OFF?(this.activeBindings.forEach((e=>e.cancel())),this.data.selectedBlur=null,this.data.hoveredBlur=null,this.data.interactions.openedTool=!1,this.data.interactions.commit(),this.renderer.setBlurs([])):this.activeBindings.forEach((e=>e.renew())),e!==i.OFF&&(this.data.selectedBlur=null,this.data.hoveredBlur=null,this.data.interactions.openedTool||(this.data.interactions.openedTool=!0,this.data.interactions.commit()),e===i.SUGGESTING?this.renderSuggestions():this.renderBlurs()),this.updatePolling()},this.checkForUpdates=()=>{let e;return(0,d.k1)((()=>{clearInterval(e),e=window.setInterval((()=>{this.log.debug("Polling..."),this.engine.commandBinder.issueCommand(new m.s$)}),1e3*de.F8)}),(()=>{window.clearInterval(e)}),!1)},this.onViewmodeChange=e=>{const{toolState:t}=this.data;e!==w.Ey.Panorama&&t===i.PAINTING&&this.changeToolState(i.IDLE),e===w.Ey.Panorama?this.clickHandler.renew():this.clickHandler.cancel()},this.onSweepChange=e=>{const{selectedBlur:t}=this.data;t&&(this.onDeselectBlur(t),this.data.selectedBlur=null)},this.onBlursChanged=()=>{const{selectedBlur:e}=this.data;e&&!this.blurData.isEditable(e.id)&&(this.data.selectedBlur=null);const{toolState:t}=this.data;t!==i.SUGGESTING&&this.renderBlurs()},this.onSuggestionsChanged=()=>{const e=this.toolData.getTool(D.w1.BLUR);if(e){const t=this.suggestionData.getByAccepted(null).length>0;e.hasUpdates!==t&&(e.hasUpdates=t,e.commit())}if(!this.data)return;const{toolState:t}=this.data;t===i.SUGGESTING&&this.renderSuggestions()},this.onPointerButton=e=>{const{toolState:t}=this.data,{hit:s}=this.raycasterData;e.down&&t===i.PAINTING&&this.updateSelectedBlur(s?s.object:null)},this.onKeyEvent=e=>{const{selectedBlur:t}=this.data;if(t&&e.state===oe.M.PRESSED)switch(e.key){case le.R.ESCAPE:this.engine.commandBinder.issueCommand(new BlurToolChangeCommand(i.IDLE));break;case le.R.DELETE:this.data.selectedBlur&&this.engine.commandBinder.issueCommand(new m.TL(t.id))}},this.onClick=(e,t)=>{const{toolState:s}=this.data;return s===i.PAINTING||!!(t instanceof BlurMesh||this.data.selectedBlur)&&(this.updateSelectedBlur(t),!0)},this.onPaint=(e,t,s,i)=>{const a=this.sweepData.currentSweepObject;if(!a)return;let n=this.data.selectedBlur instanceof p.x?this.data.selectedBlur:null;const r=n?n.dotCount:0;(!n||r>de.Vw)&&(n=new p.x({sweepId:a.id}),a.placementType!==es.hU.UNPLACED&&(n.floorId=a.floorId,n.roomId=a.roomId),this.blurData.add(n),this.data.selectedBlur=n);const o=e.clone().applyQuaternion(a.rotation.clone().invert()).normalize();n.add(o,t,s,i)},this.updateHoveredBlur=()=>{const{toolState:e}=this.data,t=this.raycasterData.hit&&this.raycasterData.hit.object,s=e===i.PAINTING?null:this.getBlurFromMesh(t);if(s!==this.data.hoveredBlur&&(this.data.hoveredBlur=s,this.data.toolState!==i.PAINTING)){const e=s?B.C.FINGER:null;this.engine.commandBinder.issueCommand(new v.u(e))}}}async init(e,t){this.log.debug("Module config",e),this.engine=t,this.config=e,[this.blurData,this.cameraData,this.cursorController,this.raycasterData,this.settings,this.storageData,this.sweepData,this.toolData,this.viewmodeData]=await Promise.all([t.market.waitForData(b.f),t.market.waitForData(f.M_),t.getModuleBySymbol(l.y.CURSOR_CONTROLLER),t.market.waitForData(C.P),t.getModuleBySymbol(l.y.SETTINGS),t.market.waitForData(Jt.Q),t.market.waitForData(u.Z),t.market.waitForData(R.t),t.market.waitForData(T.O)]);const[s,a,n,o]=await Promise.all([t.getModuleBySymbol(l.y.INPUT),t.getModule(re.default),t.market.waitForData(T.O),t.getModuleBySymbol(l.y.WEBGL_RENDERER)]);e.suggestionsEnabled&&(this.suggestionData=await t.market.waitForData(Te.a),this.bindings.push(this.toolData.onChanged(this.onSuggestionsChanged),this.suggestionData.onChanged(this.onSuggestionsChanged)));const d=(await t.getModuleBySymbol(l.y.SWEEP_PANO)).getRenderer();this.data=new BlurEditorData,t.market.register(this,BlurEditorData,this.data),this.cursorController.addVisibilityRule(this.setMeshCursorVisibility);const m=o.getScene();this.renderer=new BlurRenderer(this.sweepData,this.data,m,s,a,o.cwfRenderer,d),t.addComponent(this,this.renderer);const p=new PanoBrush(this.sweepData,this.cameraData,m,s);p.setSizeRange(de.oR,de.rC),p.onPaint=this.onPaint,t.addComponent(this,p),this.data.brush=p,this.registerSettings(),this.registerTool(),this.clickHandler=s.registerPriorityHandler(c.R,r.Mesh,this.onClick),this.bindings.push(t.commandBinder.addBinding(BlurToolChangeCommand,(async e=>this.changeToolState(e.state))),t.commandBinder.addBinding(SetBlurBrushScaleCommand,(async e=>this.data.brush.scale=e.scale)),t.commandBinder.addBinding(NavigateToBlurCommand,(async({blur:e,resetBlurTool:t})=>this.navigateToBlur(e,t))),t.commandBinder.addBinding(ShowBlursCommand,(({ids:e})=>this.showBlurs(...e))),t.commandBinder.addBinding(HideBlursCommand,(({ids:e})=>this.hideBlurs(...e))),t.commandBinder.addBinding(ToggleBlurVisibilityCommand,(async({id:e})=>this.batchToggleVisibility([e]))),t.commandBinder.addBinding(BatchToggleBlurVisibilityCommand,(async({ids:e})=>this.batchToggleVisibility(e)))),this.pollingSubscription=this.checkForUpdates(),this.updatePolling(),this.activeBindings.push(n.makeModeChangeSubscription(this.onViewmodeChange),this.sweepData.makeSweepChangeSubscription(this.onSweepChange),this.blurData.blurs.onChanged(this.onBlursChanged),s.registerHandler(h.er,this.onPointerButton),s.registerHandler(g.e,this.onKeyEvent),this.raycasterData.onChanged(this.updateHoveredBlur),this.clickHandler,this.storageData.onPropertyChanged("transactionState",(()=>this.updatePolling())),this.blurData.makeProcessingSubscription((()=>this.updatePolling()))),this.changeToolState(i.OFF),this.viewmodeData.currentMode&&this.onViewmodeChange(this.viewmodeData.currentMode),e.debug&&this.log.info("DEBUG mode enabled")}dispose(e){super.dispose(e),this.pollingSubscription&&this.pollingSubscription.cancel(),this.activeBindings.forEach((e=>e.cancel())),e.disposeRenderLayer(this.name),this.data&&e.market.unregister(this,BlurEditorData),this.cursorController.removeVisibilityRule(this.setMeshCursorVisibility)}renderBlurs(){const e=this.blurData.getByStatus(S.Q.PENDING,S.Q.PROCESSING,S.Q.FAILED).filter((e=>e.visible));this.renderer.setBlurs(e)}renderSuggestions(){const e=this.suggestionData.getByAccepted(!0,null).filter((e=>e.visible));this.renderer.setBlurs(e)}getFocalPoint(e){if(!e.length)return null;let t=0;const s=e.reduce(((e,s)=>{for(const i of s.directions)e.x+=i.x,e.y+=i.y,e.z+=i.z,t++;return e}),{x:0,y:0,z:0});return new r.Vector3(s.x/t,s.y/t,s.z/t)}async showBlurs(...e){this.blurData.setVisibility(!0,...e)}async hideBlurs(...e){this.blurData.setVisibility(!1,...e)}batchToggleVisibility(e){this.blurData.batchToggleVisibility(e)}updatePolling(){const{toolState:e}=this.data,{transactionState:t}=this.storageData,s=e!==i.OFF,a=t===Xt.g.IDLE;return s&&a?(this.pollingSubscription.renew(),this.log.debug("Polling enabled"),!0):(this.log.debug("Polling disabled"),this.pollingSubscription.cancel(),!1)}onDeselectBlur(e){const{toolState:t}=this.data;e&&t===i.PAINTING&&this.engine.commandBinder.issueCommand(new m.o8)}getBlurFromMesh(e){if(e&&e instanceof BlurMesh){const t=this.data.toolState===i.SUGGESTING,s=t?this.suggestionData.get(e.blurId):this.blurData.get(e.blurId);if(t||(null==s?void 0:s.status)===S.Q.PENDING)return s}return null}updateSelectedBlur(e){const t=this.getBlurFromMesh(e);t!==this.data.selectedBlur&&(this.onDeselectBlur(this.data.selectedBlur),this.data.selectedBlur=t,t&&this.log.debug(`Selected blur ${t.id}`))}registerSettings(){const e="Blur Tool",{brush:t}=this.data,{debug:s,meshBlurEnabled:i,pipelineEnabled:a,suggestionsEnabled:n}=this.config;[{header:e,setting:"blur/brush_size",range:[de.oR,de.rC],initialValue:()=>t.size,onChange:e=>t.size=e},{header:e,setting:"blur/brush_scale",range:[0,1],initialValue:()=>t.scale,onChange:e=>t.scale=e},{header:e,setting:"blur/tool_enabled",initialValue:()=>this.settings.tryGetProperty(de.x3,!1),onChange:e=>this.settings.updateSetting(de.x3,e)},{header:e,setting:"blur/mask",initialValue:()=>!1,onChange:e=>{this.renderer&&this.renderer.setMaskVisibility(e)}},{header:e,setting:"blur/show_cursor",initialValue:()=>!1,onChange:e=>{this.log.debug("Brush mouse cursor "+(e?"enabled":"disabled")),t.toggleMouseCursor(e)}},{header:e,setting:de.Vk,initialValue:()=>s,onChange:e=>{this.settings.updateSetting(de.Vk,e)}},{header:e,setting:Z.pv,initialValue:()=>!1,onChange:e=>{this.settings.updateSetting(Z.pv,e)}},{header:e,setting:Z.n5,initialValue:()=>a,onChange:e=>{this.settings.updateSetting(Z.n5,e)}},{header:e,setting:Z.i7,initialValue:()=>i,onChange:e=>{this.settings.updateSetting(Z.i7,e)}},{header:e,setting:ye.M,initialValue:()=>n,onChange:e=>{this.settings.updateSetting(ye.M,e)}}].forEach((e=>this.settings.registerMenuEntry(e)))}async registerTool(){const{suggestionsEnabled:e}=this.config,t=await this.engine.market.waitForData(Yt.e);let s,i;e?(i=new BlurToolManager_BlurToolManager(this.engine,t),s=new BlurToolUi(i,t)):(i=new BlurToolManager(this.engine,t),s=new BlurToolUi_BlurToolUi(i,t));const a=new P.U({id:D.w1.BLUR,namePhraseKey:ve.Z.TOOLS.BLUR,panel:!0,icon:"icon-blur-outline",analytic:"blur",toolbar:!0,dimmed:!1,enabled:t.tryGetProperty(de.x3,!1),manager:i,ui:s,featureFlag:de.x3,helpMessagePhraseKey:ve.Z.TOOLS.BLUR_HELP_MESSAGE,helpHref:"https://support.matterport.com/hc/en-us/articles/1500003156162-How-to-use-Manual-Blur-Brush"});this.engine.commandBinder.issueCommand(new k.MV([a]))}}},19387:(e,t,s)=>{"use strict";s.d(t,{a:()=>BlurSuggestionData});var i=s(35424),a=s(66910),n=s(81402);class BlurSuggestionData extends i.V{constructor(e){super(),this.name="blur-suggestion-data",this.suggestions=new a.v,e&&this.add(...e)}add(...e){this.suggestions.atomic((()=>{for(const t of e)t.atomic((()=>{for(;!t.id||this.suggestions.has(t.id);)t.id=(0,n.O1)(11),t.commit();if(-1===t.index||this.hasIndex(t.index)){const e=this.suggestions.values.map((e=>e.index)).filter((e=>"number"==typeof e)),s=e.length?Math.max(...e):0;t.index=s+1,t.commit()}})),this.suggestions.set(t.id,t)})),this.commit()}has(e){return this.suggestions.has(e)}hasIndex(e){return!!this.suggestions.values.find((t=>t.index===e))}get(e){return this.suggestions.get(e)}getByAccepted(...e){return this.suggestions.values.filter((t=>e.includes(t.accepted)))}accept(...e){return this.updateAll(e,{accepted:!0})}reject(...e){return this.updateAll(e,{accepted:!1})}reset(...e){return this.updateAll(e,{accepted:null})}show(...e){return this.updateAll(e,{visible:!0})}hide(...e){return this.updateAll(e,{visible:!1})}updateAll(e,t){const s=e.length?e:this.suggestions.keys;this.atomic((()=>{this.suggestions.atomic((()=>{for(const e of s)if(this.has(e)){const s=this.get(e);Object.assign(s,t),s.commit()}})),this.commit()}))}}},58843:(e,t,s)=>{"use strict";s.d(t,{qY:()=>SaveSuggestionsCommand,ee:()=>ShowSuggestionsCommand,mA:()=>HideSuggestionsCommand,rf:()=>AcceptSuggestionsCommand,oA:()=>RejectSuggestionsCommand});var i=s(93037);class SaveSuggestionsCommand extends i.m{constructor(){super(...arguments),this.id="SAVE_BLUR_SUGGESTIONS"}}class ShowSuggestionsCommand extends i.m{constructor(...e){super(),this.id="SHOW_BLUR_SUGGESTIONS",this.payload={ids:e}}}class HideSuggestionsCommand extends i.m{constructor(...e){super(),this.id="HIDE_BLUR_SUGGESTIONS",this.payload={ids:e}}}class AcceptSuggestionsCommand extends i.m{constructor(...e){super(),this.id="ACCEPT_BLUR_SUGGESTIONS",this.payload={ids:e}}}class RejectSuggestionsCommand extends i.m{constructor(...e){super(),this.id="REJECT_BLUR_SUGGESTIONS",this.payload={ids:e}}}},87490:(e,t,s)=>{"use strict";s.r(t),s.d(t,{BlurSuggestionData:()=>i.a,default:()=>BlurSuggestionsModule});var i=s(19387),a=s(57227),n=s(14877),r=s(18537),o=s(60673),l=s(67495),d=s(56454),u=s(22937),c=s(73501),h=s(52549),g=s(7819),m=s(47063);class HttpFileStore{constructor(e){this.config=e}async read(){const{url:e,deserializer:t,format:s,queue:i}=this.config;let a=await i.get(e);return"json"===s&&(a=JSON.parse(a)),t?t(a):a}}var p=s(53549),b=s(17403),S=s(77337),f=s(58843),v=s(16562),B=s(46265),C=s(98254),T=s(81402);class BlurSuggestion extends C.T{constructor(e){super(),this.accepted=null,this.index=-1,this.classification=[],this.visible=!0,this.id=(0,T.O1)(11),e&&Object.assign(this,e)}}var w=s(39300),y=s(5477),E=s(63336);const x=new y.Z("blurSuggestionDeserializer");function I(e){const t=function(e){return function(t){const s=(0,w.LB)(null==t?void 0:t.dots),i=e.getSweepByUuid(null==t?void 0:t.sweepId);if(!(t&&s&&s.length&&i))return x.debug("Deserialized invalid Blur suggestion",t),null;const a=!0===t.accepted||!1===t.accepted?t.accepted:null;return new BlurSuggestion({id:t.sid,accepted:a,dots:s,index:t.index,floorId:i.floorId,roomId:i.roomId,sweepId:i.id,classification:t.tags||[],visible:!0,created:(0,E.p)(t.created),modified:(0,E.p)(t.modified)})}}(e);return function(e){const s={};for(const i in e){const a=t(e[i]);a&&(s[i]=a)}return s}}var D=s(9351);function k(e){const t=function(e){return function(t){const s=e.getSweep(t.sweepId),i=(0,D.o_)(t.dots);return s&&(null==i?void 0:i.length)?{sid:t.id,accepted:t.accepted,dots:i,index:t.index,sweepId:s.uuid,tags:t.classification,visible:t.visible,created:(0,E.U)(t.created),modified:(0,E.U)(t.modified)}:null}}(e);return function(e){const s={};for(const i in e){const a=t(e[i]);a&&(s[i]=a)}return s}}class BlurSuggestionStore extends B.MU{constructor(e){const{queue:t,baseUrl:s,modelId:i,sweepData:a}=e;super({queue:t,path:`${s}/api/v1/jsonstore/model/blur-suggestions/${i}`,batchUpdate:!0,deserialize:I(a),serialize:k(a)}),this.baseUrl=s,this.modelId=i}async read(){const e=await super.read();return Object.values(e||{})}async reset(){var e;const{queue:t}=this.config,s=`${this.baseUrl}/api/v1/jsonstore/model/blur-suggestions/${this.modelId}`;if(!(null===(e=this.modelId)||void 0===e?void 0:e.length))throw new Error(`Refusing to DELETE ${s}`);if(window.confirm("Are you sure you want to reset all suggestions? This cannot be undone."))return t.delete(s,this.options).then((()=>{window.location.reload()}))}}function O(e){return t=>{const s=[];if(!(null==t?void 0:t.blurs))return[];const i=Object.values(t.blurs).filter((e=>!e.blurEnabled));for(const t of i){const i=e.getSweepByUuid(t.sweepId),a=(0,w.LB)(t.dots);if(!(null==a?void 0:a.length)||!i||!Array.isArray(null==t?void 0:t.dots))continue;const n=new BlurSuggestion({accepted:null,sweepId:i.id,dots:a,classification:["face"],floorId:i.floorId||void 0,visible:!0});s.push(n)}return s}}class BlurSuggestionsModule extends a.Y{constructor(){super(...arguments),this.name="blur-suggestions"}async init(e,t){this.engine=t,this.config=e,await this.load(),await this.registerSettings()}async load(){const{baseUrl:e,modelId:t,queue:s,readonly:a,source:n,importEnabled:o}=this.config,{market:u,commandBinder:c}=this.engine,[b,S]=await Promise.all([u.waitForData(d.f),u.waitForData(p.Z)]);let B;if(this.blurData=b,this.store=new BlurSuggestionStore({queue:s,baseUrl:e,modelId:t,sweepData:S}),this.data=new i.a,n===v.Z.VISION?(this.log.info("Loading suggestions from Vision, changes will NOT be saved"),this.config.readonly=!0,this.config.importEnabled=!1,B=this.getSuggestionsFromVision()):(B=this.store.read(),this.log.debug("Loaded existing suggestions",B)),B&&B.then((async e=>{if(this.data)if(0===e.length&&n!==v.Z.VISION&&o){const e=await this.getSuggestionsFromVision();if(!this.data)return;this.data.add(...e),this.log.debug(`Importing ${e.length} suggestions from Vision...`),c.issueCommand(new f.qY)}else this.data.add(...e||[])})),!a){const e=await this.engine.getModule(g.F);this.bindings.push(c.addBinding(f.qY,(()=>c.issueCommand(new m.VQ({dataTypes:[h.g.BLUR_SUGGESTIONS]})))),c.addBinding(f.rf,(({ids:e})=>this.accept(...e))),c.addBinding(f.oA,(({ids:e})=>this.reject(...e))),c.addBinding(f.ee,(({ids:e})=>this.show(...e))),c.addBinding(f.mA,(({ids:e})=>this.hide(...e))),e.onSave((()=>this.save()),{dataType:h.g.BLUR_SUGGESTIONS}))}u.register(this,i.a,this.data),a||(this.monitor=new l.c(this.data.suggestions,{aggregationType:r.E.Manual}))}dispose(e){super.dispose(e),e.market.unregister(this,i.a),this.data=void 0}async accept(...e){const{commandBinder:t}=this.engine,s=e.length?e.map((e=>this.data.get(e))):this.data.getByAccepted(null),i=s.map((e=>u.x.from(e)));return this.blurData.add(...i),this.data.accept(...s.map((e=>e.id))),Promise.all([t.issueCommand(new c.o8),t.issueCommand(new f.qY)]).then((()=>{}))}async reject(...e){const{commandBinder:t}=this.engine,s=e.length?e:this.data.getByAccepted(null).map((e=>e.id));return this.data.reject(...s),t.issueCommand(new f.qY)}async show(...e){this.data.show(...e)}async hide(...e){this.data.hide(...e)}async save(){const{readonly:e}=this.config;if(e||!this.monitor)return;this.monitor.commitChanges();const t=this.monitor.getDiffRecord();if(this.monitor.clearDiffRecord(),!t.length)return;const s={};for(const e of t)switch(e.action){case o.KI.added:case o.KI.updated:s[e.index]=this.data.get(e.index);break;case o.KI.removed:s[e.index]=null}return this.store.update(s).catch((e=>{this.log.error(e)}))}async getSuggestionsFromVision(){const{market:e}=this.engine,[t,s]=await Promise.all([e.waitForData(S.R),e.waitForData(p.Z)]);let i=null;const a=t.objectBlur;if(null==a?void 0:a.url){const e=new HttpFileStore({url:a.url,queue:this.config.queue||new b.RequestQueue,format:"json",deserializer:O(s)});i=await e.read()}return i||[]}async registerSettings(){const e=await this.engine.getModuleBySymbol(n.y.SETTINGS),{debug:t}=this.config;t&&e.registerMenuButton({header:"Blur Suggestions",buttonName:"Reset Suggestions",callback:()=>{this.store.reset()}})}}},77337:(e,t,s)=>{"use strict";s.d(t,{R:()=>VisionCatalogData});var i=s(35424);class VisionCatalogData extends i.V{constructor(e=[]){super(),this.catalog=e}get objectAnnotations(){return this.catalog.find((e=>"objectAnnotations"===e.name))}get semantic(){return this.catalog.find((e=>"semantic"===e.name))}get detectedObjects(){return this.catalog.find((e=>"detectedObjects"===e.name))}get objectBlur(){return this.catalog.find((e=>"objectBlur"===e.name))}}},67525:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>VisionCatalogModule});var i=s(57227),a=s(77337),n=s(33359),r=s(55594),o=s(66225),l=s(63336);class VisionCatalogStore extends o.u{async read(){return this._readAssets().then((e=>e.length?e:this._readCatalog()))}_readAssets(){const e={modelId:this.getViewId()};return this.query(n.GetVisionAssets,e).then((e=>{var t;const s=(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||{},i=[];for(const e in s){const t=s[e];t.url&&i.push({name:e,contentType:t.contentType||"unknown",format:t.format,url:t.url,validUntil:(0,l.p)(t.validUntil)})}return i}))}_readCatalog(){const e={modelId:this.getViewId()};return this.query(r.GetVisionCatalog,e).then((e=>{var t,s,i;const a=(null===(i=null===(s=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===s?void 0:s.assets)||void 0===i?void 0:i.catalog)||[],n=[];return a.forEach((e=>{if(e.url){let t=e.type||"unknown";"unknown"===t&&e.url.match(/object\//i)&&(t="objectAnnotations"),"unknown"===t&&e.url.match(/blur/i)&&(t="objectBlur"),"unknown"===t&&e.url.match(/detected/i)&&(t="detectedObjects"),n.push({name:t,format:e.format,url:e.url,contentType:e.format,validUntil:(0,l.p)(e.validUntil)})}})),n}))}}class VisionCatalogModule extends i.Y{constructor(){super(...arguments),this.name="vision-catalog"}async init(e={},t){const s=new VisionCatalogStore,i=await s.read().catch((e=>(this.log.info("Failed to load Vision Catalog"),[])));this.data=new a.R(i),t.market.register(this,a.R,this.data)}dispose(e){super.dispose(e),e.market.unregister(this,a.R)}}},22937:(e,t,s)=>{"use strict";s.d(t,{x:()=>Blur});var i=s(98254),a=s(81402),n=s(91885);class Blur extends i.T{constructor(e){super(),this.dots=[],this.status=n.Q.PENDING,this.floorId=null,this.roomId=null,this.visible=!0,this.created=new Date,this.modified=new Date,this.id=(0,a.O1)(11),this.index=-1,e&&Object.assign(this,e)}get editable(){return Blur.editableStatus.includes(this.status)}add(e,t,s,i){let a=this.dots.find((e=>e.radius===t&&e.feather===s&&e.strength===i));a||(a={radius:t,feather:s,strength:i,directions:[]},this.dots.push(a)),a.directions.push(e),this.modified.setTime(Date.now()),this.commit()}static from(e){return new Blur({status:n.Q.PENDING,dots:e.dots,sweepId:e.sweepId,floorId:e.floorId||null})}get dotCount(){return this.dots.reduce(((e,t)=>e+t.directions.length),0)}get sid(){return this.id}}Blur.editableStatus=[n.Q.FAILED,n.Q.PENDING]},1615:(e,t,s)=>{"use strict";s.r(t),s.d(t,{ApplyBlursCommand:()=>i.Mh,Blur:()=>r.x,BlurData:()=>a.f,BlurStatus:()=>n.Q,DeleteBlursCommand:()=>i.TL,PublishBlursCommand:()=>i.ie,RefreshBlursCommand:()=>i.s$,SaveBlursCommand:()=>i.o8,default:()=>BlurDataModule});var i=s(73501),a=s(56454),n=s(91885),r=s(22937),o=s(57227),l=s(18537),d=s(60673),u=s(67495),c=s(14877),h=s(52549),g=s(47063),m=s(7819),p=s(52012),b=s(48697),S=s(53549),f=s(46265),v=s(81402),B=s(5477),C=s(3157),T=s(39300),w=s(9351);const y=new B.Z("BlurStore");class BlurStore extends f.MU{constructor(e){const{baseUrl:t,modelId:s,queue:i,sweepData:a}=e;super({queue:i,path:`${t}/api/v1/jsonstore/model/blurs/${s}`,batchUpdate:!0,deserialize:(0,T.B4)(a),serialize:(0,w.fM)(a)}),this.queue=i,this.baseUrl=t,this.modelId=s,this.serialize=(0,w.o2)(a)}async apply(e,{useChunks:t,meshBlurEnabled:s,pipelineEnabled:i}){if(!i)return void y.info("Pipeline disabled, no blurs will be applied to the model");const a={enableMeshBlur:s,levels:C.TW.map((e=>({size:e.size,sigmaRadians:.5*e.sigma/e.size})))},n={};for(const s of e){const e=t?s.sweepId:0,i=this.serialize(s);i&&(n[e]||(n[e]={}),n[e][s.id]=i)}const r=Object.keys(n).length,o=[];for(const e in n){const s=n[e];t&&y.debug(`Applying ${Object.values(s).length} blurs to Sweep ${e}`);const i=this.queue.post(`${this.baseUrl}/api/v2/pano-edit/${this.modelId}/blur-panos`,{withCredentials:!0,body:{blurs:s,options:a}});o.push(i),r>o.length&&(y.debug("waiting 100ms"),await(0,v.gw)(250))}return Promise.all(o)}}class BlurDataModule extends o.Y{constructor(){super(...arguments),this.name="blur_data",this.refreshPromise=null,this.onSaveBlursCommand=()=>{const{commandBinder:e}=this.engine;return e.issueCommand(new g.VQ({dataTypes:[h.g.BLURS]}))},this.onApplyBlursCommand=()=>{const{commandBinder:e}=this.engine;return e.issueCommand(new g.R_({dataTypes:[h.g.BLURS]}))}}async init(e,t){this.engine=t,this.config=e,await this.load(t)}dispose(e){super.dispose(e),e.market.unregister(this,a.f),this.data=void 0}async configureStorage(){if(this.store)return;const{baseUrl:e,modelId:t,queue:s,readonly:a}=this.config,{commandBinder:n,market:r}=this.engine,o=await r.waitForData(S.Z);this.store=new BlurStore({baseUrl:e,modelId:t,queue:s,sweepData:o}),a||(this.bindings.push(n.addBinding(i.s$,(()=>this.refresh())),n.addBinding(i.Mh,this.onApplyBlursCommand),n.addBinding(i.o8,this.onSaveBlursCommand),n.addBinding(i.TL,(async({ids:e})=>this.deleteById(...e)))),this.engine.getModule(m.F).then((e=>{this.revertHandler=e.onRevert((()=>this.revert()),{dataType:h.g.BLURS}),this.bindings.push(e.onPublish((()=>this.applyBlurs()),{phase:p.Q.BEFORE}),e.onPublish((()=>this.updatePublishableStatus()),{phase:p.Q.AFTER}),e.onSave((()=>this.save()),{dataType:h.g.BLURS}),this.revertHandler),this.updatePublishableStatus()})))}async load(e){await this.configureStorage(),this.settings=await e.getModuleBySymbol(c.y.SETTINGS),this.data=new a.f,e.market.register(this,a.f,this.data);const t=await this.store.read();return this.data.add(...Object.values(t||{})),this.monitor=new u.c(this.data.blurs,{aggregationType:l.E.Manual}),await this.updatePublishableStatus()}async updatePublishableStatus(){var e,t;if(this.storageData||(this.storageData=await this.engine.market.waitForData(b.Q)),!this.data)return;const s=this.data.hasUnappliedBlurs()&&!this.data.hasProcessingBlurs(),i=this.data.hasStatus(n.Q.PENDING);s?this.storageData.setPublishableType(h.g.BLURS):this.storageData.clearPublishableType(h.g.BLURS),i?(this.storageData.setRevertableType(h.g.BLURS),null===(e=this.revertHandler)||void 0===e||e.renew()):(this.storageData.clearRevertableType(h.g.BLURS),null===(t=this.revertHandler)||void 0===t||t.cancel()),s||i?this.storageData.setDirtyType(h.g.BLURS):this.storageData.clearDirtyType(h.g.BLURS)}async refresh(){if(this.refreshPromise)return;if(!this.data.hasAppliedBlurs())return;const e=this.store.read().then((e=>{this.updateBlursFrom(...Object.values(e||{}))})).finally((()=>{this.refreshPromise=null}));return this.refreshPromise=e,e}async save(){if(!this.monitor||this.config.readonly)return void this.log.warn("Blur changes will NOT be saved");await this.refresh(),this.monitor.commitChanges();const e=this.monitor.getDiffRecord().filter((({index:e,action:t})=>t===d.KI.removed||this.data.has(e)&&this.data.get(e).editable));if(this.monitor.clearDiffRecord(),!e.length)return;const t={};for(const s of e)switch(s.action){case d.KI.added:case d.KI.updated:t[s.index]=this.data.get(s.index);break;case d.KI.removed:t[s.index]=null}return this.store.update(t).finally((()=>{this.updatePublishableStatus()}))}async applyBlurs(e=!0){if(!this.data.hasProcessingBlurs())return this.publish()}async publish(){var e,t,s;if(this.data.hasProcessingBlurs())return;await this.save();const i=this.data.getByStatus(n.Q.PENDING,n.Q.FAILED);if(!i.length)return;i.length>C.Dr&&(this.log.info(`Publishing Blurs: Truncating request to the maximum of ${C.Dr} Blurs. Total Pending: ${i.length}`),i.length=C.Dr),this.data.setStatus(n.Q.PROCESSING,...i.map((e=>e.id))),this.log.info(`Applying ${i.length} blurs...`);const a=null===(e=this.settings)||void 0===e?void 0:e.tryGetProperty(C.n5,!1),r=null===(t=this.settings)||void 0===t?void 0:t.tryGetProperty(C.i7,!1),o=null===(s=this.settings)||void 0===s?void 0:s.tryGetProperty(C.pv,!1);return this.store.apply(i,{useChunks:o,meshBlurEnabled:r,pipelineEnabled:a}).finally((()=>{this.updatePublishableStatus()}))}async revert(){const e=this.data.getByStatus(n.Q.PENDING).map((e=>e.id));if(e.length)return this.data.delete(...e),this.save()}async deleteById(...e){if(this.data.delete(...e))return this.save()}updateBlursFrom(...e){this.data.atomic((()=>{e.forEach((e=>{if(this.data.has(e.id)){const t=this.data.get(e.id);e.status!==t.status&&(t.status=e.status,t.modified.setTime(e.modified.getTime()),t.commit())}}))})),this.updatePublishableStatus()}}},39300:(e,t,s)=>{"use strict";s.d(t,{B4:()=>h,LB:()=>g});var i=s(63336),a=s(5477),n=s(63387),r=s(22937),o=s(91885),l=s(3157),d=s(37936),u=s(94772);const c=new a.Z("blurDeserializer");function h(e){const t=function(e){return function(t){var s;const a=g(null==t?void 0:t.dots),n=e.getSweepByUuid(null===(s=null==t?void 0:t.sweepId)||void 0===s?void 0:s.replace(/-/g,""));if(!(t&&a&&a.length&&n))return c.debug("Deserialized invalid Blur",t),null;const d=new r.x({id:t.sid,index:"number"==typeof t.index?t.index:-1,status:t.status,sweepId:n.id,created:(0,i.p)(t.created)});return n.placementType!==u.hU.UNPLACED&&(d.floorId=n.floorId,d.roomId=n.roomId),a.forEach((e=>{e.directions.forEach((t=>{d.add(t,e.radius,e.feather,e.strength)}))})),d.modified=(0,i.p)(t.modified),d.status===o.Q.PROCESSING&&Date.now()-d.modified.getTime()>l.gJ&&(d.status=o.Q.FAILED),d}}(e);return function(e){const s={};for(const i of Object.values(e)){const e=t(i);e&&(s[e.id]=e)}return s}}function g(e){if(!e||!Array.isArray(e))return null;const t=[];for(const s of e)if(m(s)){const e=s.unitVectors.map((e=>n.ep.fromVisionVector({x:"string"==typeof e.x?parseFloat(e.x):e.x,y:"string"==typeof e.y?parseFloat(e.y):e.y,z:"string"==typeof e.z?parseFloat(e.z):e.z})));t.push({directions:e,radius:(0,d.d)(s.radius),feather:"string"==typeof s.feather?parseFloat(s.feather):s.feather,strength:"string"==typeof s.strength?parseFloat(s.strength):s.strength})}return t}function m(e){return["unitVectors","radius","strength","feather"].every((t=>t in e))}},9351:(e,t,s)=>{"use strict";s.d(t,{o2:()=>o,fM:()=>l,o_:()=>d});var i=s(63336),a=s(63387),n=s(65),r=s(37936);function o(e){return function(t){if(!t)return null;const s=e.getSweep(t.sweepId),a=d(t.dots);if(!s||!(null==a?void 0:a.length))return null;return{sid:t.id,index:t.index,sweepId:s.uuid,status:t.status,dots:a,visible:t.visible,created:(0,i.U)(t.created),modified:(0,i.U)(t.modified)}}}function l(e){const t=o(e);return function(e){const s={};for(const i of Object.values(e)){const e=t(i);e&&(s[i.id]=e)}return s}}function d(e){if(!e)return null;return function(e,t=5){return e.map((e=>({unitVectors:e.unitVectors.map((e=>({x:(0,a.Zd)(e.x,t),y:(0,a.Zd)(e.y,t),z:(0,a.Zd)(e.z,t)}))),radius:(0,a.Zd)(e.radius,t),feather:(0,a.Zd)(e.feather,t),strength:(0,a.Zd)(e.strength,3)})))}(e.map((e=>({unitVectors:e.directions.map((e=>(0,n.m)(a.ep.toVisionVector(e)))),radius:(0,r.t)(e.radius),feather:e.feather,strength:e.strength}))))}},37936:(e,t,s)=>{"use strict";s.d(t,{t:()=>a,d:()=>n});var i=s(3157);function a(e){return Math.atan(e/i.U_)}function n(e){return i.U_*Math.tan(e)}},80122:(e,t,s)=>{"use strict";s.d(t,{M:()=>SetPanoOverlayCommand});var i=s(93037);class SetPanoOverlayCommand extends i.m{constructor(e,t,s){super(),this.id="SET_PANO_OVERLAY",this.payload={sweepId:e,texture:t,quaternion:s}}}},46265:(e,t,s)=>{"use strict";s.d(t,{MU:()=>JsonStoreStore});var i,a=s(81402),n=s(78804);!function(e){e.GET="GET",e.POST="POST",e.PATCH="PATCH",e.PUT="PUT",e.DELETE="DELETE",e.OPTIONS="OPTIONS"}(i||(i={}));class ReadOnlyStore extends class Auth{constructor(){this._options={responseType:"json"}}get options(){const e=this._options;return e.headers=(0,n.m)(this.url,this._options.headers||{}),e}}{constructor(e){super(),this.config=e,this.url=e.path}async read(){const{deserialize:e}=this.config;let t=null;return this.config.cachedData&&this.config.cachedData.data?t=this.config.cachedData.data:(t=await this.config.queue.get(this.config.path,this.options),this.config.cachedData&&(this.config.cachedData.data=t)),e(t)}clearCache(){this.config.cachedData&&(this.config.cachedData.data=null)}}class JsonStoreStore extends ReadOnlyStore{constructor(e){super(e),this.config=e,this.acceptsPartial=!1,this.config.batchUpdate="batchUpdate"in this.config&&this.config.batchUpdate}async create(e){throw Error("Not implemented")}updateBatch(e,t){const{serialize:s}=this.config,a=[],n=[...new Set([...Object.keys(e),...Object.keys(t)])];for(const s of n){e[s]||t[s]||a.push(this.config.queue.delete(`${this.config.path}/${s}`,this.options))}const r=s(e,t),o=Object.assign(Object.assign({},this.options),{body:r});return a.push(this.config.queue.request(this.config.httpMethod||i.POST,this.config.path,o)),Promise.all(a)}updateInternal(e,t){const{serialize:s}=this.config,n=[],r=Object.assign({},this.options),o=Object.keys(e),l=Object.keys(t),d=(0,a.XN)(o.concat(l));for(const a in d){const o=d[a],l=e[o]||t[o];if(l){const e={};e[o]=l;const a={},d=t[o];d&&(a[o]=d);const u=s(e,a);r.body=u,n.push(this.config.queue.request(this.config.httpMethod||i.POST,this.config.path,r))}else n.push(this.config.queue.delete(`${this.config.path}/${o}`,this.options))}return Promise.all(n)}async update(e,t){this.clearCache(),await(this.config.batchUpdate?this.updateBatch(e,t||{}):this.updateInternal(e,t||{}))}async delete(e){throw Error("Not implemented")}}},20959:e=>{e.exports="precision highp float;precision highp int;uniform mat4 viewMatrix;uniform vec3 cameraPosition;uniform vec3 opacity;uniform vec3 radius;uniform vec3 feather;uniform vec3 color;varying vec4 vCenter;varying vec4 vPosition;void main(){float fragRadius=length(vPosition.xyz-vCenter.xyz);vec3 featherStart=radius-feather;vec3 circleAlphaWithFeather=1.-max(fragRadius-featherStart,0.)/(feather*2.);gl_FragColor=vec4(color.rgb*opacity*circleAlphaWithFeather,1.);}"},682:e=>{e.exports="precision highp float;precision highp int;uniform mat4 modelMatrix;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform mat3 normalMatrix;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;attribute mat4 instanceMatrix;varying vec4 vCenter;varying vec4 vPosition;void main(){vPosition=instanceMatrix*vec4(position,1.);vCenter=instanceMatrix*vec4(0.,0.,0.,1.);gl_Position=projectionMatrix*modelViewMatrix*vPosition;}"},10385:e=>{e.exports="precision highp float;precision highp int;uniform mat4 viewMatrix;uniform vec3 cameraPosition;varying vec4 maskPosition;varying vec4 panoPosition;uniform samplerCube maskTexture;uniform samplerCube panoBlurredMap0;uniform samplerCube panoBlurredMap1;uniform samplerCube panoBlurredMap2;uniform samplerCube panoBlurredMap3;const vec4 SELECTED_OUTLINE_COLOR=vec4(1.,1.,1.,1.);const vec4 HOVER_COLOR=vec4(1.,1.,1.,1.);vec4 combineBlurs(vec4 mask,vec4 blurredColor0,vec4 blurredColor1,vec4 blurredColor2,vec4 blurredColor3){float maskAlpha=mask.r;float selectedAlpha=mask.g;float hoveredAlpha=mask.b;float targetSigma=maskAlpha*(4.*4.-1.);float blurRatio=log2(1.+targetSigma);float panoAlpha=max(1.-abs(blurRatio-0.)/1.,0.);float blurAlpha0=max(1.-abs(blurRatio-1.)/1.,0.);float blurAlpha1=max(1.-abs(blurRatio-2.)/1.,0.);float blurAlpha2=max(1.-abs(blurRatio-3.)/1.,0.);float blurAlpha3=max(1.-abs(blurRatio-4.)/1.,0.);float alpha=blurAlpha0+blurAlpha1+blurAlpha2+blurAlpha3;vec4 color=(panoAlpha*blurredColor0+blurAlpha0*blurredColor0+blurAlpha1*blurredColor1+blurAlpha2*blurredColor2+blurAlpha3*blurredColor3);color.a=alpha;float selectedMaskAlpha=smoothstep(0.65,0.75,selectedAlpha)*(1.-smoothstep(0.85,0.95,selectedAlpha));color=mix(color,SELECTED_OUTLINE_COLOR,selectedMaskAlpha);color=mix(color,HOVER_COLOR,hoveredAlpha*0.3);return color;}void main(){vec4 mask=textureCube(maskTexture,maskPosition.xyz);\n#ifdef DEBUG_BLUR_LEVELS\nmask=vec4(fract(gl_FragCoord.x/2048.),0.,0.,1.);\n#endif\nvec4 blurredColor0=textureCube(panoBlurredMap0,panoPosition.xyz);vec4 blurredColor1=textureCube(panoBlurredMap1,panoPosition.xyz);vec4 blurredColor2=textureCube(panoBlurredMap2,panoPosition.xyz);vec4 blurredColor3=textureCube(panoBlurredMap3,panoPosition.xyz);\n# ifdef DEBUG_BLUR_LEVELS\nif(gl_FragCoord.y>2000.){blurredColor0=vec4(1.,0.,0.,1.);blurredColor1=vec4(0.,1.,0.,1.);blurredColor2=vec4(0.,0.,1.,1.);blurredColor3=vec4(0.,1.,1.,1.);}\n#elif defined(DEBUG_BLUR_COLORS)\nblurredColor0=vec4(1.,0.,0.,1.);blurredColor1=vec4(0.,1.,0.,1.);blurredColor2=vec4(0.,0.,1.,1.);blurredColor3=vec4(0.,1.,1.,1.);\n#endif\ngl_FragColor=combineBlurs(mask,blurredColor0,blurredColor1,blurredColor2,blurredColor3);}"},65697:e=>{e.exports="precision highp float;precision highp int;uniform mat4 modelMatrix;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform mat3 normalMatrix;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;varying vec4 maskPosition;varying vec4 panoPosition;uniform mat4 maskMatrix;uniform mat4 panoMatrix1;uniform mat4 panoMatrix2;void main(){vec4 worldPosition=modelMatrix*vec4(position,1.);maskPosition=maskMatrix*worldPosition;panoPosition=panoMatrix2*panoMatrix1*worldPosition;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},33359:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetVisionAssets"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",alias:{kind:"Name",value:"objectBlur"},name:{kind:"Name",value:"asset"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"StringValue",value:"blurs/suggestions",block:!1}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"status"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"contentType"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"filename"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"format"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"url"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"validUntil"},arguments:[],directives:[]},{kind:"InlineFragment",typeCondition:{kind:"NamedType",name:{kind:"Name",value:"BlurSuggestionAsset"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"version"},arguments:[],directives:[]}]}}]}}]}}]}}],loc:{start:0,end:383}};t.loc.source={body:'# Fetches public output files from the Vision Catalog,\n# only available after platform 21.21.1 release\nquery GetVisionAssets($modelId: ID!) {\n  model(id: $modelId) {\n    objectBlur: asset(id: "blurs/suggestions") {\n      id\n      status\n      contentType\n      filename\n      format\n      url\n      validUntil\n      ... on BlurSuggestionAsset {\n          version\n      }\n    }\n  }\n}\n',name:"GraphQL request",locationOffset:{line:1,column:1}};function s(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var i=e.type;"NamedType"===i.kind&&t.add(i.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){s(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){s(e,t)})),e.definitions&&e.definitions.forEach((function(e){s(e,t)}))}var i={};function a(e,t){for(var s=0;s<e.definitions.length;s++){var i=e.definitions[s];if(i.name&&i.name.value==t)return i}}t.definitions.forEach((function(e){if(e.name){var t=new Set;s(e,t),i[e.name.value]=t}})),e.exports=t,e.exports.GetVisionAssets=function(e,t){var s={kind:e.kind,definitions:[a(e,t)]};e.hasOwnProperty("loc")&&(s.loc=e.loc);var n=i[t]||new Set,r=new Set,o=new Set;for(n.forEach((function(e){o.add(e)}));o.size>0;){var l=o;o=new Set,l.forEach((function(e){r.has(e)||(r.add(e),(i[e]||new Set).forEach((function(e){o.add(e)})))}))}return r.forEach((function(t){var i=a(e,t);i&&s.definitions.push(i)})),s}(t,"GetVisionAssets")},55594:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetVisionCatalog"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"assets"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"catalog"},arguments:[{kind:"Argument",name:{kind:"Name",value:"formats"},value:{kind:"ListValue",values:[{kind:"StringValue",value:"json",block:!1}]}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"format"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"type"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"contentType"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"description"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"url"},arguments:[],directives:[]}]}}]}}]}}]}}],loc:{start:0,end:271}};t.loc.source={body:'# Fetches Vision Catalog assets, restricted to staff users\nquery GetVisionCatalog($modelId: ID!) {\n  model(id: $modelId) {\n    assets {\n      catalog(formats: ["json"]) {\n        format\n        type\n        contentType\n        description\n        url\n      }\n    }\n  }\n}\n',name:"GraphQL request",locationOffset:{line:1,column:1}};function s(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var i=e.type;"NamedType"===i.kind&&t.add(i.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){s(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){s(e,t)})),e.definitions&&e.definitions.forEach((function(e){s(e,t)}))}var i={};function a(e,t){for(var s=0;s<e.definitions.length;s++){var i=e.definitions[s];if(i.name&&i.name.value==t)return i}}t.definitions.forEach((function(e){if(e.name){var t=new Set;s(e,t),i[e.name.value]=t}})),e.exports=t,e.exports.GetVisionCatalog=function(e,t){var s={kind:e.kind,definitions:[a(e,t)]};e.hasOwnProperty("loc")&&(s.loc=e.loc);var n=i[t]||new Set,r=new Set,o=new Set;for(n.forEach((function(e){o.add(e)}));o.size>0;){var l=o;o=new Set,l.forEach((function(e){r.has(e)||(r.add(e),(i[e]||new Set).forEach((function(e){o.add(e)})))}))}return r.forEach((function(t){var i=a(e,t);i&&s.definitions.push(i)})),s}(t,"GetVisionCatalog")}}]);