(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[321],{92011:(e,t)=>{"use strict";var s=t.uO={};s.read=function(e,t){return e.readFields(s._readField,{chunk:[],quantized_chunk:[]},t)},s._readField=function(e,t,s){1===e?t.chunk.push(o.read(s,s.readVarint()+s.pos)):2===e&&t.quantized_chunk.push(d.read(s,s.readVarint()+s.pos))},s.write=function(e,t){if(e.chunk)for(var s=0;s<e.chunk.length;s++)t.writeMessage(1,o.write,e.chunk[s]);if(e.quantized_chunk)for(s=0;s<e.quantized_chunk.length;s++)t.writeMessage(2,d.write,e.quantized_chunk[s])};var i={};i.read=function(e,t){return e.readFields(i._readField,{xyz:[],uv:[]},t)},i._readField=function(e,t,s){1===e?s.readPackedFloat(t.xyz):2===e&&s.readPackedFloat(t.uv)},i.write=function(e,t){e.xyz&&t.writePackedFloat(1,e.xyz),e.uv&&t.writePackedFloat(2,e.uv)};var r={};r.read=function(e,t){return e.readFields(r._readField,{faces:[]},t)},r._readField=function(e,t,s){1===e&&s.readPackedVarint(t.faces)},r.write=function(e,t){e.faces&&t.writePackedVarint(1,e.faces)};var o={};o.read=function(e,t){return e.readFields(o._readField,{vertices:null,faces:null,chunk_name:"",material_name:""},t)},o._readField=function(e,t,s){1===e?t.vertices=i.read(s,s.readVarint()+s.pos):2===e?t.faces=r.read(s,s.readVarint()+s.pos):3===e?t.chunk_name=s.readString():4===e&&(t.material_name=s.readString())},o.write=function(e,t){e.vertices&&t.writeMessage(1,i.write,e.vertices),e.faces&&t.writeMessage(2,r.write,e.faces),e.chunk_name&&t.writeStringField(3,e.chunk_name),e.material_name&&t.writeStringField(4,e.material_name)};var n={};n.read=function(e,t){return e.readFields(n._readField,{quantization:0,translation:[],x:[],y:[],z:[]},t)},n._readField=function(e,t,s){1===e?t.quantization=s.readFloat():2===e?s.readPackedFloat(t.translation):3===e?s.readPackedSVarint(t.x):4===e?s.readPackedSVarint(t.y):5===e&&s.readPackedSVarint(t.z)},n.write=function(e,t){e.quantization&&t.writeFloatField(1,e.quantization),e.translation&&t.writePackedFloat(2,e.translation),e.x&&t.writePackedSVarint(3,e.x),e.y&&t.writePackedSVarint(4,e.y),e.z&&t.writePackedSVarint(5,e.z)};var a={};a.read=function(e,t){return e.readFields(a._readField,{name:"",quantization:0,u:[],v:[]},t)},a._readField=function(e,t,s){1===e?t.name=s.readString():2===e?t.quantization=s.readFloat():3===e?s.readPackedSVarint(t.u):4===e&&s.readPackedSVarint(t.v)},a.write=function(e,t){e.name&&t.writeStringField(1,e.name),e.quantization&&t.writeFloatField(2,e.quantization),e.u&&t.writePackedSVarint(3,e.u),e.v&&t.writePackedSVarint(4,e.v)};var h={};h.read=function(e,t){return e.readFields(h._readField,{faces:[]},t)},h._readField=function(e,t,s){1===e&&s.readPackedSVarint(t.faces)},h.write=function(e,t){e.faces&&t.writePackedSVarint(1,e.faces)};var d={};d.read=function(e,t){return e.readFields(d._readField,{chunk_name:"",material_name:"",vertices:null,uvs:[],faces:null},t)},d._readField=function(e,t,s){1===e?t.chunk_name=s.readString():2===e?t.material_name=s.readString():3===e?t.vertices=n.read(s,s.readVarint()+s.pos):4===e?t.uvs.push(a.read(s,s.readVarint()+s.pos)):5===e&&(t.faces=r.read(s,s.readVarint()+s.pos))},d.write=function(e,t){if(e.chunk_name&&t.writeStringField(1,e.chunk_name),e.material_name&&t.writeStringField(2,e.material_name),e.vertices&&t.writeMessage(3,n.write,e.vertices),e.uvs)for(var s=0;s<e.uvs.length;s++)t.writeMessage(4,a.write,e.uvs[s]);e.faces&&t.writeMessage(5,r.write,e.faces)}},39173:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>v});var i=s(57227),r=s(14877),o=s(9986),n=s(39808),a=s(53549),h=s(37363),d=s(36742),l=s(65171),u=s(38950),c=s(12757),m=s(84586),p=s(92214),g=s(50084),f=s(65270),M=s(51167),y=s(83229),T=s(73694),x=s(30650),w=s(22878);class ModelMeshQualityModule extends i.Y{constructor(){super(...arguments),this.name="mesh-quality",this.updateMaxQuality=(()=>{let e,t,s;return({modeChange:i,criticalChange:r,interactionChange:o})=>{void 0!==r&&(t=r),void 0!==i&&(e=i),void 0!==o&&(s=o);const n=s===M.s.VrOrientOnly||s===M.s.VrWithController||s===M.s.VrWithTrackedController,a=this.modelMeshModule.stats().textureCount<=this.config.textureLODThreshold?Math.max(y.S7.ULTRA,this.config.maxQuality):y.S7.MEDIUM,h=Math.max(a,e===w.Ey.Panorama&&0===this.meshData.meshTextureOpacity.value?a:this.config.maxQuality);this.modelMeshModule.setTextureLimits(a,h);const d=this.viewmodeData.currentMode!==w.Ey.Dollhouse&&this.viewmodeData.currentMode!==w.Ey.Floorplan,l=this.viewmodeData.transition.active&&(0,w.Bw)(this.viewmodeData.transition.to);n||l||t&&d?this.modelMeshModule.setTextureStreamMode(T.l.NONE):this.modelMeshModule.setTextureStreamMode(this.config.textureLOD)}})()}async init(e,t){this.config=e,this.engine=t,[this.modelMeshModule,this.meshData,this.viewmodeData,this.sweepData,this.appData]=await Promise.all([t.getModuleBySymbol(r.y.MODEL_MESH),t.market.waitForData(n._),t.market.waitForData(h.O),t.market.waitForData(a.Z),t.market.waitForData(o.pu)]),this.bindAppEventsToTextureQuality(),this.bindAppEventsToTextureVisibility(),this.updateMaxQuality({})}bindAppEventsToTextureQuality(){let e=0;this.bindings.push(this.meshData.onChanged((t=>{t.meshTextureOpacity.value!==e&&this.updateMaxQuality({}),e=t.meshTextureOpacity.value})),this.appData.onPropertyChanged("phase",(()=>{this.updateMaxQuality({})})),this.engine.subscribe(p.Z,(e=>{this.updateMaxQuality({criticalChange:!0,modeChange:e.toMode})})),this.engine.subscribe(g.Z,(e=>{this.updateMaxQuality({criticalChange:!1,modeChange:e.toMode})})),this.engine.subscribe(m.oR,(()=>{this.updateMaxQuality({criticalChange:!0})})),this.engine.subscribe(m.NR,(()=>{this.updateMaxQuality({criticalChange:!1})})),this.engine.subscribe(l.Z,(()=>{this.updateMaxQuality({criticalChange:!0})})),this.engine.subscribe(u.Z,(()=>{this.updateMaxQuality({criticalChange:!1})})),this.engine.subscribe(d.m,(e=>{this.updateMaxQuality({interactionChange:e.mode})})))}bindAppEventsToTextureVisibility(){this.bindings.push(this.engine.subscribe(p.Z,(e=>{this.updateRenderMode()})),this.engine.subscribe(c.Z,(e=>{const t=this.sweepData.isSweepUnaligned(e.toSweep);t!==this.sweepData.isSweepUnaligned(e.fromSweep)&&this.modelMeshModule.setRenderMode(t?x.k.PanoramaCube:x.k.PanoramaMesh)})))}updateRenderMode(){const e=this.viewmodeData.currentMode===w.Ey.Panorama||this.viewmodeData.transition.to===w.Ey.Panorama,t=e?x.k.PanoramaMesh:x.k.Mesh,s=e?f.Q9:f.w2;this.modelMeshModule.setRenderMode(t,s)}}const v=ModelMeshQualityModule},83012:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>MeshApiFixupModule});var i=s(57227),r=s(14877),o=s(39823),n=s(39808),a=s(53549);class MeshApiFixupModule extends i.Y{constructor(){super(...arguments),this.name="mesh-api-data-fixups"}async init(e,t){const{market:s}=t;[this.floorData,this.sweepData,this.meshData,this.meshQuery]=await Promise.all([s.waitForData(o.i),s.waitForData(a.Z),s.waitForData(n._),t.getModuleBySymbol(r.y.MESH_QUERY),t.getModuleBySymbol(r.y.MODEL_MESH)]),this.assignSweepToFloors(),this.assignBoundingBoxesToFloors(),this.assignMissingSweepFloors()}assignBoundingBoxesToFloors(){const e=[...this.meshData.meshGroups.floors];this.floorData.iterate(((t,s)=>{const i=e.find((e=>e.meshGroup===t.meshGroup));i&&t.setBounds(i.boundingBox)})),this.floorData.commit()}assignMissingSweepFloors(){this.sweepData.getSweepList().forEach((e=>{var t;if(e.isUnplaced())return;let s;if(null===e.floorId||!this.floorData.hasFloor(e.floorId)){const i=this.meshQuery.floorIdFromObject(null===(t=this.meshQuery.nearestMeshInfo(e.position))||void 0===t?void 0:t.object);i&&this.floorData.hasFloor(i)&&(s=this.floorData.getFloor(i)),(null==s?void 0:s.id)&&s.id!==e.floorId&&(this.log.debug(`Setting ${e.alignmentType} sweep ${e.id} from floor ${e.floorId} to ${s.id}`),e.floorId=s.id,e.commit())}}))}assignSweepToFloors(){this.sweepData.getSweepList().forEach((e=>{var t;if(!e.isUnplaced()&&e.isAligned()){let s;if(e.floorId&&this.floorData.hasFloor(e.floorId))s=this.floorData.getFloor(e.floorId);else{const i=this.meshQuery.floorIdFromObject(null===(t=this.meshQuery.nearestMeshInfo(e.position))||void 0===t?void 0:t.object);i&&this.floorData.hasFloor(i)&&(s=this.floorData.getFloor(i))}s&&s.addSweep(e.position,e.floorPosition)}})),this.floorData.commit()}}},60137:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>MeshQueryModule});var i=s(57227),r=s(14877),o=s(29755),n=s(39823);const a=(...e)=>function(t){return e.every((e=>e(t)))};var h=s(88965),d=s(2212);class MeshQueryModule extends i.Y{constructor(){super(...arguments),this.name="mesh-query"}async init(e,t){const{market:s}=t;[this.raycaster,this.floorData,this.roomData]=await Promise.all([t.getModuleBySymbol(r.y.RAYCASTER),s.waitForData(n.i),s.waitForData(o.Z)])}nearestMeshInfoOnFloor(e,t){const s=a(h.$4.isRoomMesh,this.matchesFloorId(t));return this.raycaster.picking.nearest((new d.Vector3).set(e.x,e.y,e.z),s)}nearestMeshInfo(e){return this.raycaster.picking.nearest((new d.Vector3).set(e.x,e.y,e.z),h.$4.isRoomMesh)}inferMeshIdsFromPoint(e,t){const s=!e.roomId||!this.roomData.get(e.roomId),i=!e.floorId||!this.floorData.hasFloor(e.floorId);if(s||i){const r=i?h.$4.isRoomMesh:a(h.$4.isRoomMesh,this.matchesFloorId(e.floorId)),o=this.raycaster.picking.nearest((new d.Vector3).set(t.x,t.y,t.z),r),n=o&&this.roomIdFloorIdFromObject(o.object);if(n){const{roomId:t,floorId:r}=n;this.log.debug("data-fixup:",s?{roomId:t,prev:e.roomId}:"",i?{floorId:r,prev:e.floorId}:"",{data:e}),s&&(e.roomId=t),i&&(e.floorId=r)}else this.log.warn("Nearest Room/Floor not found for:",{point:t,data:e,invalidRoomId:s,invalidFloorId:i})}return e}roomIdFloorIdFromObject(e){if(!h.$4.hasMeshGroup(e))return;const t=this.floorData.getFloorByMeshGroup(e.meshGroup);if(void 0===t)return;const s=h.$4.hasMeshSubgroup(e)?this.roomData.getByMeshSubgroup(e.meshSubgroup):void 0;return{floorId:t.id,roomId:null==s?void 0:s.id}}floorIdFromObject(e){if(h.$4.hasMeshGroup(e)){const t=this.floorData.getFloorByMeshGroup(e.meshGroup);return null==t?void 0:t.id}}mdsRoomIdFromObject(e){if(!h.$4.hasMeshSubgroup(e)||!h.$4.hasMeshGroup(e))return;const t=this.roomData.getByMeshSubgroup(e.meshSubgroup);if(!t)return;const s=this.floorData.getFloorByMeshGroup(e.meshGroup);return t.floorId===(null==s?void 0:s.id)?t.id:void 0}mdsFloorIdFromObject(e){if(!h.$4.hasMeshGroup(e))return;const t=this.floorData.getFloorByMeshGroup(e.meshGroup);return t?t.id:void 0}matchesFloorId(e){return t=>{const s=this.roomIdFloorIdFromObject(t);return(null==s?void 0:s.floorId)===e}}}},92865:(e,t,s)=>{"use strict";s.d(t,{r:()=>MeshTrim});var i=s(98254),r=s(81402),o=s(2212);class MeshTrim extends i.T{constructor(e,t,s,i,n,a,h=new Date,d=new Date,l,u,c,m){super(),this.position=e,this.scale=t,this.rotation=s,this.enabled=n,this.meshGroup=a,this.created=h,this.modified=d,this.discardContents=!0,this.activeInPanoMode=!0,this._rotationMatrix=new o.Matrix4,this.id=l||`${this.meshGroup}`+(0,r.O1)(11),this.index=i,this.name=u,this.discardContents=void 0===c||c,this.activeInPanoMode=void 0===m||m}get sid(){return this.id}updateRotationMatrix(){const e=this.rotation,t=this.rotation.clone().set(e.x,e.y,e.z,-e.w);this._rotationMatrix.makeRotationFromQuaternion(t.normalize())}get rotationMatrix(){return this.updateRotationMatrix(),this._rotationMatrix}}},28287:(e,t,s)=>{"use strict";s.d(t,{A:()=>CreateMeshTrimCommand,yg:()=>DeleteMeshTrimCommand,dg:()=>MoveMeshTrimToAllFloorsCommand});var i=s(93037);class CreateMeshTrimCommand extends i.m{constructor(e){super(),this.payload=e,this.id="CREATE_MESH_TRIM"}}class DeleteMeshTrimCommand extends i.m{constructor(e){super(),this.payload=e,this.id="DELETE_MESH_TRIM"}}class MoveMeshTrimToAllFloorsCommand extends i.m{constructor(e){super(),this.payload=e,this.id="MOVE_MESH_TRIM_ALL_FLOORS"}}},55707:(e,t,s)=>{"use strict";s.d(t,{Z:()=>MeshTrimData});var i=s(35424),r=s(29984),o=s(66910),n=s(43543),a=s(81674),h=s(5477),d=s(49926),l=s(91183);const u=new h.Z("MeshTrimData");class MeshTrimData extends i.V{constructor(e,t){super(),this.maxTrimsPerFloor=a.t,this.maxAllFloorsTrims=a.t,this.numberOfTrims=0,this.meshTrimsByMeshGroup=new o.v,this.meshTrimsById=new o.v,this.onMeshGroupChangedCallbacks=new Set,this.onMeshTrimChangedCallbacks=new Set,this.updateMeshTrim=e=>{for(const t of this.onMeshTrimChangedCallbacks)t(e)},this.notifyMeshGroupChanges=e=>{for(const t of this.onMeshGroupChangedCallbacks)t(e)};for(const e of t){const t=new r.d;this.meshTrimsByMeshGroup.set(`${e}`,t)}1===t.length&&(this.singleFloorMeshGroup=t[0]),this.meshTrimsByMeshGroup.set(`${n.eh}`,new r.d);try{this.add(...Object.values(e))}catch(e){}}add(...e){const t=new Set;let s=!1;if(this.meshTrimsById.atomic((()=>{this.meshTrimsByMeshGroup.atomic((()=>{for(const i of e){void 0!==this.singleFloorMeshGroup&&(i.meshGroup=this.singleFloorMeshGroup);const e=i.meshGroup===n.eh,o=`${i.meshGroup}`;this.meshTrimsByMeshGroup.has(o)||this.meshTrimsByMeshGroup.set(o,new r.d);const a=this.meshTrimsByMeshGroup.get(o);a.length<(e?this.maxAllFloorsTrims:this.maxTrimsPerFloor)?(a.push(i),this.meshTrimsById.set(i.id,i),t.add(i.meshGroup),i.onChanged(this.updateMeshTrim)):(u.debugWarn("Trims exceed floor limit (trimId, meshGroup):",i.id,i.meshGroup),s=!0)}}))})),t.forEach((e=>{const t=this.meshTrimsByMeshGroup.get(`${e}`);this.sortList(t),this.reassignIndexes(t),this.notifyMeshGroupChanges(e)})),this.updateDerivedProperties(),this.commit(),s)throw new d.M("Exceeding max trims")}delete(...e){const t=new Set;this.meshTrimsByMeshGroup.atomic((()=>{for(const s of e){const e=this.meshTrimsByMeshGroup.get(`${s.meshGroup}`),i=e.indexOf(s);if(i>=0){e.splice(i,1)[0].enabled=!1,t.add(s.meshGroup),s.removeOnChanged(this.updateMeshTrim)}else u.error("Could not delete mesh trim:"+s.id)}})),t.forEach((e=>{const t=this.meshTrimsByMeshGroup.get(`${e}`);this.reassignIndexes(t),this.notifyMeshGroupChanges(e)})),this.meshTrimsById.atomic((()=>{e.forEach((e=>{this.meshTrimsById.delete(e.id)}))})),this.updateDerivedProperties(),this.commit()}updateDerivedProperties(){this.numberOfTrims=this.meshTrimsById.length,this.maxTrimsPerFloor=a.t-this.meshTrimsByMeshGroup.get(`${n.eh}`).length,this.maxAllFloorsTrims=a.t-this.getLongestTrimListLength()}onMeshGroupChanged(e){return(0,l.k1)((()=>this.onMeshGroupChangedCallbacks.add(e)),(()=>this.onMeshGroupChangedCallbacks.delete(e)))}onMeshTrimChanged(e){return(0,l.k1)((()=>this.onMeshTrimChangedCallbacks.add(e)),(()=>this.onMeshTrimChangedCallbacks.delete(e)))}getTrimById(e){return this.meshTrimsById.get(e)}getTrim(e,t){return this.meshTrimsByMeshGroup.has(`${e}`)?this.meshTrimsByMeshGroup.get(`${e}`).get(t):null}getTrimsForMeshGroup(e){return this.meshTrimsByMeshGroup.has(`${e}`)?this.meshTrimsByMeshGroup.get(`${e}`).values():[]}reassignIndexes(e){e.forEach(((e,t)=>{e.index=t}))}sortList(e){e.sort(((e,t)=>e.index-t.index))}getLongestTrimListLength(){let e=0;return this.meshTrimsByMeshGroup.keys.forEach((t=>{if(t===`${n.eh}`)return;const s=this.meshTrimsByMeshGroup.get(t);e=Math.max(s.length,e)})),e}}},49926:(e,t,s)=>{"use strict";s.d(t,{M:()=>TooManyTrimsError});var i=s(40603);class TooManyTrimsError extends i.y{constructor(e){super(e),this.name="TooManyTrimsError"}}},52327:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>MeshTrimDataModule});var i=s(57227),r=s(18537),o=s(67495),n=s(60673),a=s(11325),h=s(3786),d=s(37796),l=s(10854),u=s(55707);class CollectionSerializer{constructor(e){this.config=e}serialize(e){const{serializer:t}=this.config;if(!e||!t)return null;const s={};for(const i in e){const r=t.serialize(e[i]);r&&(s[i]=r)}return s}deserialize(e){const{deserializer:t}=this.config;if(!e||!t)return{};const s={};for(const i in e){const r=t.deserialize(e[i]);r&&(s[i]=r)}return s}}var c=s(46265),m=s(63387),p=s(63336),g=s(92865);const f=new(s(5477).Z)("JsonStoreMeshTrimDeserializer"),M=[{path:["position","x"],type:"number"},{path:["position","y"],type:"number"},{path:["position","z"],type:"number"},{path:["scale","x"],type:"number"},{path:["scale","y"],type:"number"},{path:["scale","z"],type:"number"},{path:["rotation","x"],type:"number"},{path:["rotation","y"],type:"number"},{path:["rotation","z"],type:"number"},{path:["rotation","w"],type:"number"},{path:["index"],type:"number"},{path:["enabled"],type:"boolean"},{path:["meshGroup"],type:"number"},{path:["id"],type:"string"},{path:["created"],type:"string"},{path:["modified"],type:"string"}];class JsonStoreMeshTrimDeserializer{constructor(){this.deserialize=e=>{if(!this.isValid(e))return f.debug("Unable to deserialize invalid mesh trim data",e),null;const{position:t,scale:s,rotation:i,index:r,enabled:o,meshGroup:n,created:a,modified:h,id:d,name:l,discardContents:u,activeInPanoMode:c}=e;return new g.r(m.ep.fromVisionVector(t),m.ep.fromVisionVector(s),m.ep.fromVisionQuaternion(i),r,o,n,(0,p.p)(a),(0,p.p)(h),d,l,u,c)}}isValid(e){if(!e||"object"!=typeof e)return!1;const t=e;return void 0===t.meshGroup&&(t.meshGroup=t.floorIndex),M.every((t=>this.hasRequiredField(e,t)))}hasRequiredField(e,t){try{return typeof t.path.reduce(((s,i)=>{if("object"==typeof s&&null!==s)return s[i];throw new Error(`data ${JSON.stringify(e)} must be addressable by ${t.path.join(".")} with a value of type ${t.type}`)}),e)===t.type}catch(e){return f.debug(e),!1}}}var y=s(65);class JsonStoreMeshTrimSerializer{serialize(e){if(!e)return null;const{position:t,scale:s,rotation:i,index:r,enabled:o,meshGroup:n,created:a,modified:h,id:d,name:l,discardContents:u,activeInPanoMode:c}=e;return{position:(0,y.m)(m.ep.toVisionVector(t)),scale:(0,y.m)(m.ep.toVisionVector(s)),rotation:(0,y.J5)(m.ep.toVisionQuaternion(i)),index:r,enabled:o,meshGroup:n,created:(0,p.U)(a),modified:(0,p.U)(h),id:d,name:l,discardContents:u,activeInPanoMode:c}}}class JsonMeshTrimStore extends c.MU{constructor(e,t,s){const i=new JsonStoreMeshTrimDeserializer,r=new JsonStoreMeshTrimSerializer,o=new CollectionSerializer({deserializer:i,serializer:r});super({queue:e,path:`${t}/api/v1/jsonstore/model/trims/${s}`,batchUpdate:!0,deserialize:e=>o.deserialize(e),serialize:e=>o.serialize(e)})}}var T=s(28287),x=s(49926),w=s(43543),v=s(39808);const{TRIM:b}=l.Z.WORKSHOP;class MeshTrimDataModule extends i.Y{constructor(){super(...arguments),this.name="trim-data",this.createMeshTrim=async e=>{try{this.data.add(e)}catch(e){if(e instanceof x.M){const e=b.MAX_TRIMS_ERROR_MESSAGE;this.engine.commandBinder.issueCommand(new h.I(e,{throttle:0,type:a.N.ERROR}))}}},this.deleteMeshTrim=async e=>{this.data.delete(e)},this.save=async()=>{const e=this.monitor.getDiffRecord();if(this.monitor.clearDiffRecord(),!e.length)return;const t={};for(const s of e)switch(s.action){case n.KI.added:case n.KI.updated:t[s.index]=this.data.getTrimById(s.index);break;case n.KI.removed:t[s.index]=null}try{await this.store.update(t)}catch(e){this.log.debug("error when writing to json storage"),this.log.debug(e);const t=b.UNABLE_TO_SAVE_CHANGES_ERROR_MESSAGE;this.engine.commandBinder.issueCommand(new h.I(t,{throttle:30,type:a.N.ERROR}))}},this.moveMeshTrimToAllFloors=async e=>{const t=e.enabled;this.deleteMeshTrim(e),e.meshGroup=w.eh,e.enabled=t,this.createMeshTrim(e)},this.onMeshTrimsChanged=(0,d.P)(this.save,1e3)}async init(e,t){this.engine=t,this.store=new JsonMeshTrimStore(e.queue,e.baseUrl,e.modelId);let s={};try{s=await this.store.read()||{}}catch(e){this.log.debug("error when reading from json storage"),this.log.debug(e)}const i=[...(await t.market.waitForData(v._)).meshGroups.floors].map((e=>e.meshGroup)).sort();this.data=new u.Z(s,i),this.monitor=new o.c(this.data.meshTrimsById,{aggregationType:r.E.Immediate}),t.market.register(this,u.Z,this.data),this.bindings.push(t.commandBinder.addBinding(T.A,this.createMeshTrim),t.commandBinder.addBinding(T.yg,this.deleteMeshTrim),t.commandBinder.addBinding(T.dg,this.moveMeshTrimToAllFloors)),this.monitor.onChanged(this.onMeshTrimsChanged)}}},37675:(e,t,s)=>{"use strict";s.d(t,{z:()=>Chunk});var i=s(2212),r=s(81674),o=s(88807);class ChunkMaterial extends o.b{constructor(e,t,s){const i={};for(const e of t)i[e]=!0;super({extensions:{derivatives:!0},fragmentShader:r.Z.modelChunk.fragmentShader,vertexShader:r.Z.modelChunk.vertexShader,uniforms:s,name:e,defines:i}),this.capabilities=t}}var n=s(73201),a=s(23616),h=s(81402),d=s(56483),l=s(91183),u=s(60050),c=s(24838);function m(e,t){return null==t?t:t.isVector3||t.isVector4||t.isMatrix3||t.isMatrix4||t.isColor?null!=e?(e.copy(t),e):t.clone():t}let p,g=1;try{p=(0,a.k7)(0,0)}catch(e){}let f=1/0;const M=5+r.t,y=[{key:n.h.PanoTextureTransition,enabled:function(e){return e.progress.value>0&&e.progress.value<1&&e.pano0Map.value!==e.pano1Map.value},dependsOn:[n.h.PanoTexture],uniformsUsed:["progress","pano0Map","pano1Map"]},{key:n.h.PanoTexture,enabled:function(e){return e.panoOpacity.value>0},dependsOn:[],uniformsUsed:["panoOpacity"]},{key:n.h.ColorOverlay,enabled:function(e){return null!==e.colorOverlay.value},dependsOn:[],uniformsUsed:["colorOverlay"]},{key:n.h.MeshPreviewSphere,enabled:function(e){return null!==e.meshPreviewCenter.value},dependsOn:[n.h.MeshTexture],uniformsUsed:[]},{key:n.h.MeshTexture,enabled:function(e){return e.meshOpacity.value>0&&e.map.value},dependsOn:[],uniformsUsed:["meshOpacity","map"]},{key:n.h.Wireframe,enabled:function(e){return!1},dependsOn:[],uniformsUsed:[]},{key:n.h.FlatShading,enabled:function(e){return!1},dependsOn:[],uniformsUsed:[]},{key:n.h.PanoOverlay,enabled:function(e){return!!e.overlay0Map.value},dependsOn:[n.h.PanoTexture],uniformsUsed:["overlay0Map"]},{key:n.h.PanoOverlayTransition,enabled:function(e){return!!(e.progress.value>0&&e.progress.value<1&&e.overlay0Map.value&&e.overlay1Map.value&&e.overlay0Map.value!==e.overlay1Map.value)},dependsOn:[n.h.PanoOverlay,n.h.PanoTexture,n.h.PanoTextureTransition],uniformsUsed:["progress","overlay0Map","overlay1Map"]},{key:n.h.MeshTrimVertex,enabled:function(e){return f>M&&e.meshTrimMatrices.value.some((e=>!!e.elements[15]))},dependsOn:[n.h.MeshTexture],uniformsUsed:["meshTrimMatrices","meshTrimsDiscardContents"]},{key:n.h.MeshTrimPixel,enabled:function(e){return f<=M&&e.meshTrimMatrices.value.some((e=>!!e.elements[15]))},dependsOn:[n.h.MeshTexture],uniformsUsed:["meshTrimMatrices","meshTrimsDiscardContents"]}],T=new Set(y.map((e=>e.uniformsUsed)).reduce(((e,t)=>e.concat(t)),[])),x=new Set(["progress","panoOpacity","meshOpacity","pano0Map","pano0Position","pano0Matrix1","pano0Matrix2","pano1Map","pano1Position","pano1Matrix1","pano1Matrix2","overlay0Map","overlay0Matrix","overlay1Map","overlay1Matrix"]);class Chunk{constructor(e,t,s,o="",n=!1){if(this.meshGroup=e,this.meshSubgroup=t,this.geometry=s,this.textureName=o,this.id=g++,this.name="",this.lod=u.V.Standard,this.capabilityOverrides={},this.onMaterialUpdate=new Set,this.uniformCache=Chunk.getUniformDefaults(),this.opacity=1,this.temp={m1:new i.Matrix4,m2:new i.Matrix4,quat:new i.Quaternion},!Chunk.modeMaterials){Chunk.modeMaterials={};const e=i.UniformsUtils.clone(r.Z.depth.uniforms);Chunk.modeMaterials[c.S.Depth]=new i.RawShaderMaterial({fragmentShader:r.Z.depth.fragmentShader,vertexShader:r.Z.depth.vertexShader,uniforms:e,side:i.FrontSide,name:"materialDepth"});const t=i.UniformsUtils.clone(r.Z.modelOutside.uniforms);t.opacity.value=.2,t.colorOverlay.value.set(1,1,1,1),Chunk.modeMaterials[c.S.Transparent]=new i.RawShaderMaterial({fragmentShader:r.Z.modelOutside.fragmentShader,vertexShader:r.Z.modelOutside.vertexShader,uniforms:t,side:i.FrontSide,transparent:!0,name:"materialTransparent"});const s=i.UniformsUtils.clone(r.Z.modelOutside.uniforms);s.opacity.value=.5,s.colorOverlay.value.set(1,1,1,1),Chunk.modeMaterials[c.S.Wireframe]=new i.RawShaderMaterial({fragmentShader:r.Z.modelOutside.fragmentShader,vertexShader:r.Z.modelOutside.vertexShader,uniforms:s,side:i.FrontSide,transparent:!0,wireframe:!0,name:"materialWireframe"})}this.standardMaterial=this.getChunkMaterial(this.getCapabilities(),!1,!1),this.updateRenderingMode(),n&&this.setMaterialsUniform(Chunk.globalUniforms)}static setSide(e){const t=Chunk.side;Chunk.side=e;for(const t in Chunk.chunkMaterials){Chunk.chunkMaterials[t].name.includes("f")||(Chunk.chunkMaterials[t].side=e)}return t}static setRenderingMode(e){Chunk.renderingMode=e}static setMaxVaryings(e){f=e}static disposeShared(){for(const e in Chunk.chunkMaterials){const t=Chunk.chunkMaterials[e];for(const e in t.uniforms)"t"===t.uniforms[e].type&&t.uniforms[e].value.dispose();t.dispose(),delete Chunk.chunkMaterials[e]}}dispose(){this.geometry.dispose()}static getUniformDefaults(){const e={};for(const t in r.Z.modelChunk.uniforms){const s=i.UniformsUtils.clone(r.Z.modelChunk.uniforms[t]);for(const t in s)e[t]=s[t]}return e}set material(e){if(this._material!==e&&this.onMaterialUpdate)for(const t of this.onMaterialUpdate.values())t(e);this._material=e}get material(){return this._material}notifyOnMaterialUpdated(e){return(0,l.k1)((()=>this.onMaterialUpdate.add(e)),(()=>this.onMaterialUpdate.delete(e)),!0)}setMeshTexture(e){this.setMaterialsUniform({map:e})}getColorOverlay(){return this._colorOverlay}setColorOverlay(e){this._colorOverlay!==e&&(this.setMaterialsUniform({colorOverlay:e}),this._colorOverlay=e)}setMeshTextureOpacity(e){e!==this._meshTextureOpacity&&(this.setMaterialsUniform({meshOpacity:e,panoOpacity:1-e}),this._meshTextureOpacity=e)}setProgress(e){this._progress!==e&&(this.setMaterialsUniform({progress:e}),this._progress=e)}opacityParams(){return{needTransparent:this.opacity<d.xx.FADE_OPAQUE,needDepthWrite:this.opacity>=d.xx.FADE_DEPTH_WRITE_THRESHOLD}}setOpacity(e){this.opacity=e;const{needTransparent:t,needDepthWrite:s}=this.opacityParams();return this.onOpacityUpdate&&this.onOpacityUpdate(e),t!==this._material.transparent||s!==this._material.depthWrite}getOpacity(){return this.opacity}setTime(e){Chunk.renderingMode===c.S.Wireframe&&this.setMaterialsUniform({time:e})}setTransparentDiscard(e){this.setMaterialsUniform({transparentDiscardDist:e})}setMeshPreviewSphere(e,t=.3){this.setMaterialsUniform({meshPreviewCenter:e,meshPreviewSize:t})}setWireframe(e){if(e){if(this.geometry.getIndex()){const e=this.geometry;e.boundsTree&&(e.boundsTree.geometry=this.geometry.clone()),this.geometry.copy(this.geometry.toNonIndexed())}(0,a.ko)(this.geometry)}this.overrideCapability(n.h.Wireframe,e)}setFlatShading(e){e&&this.geometry.computeVertexNormals(),this.overrideCapability(n.h.FlatShading,e)}getCapabilities(){const e=new Set;for(const t in this.capabilityOverrides)this.capabilityOverrides[t]&&e.add(t);for(const t of y)if(!e.has(t.key)&&t.enabled(this.uniformCache)){e.add(t.key);for(const s of t.dependsOn)e.add(s)}return e}overrideCapability(e,t){this.capabilityOverrides[e]=t,this.updateMaterialCapabilities()}updateMaterialCapabilities(){const e=this.getCapabilities(),t=this.standardMaterial,{needTransparent:s,needDepthWrite:i}=this.opacityParams();if((0,h.TH)(t.capabilities,e)&&s===t.transparent&&i===t.depthWrite)return this._material;const r=this.getChunkMaterial(e,s,i);return this.standardMaterial=r,Chunk.renderingMode===c.S.Standard&&(this.material=r),this._material}getChunkMaterial(e,t,s){let r="chunkMaterial_";for(const t of y)r+=e.has(t.key)?"1":"0";const o=-1===this.meshGroup&&-1===this.meshSubgroup;if(o?r+="f":(r+=t?"1":"0",r+=s?"1":"0"),!Chunk.chunkMaterials[r]){const n=new ChunkMaterial(r,e,this.getUniformsForCapabilities(e));o?(n.side=i.BackSide,n.transparent=!0,n.depthWrite=!1):(n.transparent=t,n.depthWrite=s,n.side=Chunk.side),Chunk.chunkMaterials[r]=n}return Chunk.chunkMaterials[r]}getUniformsForCapabilities(e){const t={};for(const s of e){const e=r.Z.modelChunk.uniforms[s];for(const s in e)t[s]=i.UniformsUtils.clone(this.uniformCache[s])}return t}setMaterialsUniform(e,t=!1){let s,i=!1;const r=this.uniformCache.meshPreviewCenter.value;for(const o in e){let n=!1;const a=e[o];if(n="meshPreviewCenter"!==o?n||T.has(o):n||null===r!=(null===a),!(o in this.uniformCache))throw new Error(`Uniform ${o} does not exist in Chunk`);const h=this.uniformCache[o];h.value!==a&&(h.value=m(h.value,a),"opacity"===o&&(s=a),t&&x.has(o)&&(Chunk.globalUniforms[o]=m(Chunk.globalUniforms[o],a)),i=i||n)}return void 0!==s&&(i=this.setOpacity(s)||i),i&&this.updateMaterialCapabilities(),this._material}updateRenderingMode(){Chunk.renderingMode===c.S.Standard?this.material=this.standardMaterial:this.material=Chunk.modeMaterials[Chunk.renderingMode]}forEachMaterial(e){for(const t in Chunk.chunkMaterials)e(Chunk.chunkMaterials[t])}setProjectedPano(e,t,s,i,r=!1){let o=1===e?"pano1Map":"pano0Map";const n={};n[o]=i||p,t&&(o=1===e?"pano1Position":"pano0Position",n[o]=t),s&&t&&(o=1===e?"pano1Matrix":"pano0Matrix",this.temp.m1.makeRotationFromQuaternion(this.temp.quat.copy(s).invert()),this.temp.m2.makeScale(-1,1,1),n[`${o}1`]=this.temp.m1,n[`${o}2`]=this.temp.m2),this.setMaterialsUniform(n,r)}setOverlayPano(e,t,s,r=!1){const o=`overlay${e}`,n={};if(t){const e=(new i.Matrix4).makeRotationFromQuaternion(t);n[o+"Matrix"]=e}n[o+"Map"]=s||p,this.setMaterialsUniform(n,r)}onBeforeDraw(e){if(Chunk.renderingMode===c.S.Standard){for(const t of Object.keys(e.uniforms))this.uniformCache[t]&&null!==this.uniformCache[t].value&&(e.uniforms[t].value=this.uniformCache[t].value);e.uniformsNeedUpdate=!0}}getSortKey(){var e,t,s;return null!==(s=null===(t=null===(e=this.uniformCache.map)||void 0===e?void 0:e.value)||void 0===t?void 0:t.id)&&void 0!==s?s:0}}Chunk.chunkMaterials={},Chunk.side=i.FrontSide,Chunk.renderingMode=c.S.Standard,Chunk.globalUniforms={}},11887:(e,t,s)=>{"use strict";s.d(t,{T:()=>FallbackMesh});var i=s(2212),r=s(99295),o=s(37675);const n=new i.Vector3(0,0,0),a=new i.Vector3(100,100,100),h=new i.Vector3,d=new i.Vector3,l=new i.Box3;class FallbackMesh extends i.Mesh{constructor(){super(),this.bounds=new i.Box3,this.geometry=new i.BoxBufferGeometry(1,1,1),this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere(),this.chunk=new o.z(-1,-1,this.geometry);const e=e=>{this.material=e};this.chunk.notifyOnMaterialUpdated(e),e(this.chunk.material),this.name="FallbackMesh",this.renderOrder=r.z.boundingSkybox,this.setFromCenterAndSize(n,a),this.onBeforeRender=(e,t,s,r,o,n)=>{o instanceof i.RawShaderMaterial&&this.chunk.onBeforeDraw(o)}}setBounds(e){if(this.bounds.equals(e))return;this.bounds.copy(e);const t=e.getSize(h);this.position.copy(e.getCenter(d)),this.scale.set(t.x,t.y,t.z),this.updateMatrixWorld(!0)}setFromCenterAndSize(e,t=a){this.setBounds(l.setFromCenterAndSize(e,t))}}},76177:(e,t,s)=>{"use strict";s.d(t,{e:()=>ModelMeshBase});var i=s(2212),r=s(91183);class ModelMeshBase extends i.Object3D{constructor(){super(...arguments),this.boundingBox=new i.Box3,this.size=new i.Vector3,this.center=new i.Vector3,this._chunks=[],this.onChunksLoaded=new Set}get chunks(){return this._chunks}get visibleChunks(){return this._chunks}notifyOnChunksLoaded(e){return(0,r.k1)((()=>this.onChunksLoaded.add(e)),(()=>this.onChunksLoaded.delete(e)),!0)}}},87109:(e,t,s)=>{"use strict";s.d(t,{s:()=>RoomMeshData});var i=s(35424);class RoomMeshData extends i.V{constructor(){super(),this.name="room-mesh-data",this.floors=new Set,this.rooms=new Set}}},55187:(e,t,s)=>{"use strict";s.d(t,{n:()=>MeshPreviewSetPositonCommand});var i=s(93037);class MeshPreviewSetPositonCommand extends i.m{constructor(e,t,s){super(),this.id="MESH_PREVIEW_POSITION",this.payload={enabled:e,previewCirclePosition:t,size:s}}}},92450:(e,t,s)=>{"use strict";s.d(t,{u:()=>SetMeshOverlayCommand});var i,r,o=s(93037);!function(e){e.all="all",e.byMeshGroup="byMeshGroup",e.byMeshSubGroup="byMeshSubGroup"}(i||(i={})),function(e){e.explicit="explicit",e.random="random"}(r||(r={}));class SetMeshOverlayCommand extends o.m{constructor(e,t){super(),this.id="SET_MESH_OVERLAY_COLOR",this.payload={selectBy:(null==t?void 0:t.style)||i.all,colorStyle:(null==e?void 0:e.style)||r.explicit,color:(null==e?void 0:e.color)||null,alpha:(null==e?void 0:e.alpha)||.5,index:null==t?void 0:t.index}}}SetMeshOverlayCommand.selectBy=i,SetMeshOverlayCommand.colorBy=r,SetMeshOverlayCommand.COLOR_DIM={x:0,y:0,z:0,w:.3}},80122:(e,t,s)=>{"use strict";s.d(t,{M:()=>SetPanoOverlayCommand});var i=s(93037);class SetPanoOverlayCommand extends i.m{constructor(e,t,s){super(),this.id="SET_PANO_OVERLAY",this.payload={sweepId:e,texture:t,quaternion:s}}}},23186:(e,t,s)=>{"use strict";s.d(t,{I:()=>ToggleMeshOverlayColorCommand});var i=s(93037);class ToggleMeshOverlayColorCommand extends i.m{constructor(e){super(),this.id="TOGGLE_MESH_OVERLAY_COLOR",this.payload={enabled:e}}}},30650:(e,t,s)=>{"use strict";var i;s.d(t,{k:()=>i}),function(e){e.Mesh="mesh",e.PanoramaMesh="mesh.inside",e.PanoramaCube="cubemap.inside",e.Hidden="mesh.hidden"}(i||(i={}))},9245:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>ModelMeshModule});var i=s(57227),r=s(14877),o=s(9986),n=s(77280),a=s(15099),h=s(42374),d=s(97966),l=s(56709),u=s(53549),c=s(55707),m=s(27717),p=s(92214),g=s(50084),f=s(37363),M=s(22878),y=s(65270),T=s(2212),x=s(864);let w=!1;var v=s(55187),b=s(30650),S=s(73694),C=s(39808),k=s(43543),D=s(81674);const R={meshTrimMatrices:[],meshTrimsDiscardContents:[],hasKeepVolume:!1};class MeshTrimUniforms{constructor(e){this.floorUniforms={},this.sharedFloorUniforms={},this.isPanoMode=e}setMeshTrim(e){const{meshGroup:t,index:s,discardContents:i}=e,r=this.getEmptyCacheUniforms(),o=this.getFloorUniforms(t).meshTrimMatrices.slice();this.computeTrimMatrixFromTrim(e,o[s]),r.meshTrimMatrices=o,r.meshTrimsDiscardContents=this.setMeshTrimDiscardContents(t,s,i),this.setFloorUniforms(t,r)}updateMeshTrimArrays(e,t){const s=[],i=[];let r=!1;t.forEach((e=>{s.push(this.computeTrimMatrixFromTrim(e)),i.push(e.discardContents),r||(r=e.enabled&&!e.discardContents)})),this.setFloorUniforms(e,{meshTrimMatrices:s,meshTrimsDiscardContents:i,hasKeepVolume:r});`${e}`==`${k.eh}`?Object.keys(this.sharedFloorUniforms).forEach((e=>{this.updateSharedFloorUniforms(e)})):this.updateSharedFloorUniforms(e)}computeTrimMatrixFromTrim(e,t=new T.Matrix4){return e.enabled&&(!this.isPanoMode||this.isPanoMode&&e.activeInPanoMode)?(t.compose(e.position,e.rotation,e.scale),t.invert()):t.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),t}setMeshTrimDiscardContents(e,t,s){const i=this.getFloorUniforms(e).meshTrimsDiscardContents.slice();return i[t]=s,i}updateSharedFloorUniforms(e){const t=this.getFloorUniforms(e),s=this.getFloorUniforms(k.eh),i=new T.Matrix4;i.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const r=this.concatUniformArrays(s.meshTrimMatrices,t.meshTrimMatrices,i),o=this.concatUniformArrays(s.meshTrimsDiscardContents,t.meshTrimsDiscardContents,!0);this.setSharedFloorUniforms(e,{meshTrimMatrices:r,meshTrimsDiscardContents:o,hasKeepVolume:s.hasKeepVolume||t.hasKeepVolume})}concatUniformArrays(e,t,s){const i=e.concat(t).slice(0,D.t);for(let e=i.length;e<D.t;e++)i.push(s);return i}getFloorUniforms(e){return this.floorUniforms[`${e}`]||this.getEmptyCacheUniforms()}setFloorUniforms(e,t){this.floorUniforms[`${e}`]=t}getSharedFloorUniforms(e){return this.sharedFloorUniforms[`${e}`]||this.getEmptyCacheUniforms()}setSharedFloorUniforms(e,t){this.sharedFloorUniforms[`${e}`]=t}getEmptyCacheUniforms(){return Object.assign({},R)}}var O=s(81402),B=s(28124),F=s(5477),L=s(61903),P=s(81242),_=s(56483),E=s(24838),U=s(73201),I=s(11887),A=s(92450),z=s(23186),G=s(42249),V=s(80122),Q=s(37675);const N=new F.Z("modelrenderer");class ModelRenderer{constructor(e,t,s,i,r,o,n,a){this.scene=e,this.container=t,this.mesh=s,this.panoRenderer=i,this.meshData=r,this.sweepData=o,this.applicationData=n,this.renderOptions=a,this.chunkRenderingModeOverride=null,this.lastChunkRenderingModeOverride=null,this.fallbackMesh=new I.T,this.overlayColors=[],this.toolMeshColorEnabled=!1,this.TOOL_MESH_COLOR_OVERLAY=new T.Vector4(0,0,0,.3),this.overlayTextures=[{sweepId:void 0,texture:void 0,renderTarget:new T.WebGLCubeRenderTarget(2048,{format:T.RGBAFormat}),quaternion:new T.Quaternion},{sweepId:void 0,texture:void 0,renderTarget:new T.WebGLCubeRenderTarget(2048,{format:T.RGBAFormat}),quaternion:new T.Quaternion}],this.overlayEnabled=!1,this.bindings=[],this.updateFallbackMesh=(()=>{const e=new T.Box3;return()=>{if(this.sweepData.currentAlignedSweepObject&&this.viewmodeData.isInside()){const t=e.copy(this.meshData.extendedBounds).expandByScalar(.2);this.fallbackMesh.setBounds(t)}else this.cameraData&&this.fallbackMesh.setFromCenterAndSize(this.cameraData.pose.position)}})(),this.debugColorizeChunks=(()=>{let e=!1;return(t,s)=>{const i=new T.Vector4(1,1,1,0);e=!e,(e=>{for(const t of this.mesh.chunks){const r=s?100*t.id:100*t.meshSubgroup,o=e?(0,B.G1)(.5,r):i;t.setColorOverlay(o)}})(t||e)}})()}init(){}dispose(){}async activate(e){this.engine=e,[this.viewmodeData,this.settings,this.cameraData,this.renderer]=await Promise.all([e.market.waitForData(f.O),e.market.waitForData(L.e),e.market.waitForData(a.M_),e.getModuleBySymbol(r.y.WEBGL_RENDERER)]),this.scene.add(this.container),this.scene.add(this.fallbackMesh),this.fallbackMesh.layers.mask=this.container.layers.mask,this.updateRenderState(),this.bindings.push(this.viewmodeData.onChanged(this.updateRenderState.bind(this)),this.sweepData.onChanged(this.updateRenderState.bind(this)),this.settings.onChanged(this.updateRenderState.bind(this)),e.commandBinder.addBinding(A.u,this.onMeshOverlayCommand.bind(this)),e.commandBinder.addBinding(z.I,this.toggleMeshOverlayColor.bind(this)),e.commandBinder.addBinding(G.U,this.onSetChunkRenderStateCommand.bind(this)),e.commandBinder.addBinding(V.M,this.onPanoOverlayCommand.bind(this))),this.bindings.push(this.mesh.notifyOnChunksLoaded((e=>{for(const t of this.overlayColors)t(e)}))),this.renderOptions.colorizeRooms&&this.debugColorizeChunks(!0),this.renderOptions.colorizeChunks&&this.debugColorizeChunks(!0,!0),this.renderOptions.wireframe&&this.toggleWireframe(!0),this.setupDebugMenu(e)}deactivate(){for(const e of this.bindings)e.cancel();this.bindings=[],this.scene.remove(this.container),this.scene.remove(this.fallbackMesh),this.currentSweepId&&this.panoRenderer.freeTexture(this.currentSweepId),this.currentSweepId=null,this.targetSweepId=null}updateSweepRenderTarget(e,t,s,i){const r=this.panoRenderer.useTexture(t);if(r){let t=!0;for(const o of this.allChunks())o.setProjectedPano(e,s,i,r,t),t=!1}}*allChunks(){yield*this.mesh.chunks,yield this.fallbackMesh.chunk}updateExistingTexture(e,t,s,i){let r=!0;for(const o of this.allChunks())e===this.currentSweepId&&o.setProjectedPano(0,s,i,t,r),e===this.targetSweepId&&o.setProjectedPano(1,s,i,t,r),r=!1}render(){}beforeRender(){var e;const{floorOpacity:t,floorFadeDist:s}=this.meshData.meshGroupVisuals;for(const i of this.mesh.visibleChunks)i.setMaterialsUniform({meshOpacity:this.meshData.meshTextureOpacity.value,panoOpacity:1-this.meshData.meshTextureOpacity.value,opacity:null!==(e=t.get(i.meshGroup))&&void 0!==e?e:1,transparentDiscardDist:s.get(i.meshGroup)||0,progress:this.sweepData.transition.progress.value});const i=(0,y.w2)(this.meshData.meshTextureOpacity.value,0,1,1);this.fallbackMesh.chunk.setMeshTextureOpacity(i),this.fallbackMesh.chunk.setProgress(this.sweepData.transition.progress.value),this.updateFallbackMesh()}updateChunkMaterialMode(e,t){const s=e?T.DoubleSide:T.FrontSide;Q.z.setSide(s),Q.z.setRenderingMode(t||E.S.Standard);for(const e of this.mesh.chunks)e.updateRenderingMode()}updateRenderState(){if(this.viewmodeData.currentMode!==this.lastViewmode||this.lastChunkRenderingModeOverride!==this.chunkRenderingModeOverride){this.lastChunkRenderingModeOverride=this.chunkRenderingModeOverride;const e=this.viewmodeData.isInside();this.updateChunkMaterialMode(e,this.chunkRenderingModeOverride),this.lastViewmode=this.viewmodeData.currentMode}if(this.viewmodeData.transition.active&&(0,M.Bw)(this.viewmodeData.transition.to)||this.viewmodeData.isInside()){const e=this.sweepData.currentSweep,t=this.sweepData.transition,s=t.active&&(this.applicationData.phase===o.nh.PLAYING||this.applicationData.phase===o.nh.STARTING),i=s?t.from:e,r=s?t.to:e,n=this.currentSweepId,a=this.targetSweepId;this.currentSweepId=i||null,this.targetSweepId=r||null,this.handleSweepChange(0,n,this.currentSweepId),this.handleSweepChange(1,a,this.targetSweepId)}if(this.overlayEnabled){const e=this.overlayTextures.find((e=>e.sweepId===this.currentSweepId)),t=this.overlayTextures.find((e=>e.sweepId===this.targetSweepId));let s=!0;for(const i of this.allChunks())i.setOverlayPano(0,e?e.quaternion:void 0,e?e.texture:void 0,s),i.setOverlayPano(1,t?t.quaternion:void 0,t?t.texture:void 0,s),s=!1}}handleSweepChange(e,t,s){if(t!==s&&(t&&this.panoRenderer.freeTexture(t),s)){const t=this.sweepData.getSweep(s);this.updateSweepRenderTarget(e,s,t.position,t.rotation)}}async onPanoOverlayCommand(e){this.overlayEnabled=!0;const t=t=>{const s=t.renderTarget;t.renderTarget.width=e.texture.image.width,t.renderTarget.height=e.texture.image.height,t.sweepId=e.sweepId,t.texture=s.texture,t.quaternion=e.quaternion,this.renderer.cwfRenderer.copyCubemap(e.texture,t.renderTarget)};let s=!1;for(const i of this.overlayTextures)s||i.sweepId!==e.sweepId||(t(i),s=!0);for(const e of this.overlayTextures)s||e.sweepId===this.targetSweepId||e.sweepId===this.currentSweepId||(t(e),s=!0);this.updateRenderState()}async onMeshOverlayCommand(e){let t=()=>!0;switch(e.selectBy){case A.u.selectBy.all:t=()=>!0,this.overlayColors.length=0;break;case A.u.selectBy.byMeshGroup:t=t=>t.meshGroup===e.index;break;case A.u.selectBy.byMeshSubGroup:t=t=>t.meshSubgroup===e.index}if(!t)return;let s="rand";e.colorStyle===A.u.colorBy.explicit&&(s=e.color?new T.Vector4(e.color.x,e.color.y,e.color.z,e.color.w):null);const i=i=>{for(const r of i)t(r)&&r.setColorOverlay("rand"===s?(0,B.G1)(e.alpha):s)};i(this.mesh.chunks),e.selectBy===A.u.selectBy.all&&null===s||this.overlayColors.push(i)}async toggleMeshOverlayColor({enabled:e}){if(e!==this.toolMeshColorEnabled)return this.toolMeshColorEnabled=e,this.onMeshOverlayCommand({color:e?this.TOOL_MESH_COLOR_OVERLAY:null,selectBy:A.u.selectBy.all,colorStyle:A.u.colorBy.explicit,alpha:.5})}async onSetChunkRenderStateCommand(e){this.chunkRenderingModeOverride=e.mode,this.updateRenderState()}toggleWireframe(e){for(const t of this.mesh.chunks)t.setWireframe(e)}async setupDebugMenu(e){const[t,s]=await Promise.all([e.market.waitForData(L.e),e.getModuleBySymbol(r.y.SETTINGS)]);s.registerButton("Mesh","Toggle visible",(()=>{this.container.visible=!this.container.visible})),s.registerButton("Mesh","Toggle depth",(()=>{const t=this.chunkRenderingModeOverride?null:E.S.Depth;e.commandBinder.issueCommand(new G.U(t))})),s.registerButton("Mesh","Toggle transparent",(()=>{const t=this.chunkRenderingModeOverride?null:E.S.Transparent;e.commandBinder.issueCommand(new G.U(t))})),s.registerButton("Mesh","Toggle wireframe",(()=>{const t=this.chunkRenderingModeOverride?null:E.S.Wireframe;e.commandBinder.issueCommand(new G.U(t))}));let i=!1;s.registerButton("Mesh","Toggle flat shading",(()=>{i=!i;for(const e of this.mesh.chunks)e.setFlatShading(i)})),s.registerButton("Mesh","Cycle all chunk materials",(()=>{this.debugCycleChunkMaterials()})),s.registerButton("Mesh","Highlight Rooms",this.debugColorizeChunks),s.registerButton("Mesh","Highlight Chunks",(()=>this.debugColorizeChunks(!0,!0)));const o=(e,i,r,o,n)=>{s.registerSetting(e,i,r,!0,P.SettingPersistence.NONE,n),t.onPropertyChanged(i,o)};o("Wireframe",_.Lp,!1,this.toggleWireframe.bind(this));const n={[U.h.Wireframe]:{Wireframe:["thickness","wireframeOpacity","stroke","fillEnabled","fill","insideAltColor","dualStroke","secondThickness"],"Wireframe Dashes":["dashEnabled","dashLength","dashAnimate","dashOverlap"],"Wireframe Advanced":["squeeze","squeezeMin","squeezeMax"]}};for(const e in n){const t=D.Z.modelChunk.uniforms[e];for(const s in n[e])for(const i of n[e][s])o(s,i,t[i].value,(e=>{for(const t of this.mesh.chunks)t.setMaterialsUniform({[i]:e})}),t[i].range)}}async debugCycleChunkMaterials(){const e=[];for(const t in U.h)isNaN(Number(t))&&e.push(U.h[t]);const t=[];for(const e in E.S)isNaN(Number(e))&&t.push(E.S[e]);N.info(`Available ChunkMaterialCapabilities: ${e}`);const s=[];for(let t=0;t<1<<e.length-1;t++){const i={};for(let s=e.length-1;s>=0;s--){i[e[s]]=Boolean(t&1<<s)}s.push(i)}N.info(`There are ${s.length*t.length} options to test`);for(let e=0;e<t.length;e++){await this.engine.commandBinder.issueCommand(new G.U(e));for(const t of s){N.info(`Testing ChunkRenderingMode.${E.S[e]} with capabilities: ${JSON.stringify(t,void 0,2)}`);const s=new T.Vector4(Math.random(),Math.random(),Math.random(),.5);for(const e of Object.keys(t))for(const i of this.mesh.chunks)i.setColorOverlay(s),i.setMeshPreviewSphere(new T.Vector3(0,0,0)),i.overrideCapability(e,t[e]);await(0,O.gw)(100)}await(0,O.gw)(100)}await this.engine.commandBinder.issueCommand(new G.U(null))}}var $=s(17403),q=s(83229);class MeshRenderPass{constructor(e,t,s=128,i=128){this.slots=e,this.renderToTextureModule=t,this.width=s,this.height=i,this.sizeMultiplier=1/8,this.pixelBuffer=new Uint8Array(4),this.readBuffer=null,this.readPixelsAsync=Promise.resolve(this.pixelBuffer)}get renderTarget(){return this._renderTarget||(this._renderTarget=new T.WebGLRenderTarget(this.width,this.height,{type:T.UnsignedByteType,format:T.RGBAFormat,depthBuffer:!1,stencilBuffer:!1,generateMipmaps:!1,minFilter:T.NearestFilter,magFilter:T.NearestFilter})),this._renderTarget}pixels(){return this.pixelBuffer}renderAndReadAsync(e,t){this.beforeRender(),this.updateReadBufferSize(),this.readPixelsAsync=this.renderToTextureModule.renderAndReadAsync({mesh:e,camera:t,target:this.renderTarget,clear:!0},{x:0,y:0,width:this.width,height:this.height},{buffer:this.pixelBuffer}).then((e=>(this.pixelBuffer=e,this.pixelBuffer))),this.afterRender()}render(e,t,s=!1,i=!0){this.beforeRender();let{width:r,height:o}=this.renderToTextureModule.getRenderSize();r=Math.max(1,Math.floor(r*this.sizeMultiplier)),o=Math.max(1,Math.floor(o*this.sizeMultiplier)),r===this.renderTarget.width&&o===this.renderTarget.height||this.renderTarget.setSize(r,o),this.renderToTextureModule.render(this.renderTarget,e,t),s&&this.renderToScreen(),i&&this.afterRender()}renderToScreen(){this.renderToTextureModule.renderToScreen(this.renderTarget,!1)}readPixels(){this.updateReadBufferSize();const e=this.pixelBuffer;return this.pixelBuffer=this.renderToTextureModule.getRenderTargetData(this.renderTarget,e),this.pixelBuffer}updateReadBufferSize(){const e=this.renderTarget.width*this.renderTarget.height*4;this.pixelBuffer.length!==e&&(this.pixelBuffer=new Uint8Array(e))}beforeRender(){this.width===this.renderTarget.width&&this.height===this.renderTarget.height||this.renderTarget.setSize(this.width,this.height);for(const e of this.slots)for(const t of e.chunks)this.beforeRenderChunk(t,e)}afterRender(){for(const e of this.slots)for(const t of e.chunks)this.afterRenderChunk(t,e)}}class TextureQualityRenderPass extends MeshRenderPass{constructor(){super(...arguments),this.prevColor=new WeakMap}beforeRenderChunk(e,t){this.prevColor.set(t,e.getColorOverlay()),e.setColorOverlay((0,q.O7)(t.quality))}afterRenderChunk(e,t){var s;e.setColorOverlay(null!==(s=this.prevColor.get(t))&&void 0!==s?s:null)}}class TextureScoreRenderPass extends MeshRenderPass{constructor(){super(...arguments),this.prevColor=new WeakMap}beforeRender(){this.maxValue=this.slots.reduce(((e,t)=>Math.max(e,t.screenCoverageScore)),1e-9),super.beforeRender()}beforeRenderChunk(e,t){const s=t.screenCoverageScore/this.maxValue,i=new T.Vector4(s,s,s,1);this.prevColor.set(t,e.getColorOverlay()),e.setColorOverlay(i)}afterRenderChunk(e,t){var s;e.setColorOverlay(null!==(s=this.prevColor.get(t))&&void 0!==s?s:null)}}var j=s(31117),Z=s(60050);class MeshTextureSlot{constructor(e,t=Z.V.Standard,s){this.lod=t,this.chunkedTexInfo=s,this.chunks=new Set,this.loading=!1,this.unloaded=!1,this.screenCoverage=0,this.screenCoverageScore=0,this.sightings=new j.P(_.EJ.sightingMaxAge),this.textureName=e,this.lod=t,s&&((0,q.qT)().registerQualities(t,s.maxTextureSize,s.maxTexelSize,s.minScale),this.quality=(0,q.qT)().min(t),this.targetQuality=this.quality),this.minQuality=(0,q.qT)().min(t),this.maxQuality=this.minQuality}setTexture(e){const t=this.texture;if(this.texture=e,t&&t!==e&&t.dispose(),e)for(const t of this.chunks)t.setMeshTexture(e)}async getUrl(e){const t=(0,q.qT)().get(e),{assetType:s,lod:i}=t;if(this.textureData){let e=this.textureName;if(!this.chunkedTexInfo){const t=this.textureName.match(/[_.]([0-9]{3})[_.]/);if(!t)throw new Error(`Could not parse texture index from texture name: ${this.textureName}`);e=t[1]}return(await this.textureData[s].get()).urlTemplate.replace("<folder>",`${i}`).replace("<texture>",e)}{const e=this.textureName.match(/^([a-f0-9]+(_10k|_50k)?)/);if(!e)throw new Error(`Unknown format for texture name: ${this.textureName}`);return`${e[0]}_texture_jpg_${s}/${this.textureName}`}}getEmbeddedTexture(){var e;const t=null===(e=this.chunks.entries().next())||void 0===e?void 0:e.value;return t?t[0].embeddedTexture:void 0}}class TextureBudgeter{constructor(e,t,s=.85){this.renderer=e,this.maxBudget=t,this.pctTotalMemory=s,this.lods=new Map,this.orders={},this.slotTexSizes=new Map}update(e){this.updateBudget(void 0),this.updateTargetQualitiesFromBudget()}updateBudget(e){if(e){this.slots=e;const t=(0,q.qT)();e.forEach((e=>{const s=this.lods.get(e.lod)||new Set;s.add(e),this.lods.set(e.lod,s),this.orders[e.lod]=t.order(e.lod)}))}if(this.shouldRestrictBudget()){const e=this.calcCurrentTexturesSize(),t=this.renderer.estimatedGPUMemoryAllocated()-e,s=this.maxBudget()-t;this.budget=s*this.pctTotalMemory}else this.budget=1/0;return this}updateTargetQualitiesFromBudget(){let e=0;for(const t of this.slots)this.updateBudgetSize(t),t.targetQuality=t.minQuality,e+=this.getBudgetSize(t,t.targetQuality);const t=(t,s)=>t.maxQuality<s||(e-=this.getBudgetSize(t,t.targetQuality),e+=this.getBudgetSize(t,s),!(e>this.budget)&&(t.targetQuality=s,!0));if(this.shouldRestrictBudget()){for(const e of this.slots)for(const s of this.orders[e.lod])if(!t(e,s))return}else for(const[e,s]of this.lods.entries())for(const i of this.orders[e])for(const e of s)if(!t(e,i))return}shouldRestrictBudget(){return this.maxBudget()!==1/0}getBudgetSize(e,t){if(!t)return 0;const s=(0,q.qT)().get(t);let i=0;if(e){const s=(0,q.qT)().min(e.lod);s!==t&&e.getEmbeddedTexture()&&(i=this.getBudgetSize(e,s));const r=e.textureName+t,o=this.slotTexSizes.get(r);if(o)return o+i}return(s?s.textureSize:4096)**2*4+i}updateBudgetSize(e){var t;const s=e.textureName+e.quality,i=null!==(t=e.texture)&&void 0!==t?t:e.getEmbeddedTexture();this.slotTexSizes.set(s,this.texSizeBytes(i))}calcCurrentTexturesSize(){return this.slots.reduce(((e,t)=>{var s;const i=t.getEmbeddedTexture(),r=null!==(s=t.texture)&&void 0!==s?s:i;return r===i?e+this.texSizeBytes(r):e+this.texSizeBytes(r)+this.texSizeBytes(i)}),0)}texSizeBytes(e){if(!e)return 0;if(e.mipmaps.length>0)return e.mipmaps.reduce(((e,t)=>e+t.data.length),0);let t=e.image.width*e.image.height*4,s=t/4;for(;s>=1;)t+=s,s/=4;return t}}var W=s(26517),H=s(74170),Y=s(28180),J=s(70446);const K=new F.Z("tex-lod");class MeshTextureLoader{constructor(e,t,s,i,r,o,n,a,h,d){this.textureLOD=e,this.urls=t,this.modelObject=s,this.camera=i,this.cameraData=r,this.renderer=o,this.renderToTextureModule=n,this.engine=a,this.chunkVisibilityChecker=h,this.rendererModule=d,this.name="texture-streaming",this.slots=[],this.textureNameToSlot={},this.chunkIdToSlot={},this._systemMin=q.S7.LOW,this._systemMax=q.S7.ULTRA,this.allowTextureDownload=()=>!0,this.concurrentLoadingTextures=1,this.concurrentDownloadingTiles=12,this.autoLoadTiles=!1,this.lastSortedAt=0,this.loadingTextures=0,this.downloadingTiles=0,this.totalTextures={},this.totalTiles=0,this.textureQualityRenderPass=new TextureQualityRenderPass(this.slots,this.renderToTextureModule),this.textureScoreRenderPass=new TextureScoreRenderPass(this.slots,this.renderToTextureModule),this.abortController=new AbortController,this._chunkSlotsSet=new Set}setModel(e,t,s,i){this.textureApiInfo=s,this.modelObject=e,this.slots.length=0,this.textureNameToSlot={},this.chunkIdToSlot={},this.addChunkSlots([...t]),this.textureBudgeter=new TextureBudgeter(this.rendererModule,i),this.textureBudgeter.updateBudget(this.slots),this.updateSystemQualityRanges(),this.chunkVisibilityChecker.notifyOnNewSighting(((e,t)=>{const s=this.addChunkSlots([e]);for(const e of s)e.sightings.push(t)}))}addChunkSlots(e){this._chunkSlotsSet.clear();let t=!1;for(const s of e){const e=s.textureName;let i=this.textureNameToSlot[e];i||(t=!0,i=new MeshTextureSlot(e,s.lod,s.textureLODInfo),s.embeddedTexture&&i.setTexture(s.embeddedTexture),this.textureApiInfo&&(i.textureData=this.textureApiInfo),this.textureNameToSlot[s.textureName]=i,this.slots.push(i)),i.chunks.has(s)||(t=!0,i.chunks.add(s),i.texture&&s.setMeshTexture(i.texture)),this._chunkSlotsSet.add(i),this.chunkIdToSlot[s.id]=i}return t&&this.textureBudgeter&&(this.textureBudgeter.updateBudget(this.slots),this.updateSystemQualityRanges()),this._chunkSlotsSet}removeChunks(e){for(const t of e){const e=this.chunkIdToSlot[t.id];if(e){if(e.chunks.delete(t),0===e.chunks.size){e.unloaded=!0,e.setTexture(null);const s=this.slots.indexOf(e);this.slots.splice(s,1),delete this.textureNameToSlot[t.textureName]}delete this.chunkIdToSlot[t.id]}else K.error("Missing slot for chunk!")}}setQuality(e,t){this._systemMin=e,this._systemMax=t,this.updateSystemQualityRanges()}updateSystemQualityRanges(){const e=(0,q.qT)();this.minQuality={},this.maxQuality={};for(const t of new Set([...this.slots.map((e=>e.lod))]).values())this.minQuality[t]=e.nearestQuality(t,this._systemMin),this.maxQuality[t]=e.nearestQuality(t,this._systemMax);for(const e of this.slots)e.minQuality=this.minQuality[e.lod],e.maxQuality=e.maxQuality?Math.min(this.maxQuality[e.lod],e.maxQuality):this.maxQuality[e.lod]}get textureCount(){return this.slots.length}loadAll(e){if(!this.slots[0]||!this.slots[0].textureName)return Promise.resolve([]);const t=(0,q.qT)();if(!t.valid(e))return K.warn(e,"not found in",t),Promise.resolve([]);const s=this.slots.map((t=>this.loadTexture(t,e,!1)));return Promise.all(s)}onWebGLContextLost(){this.abortController.abort();for(const e of this.slots)e.texture=null}onWebGLContextRestored(){this.abortController=new AbortController;for(const e of this.slots)this.loadTexture(e,e.quality)}async loadTexture(e,t,s=!0){var i,r;const o=(0,q.qT)();o.valid(t)||K.warn(t,"not found in",o);const n=o.get(t),a=(null===(i=e.chunkedTexInfo)||void 0===i?void 0:i.maxTextureSize)||n.assetSize,h=Math.min(a,n.textureSize);e.lastLoadedAt=performance.now();let d=e.texture;if(!d||t!==e.quality){if(d&&t<e.quality&&e.texture){const s=null===(r=e.chunks.values().next().value)||void 0===r?void 0:r.embeddedTexture;if(s&&s.image.width>=h&&s.mipmaps[0].data.length<=h*h*4)return e.quality=t,void e.setTexture(s);{const s=this.renderToTextureModule.resizeTexture(d,h);return X(s,e),e.quality=t,void e.setTexture(s)}}e.loading=!0,this.loadingTextures++,this.totalTextures[h]=(this.totalTextures[h]||0)+1;try{const i=await e.getUrl(t);d=this.textureLOD!==S.l.NONE&&s?await this.loadTextureTiled(i,h,t,e,this.abortController.signal):await this.loadTextureSolid(i,h,t,this.abortController.signal),e.unloaded?d.dispose():(X(d,e),e.setTexture(d))}catch(e){}finally{this.loadingTextures--,e.quality=t,e.loading=!1}}}async loadTextureTiled(e,t,s,i,r){var o;const n=this.renderer.initSizedTexture2D(t,{generateMipmaps:!1,minFilter:T.LinearFilter,magFilter:T.LinearFilter}),a=(0,q.qT)(),h=(null===(o=i.chunkedTexInfo)||void 0===o?void 0:o.maxTextureSize)||a.get(s).assetSize,d=Math.min(h,a.get(s).textureSize),l=Math.min(d,a.get(s).tileSize),u=h/(d/l),c=async(t,s)=>{const i={};let o;u!==l&&(i.width=`${l}`),u!==h&&(i.crop=`${u},${u},x${t/d},y${s/d}`),this.downloadingTiles+=1,this.totalTiles+=1;const a=_.ZP.flipDownload;try{o=await this.urls.getImageBitmap(e,l,l,{priority:$.RequestPriority.LOW,flipY:a,signal:r},i)}finally{this.downloadingTiles-=1}const c=t,m=_.ZP.flipUpload?d-s-l:s,p=new Y._("mesh/texture/upload-tiles",(()=>this.engine.after(J.A.End).then((()=>{if(r.aborted)throw new DOMException("Aborted","AbortError");n.flipY=a&&o instanceof HTMLImageElement,this.renderer.uploadTexture2D(o,n,c,m)}))),100);return(await this.engine.commandBinder.issueCommand(p)).promise.finally((()=>{var e,t;o&&(null===(t=(e=o).close)||void 0===t||t.call(e))}))},m=[];for(let e=0;e<d;e+=l)for(let t=0;t<d;t+=l)m.push(c(e,t));try{await Promise.all(m)}catch(e){throw n.dispose(),e}return n}async loadTextureSolid(e,t,s,i){var r,o;const n=this.renderer.initSizedTexture2D(t);let a=null;try{const t=(0,q.qT)().get(s).textureSize,h=_.ZP.flipDownload;a=await this.urls.getImageBitmap(e,t,t,{priority:$.RequestPriority.LOW,flipY:h,signal:i},{width:`${t}`}),n.flipY=h&&a instanceof HTMLImageElement,this.renderer.uploadTexture2D(a,n,0,0)}catch(e){throw n.dispose(),e}finally{a&&(null===(o=(r=a).close)||void 0===o||o.call(r))}return n}analyzeTextureScreenCoverageFromRaycasts(){const e=window.innerWidth,t=(new T.Vector3).copy(this.cameraData.pose.position),s=(0,q.qT)();for(const i of this.slots){i.screenCoverage=0,i.screenCoverageScore=0,i.maxQuality=i.minQuality;const r=i.sightings.getList(),o=i.sightings.index-1;for(let n=0;n<r.length;n++){const a=r[(o-n+r.length)%r.length];if(a.raycastAge<this.chunkVisibilityChecker.raycastCounter-_.ZP.sightingMaxAge)break;const h=t.distanceTo(a.point),d=(0,W._U)(h,this.camera.projectionMatrix,e);let l=s.fromPixelSize(i.lod,d);l=Math.min(l,this.maxQuality[i.lod]),i.screenCoverageScore+=l,i.screenCoverage+=1,i.maxQuality=Math.max(l,i.maxQuality)}}this.slots.sort(((e,t)=>t.screenCoverageScore-e.screenCoverageScore)),this.textureBudgeter.updateTargetQualitiesFromBudget()}update(e){if(!this.camera||!this.autoLoadTiles||this.abortController.signal.aborted)return;this.textureBudgeter.update(e);const t=performance.now();this.textureLOD===S.l.RAYCAST&&this.scheduleRaycastTasks(t);let s=!1;for(let e=this.slots.length-1;e>=0;e--){const i=this.slots[e],r=(0,H.uZ)(i.targetQuality,i.minQuality,i.maxQuality),o=t-i.lastLoadedAt<1e3;if(!i.loading&&i.quality>r){o?s=!0:this.loadTexture(i,r);break}}if(this.allowTextureDownload()&&!s){const e=(0,q.qT)();for(const t of this.slots){if(this.loadingTextures>=this.concurrentLoadingTextures||this.downloadingTiles>=this.concurrentDownloadingTiles)break;const s=(0,H.uZ)(t.targetQuality,t.minQuality,t.maxQuality);!t.loading&&t.quality<s&&this.loadTexture(t,e.moreDetailed(t.lod,t.quality))}}_.ZP.debugRttScores&&this.textureScoreRenderPass.render(this.modelObject,this.camera,!0,_.ZP.debugRttClear),_.ZP.debugRttQuality&&this.textureQualityRenderPass.render(this.modelObject,this.camera,!0,_.ZP.debugRttClear)}scheduleRaycastTasks(e){if(!this.analyzeTaskPromise&&e-this.lastSortedAt>200){const e=()=>{this.analyzeTextureScreenCoverageFromRaycasts(),this.lastSortedAt=performance.now()},t=async e=>{await e.promise,this.analyzeTaskPromise=null},s=new Y._("mesh/texture/analyze-screen-coverage",e,100);this.analyzeTaskPromise=this.engine.commandBinder.issueCommand(s).then(t)}}}function X(e,t){e.addEventListener("dispose",(()=>{e===t.texture&&K.warn("Streamed texture disposed while still in use")}))}var ee=s(87109),te=s(43816),se=s(54374),ie=s(23251),re=s(91183);const oe=Math.round(_.ZP.sightingMaxAge/60/5)||1;class ChunkVisibilityChecker{constructor(e,t,s){this.scene=e,this.raycaster=t,this.raycastCounter=0,this.onNewSighting=new Set,this.poseSetAt=0,this.raycastRandomScreenLocation=(()=>{const e=new T.Vector3,t=new T.Vector3,s=new T.Vector3;return(i,r,o)=>{this.raycastCounter++;const n=(2-2*r)/i,a=-1+r,h=this.raycastCounter%(i*i),d=h%i,l=a+(h-d)/i*n,u=a+d*n+Math.random()*n,c=l+Math.random()*n;e.set(u,c,-1).unproject(this.camera),t.set(u,c,1).unproject(this.camera),s.subVectors(t,e).normalize();const m=this.raycaster.pick(e,s,te.Pv);if(m){if(m.face&&m.object instanceof se.g){const e=m.object.getChunk(m.face.materialIndex),t={point:m.point.clone(),raycastAge:this.raycastCounter};for(const s of this.onNewSighting.values())s(e,t)}o&&o(m)}}})(),this.camera=e.camera,s.pose.onChanged((()=>{this.poseSetAt=this.raycastCounter}))}update(){const e=_.ZP.debugLOD?(0,ie.e)(65280,this.scene):void 0,t=performance.now();for(let s=0;s<oe&&performance.now()-t<.5&&this.raycastCounter<=this.poseSetAt+_.ZP.sightingMaxAge;s++)this.raycastRandomScreenLocation(5,.05,e)}notifyOnNewSighting(e){return(0,re.k1)((()=>this.onNewSighting.add(e)),(()=>this.onNewSighting.delete(e)),!0)}}var ne=s(62029),ae=s(2252);class ModelMeshModule extends i.Y{constructor(){super(...arguments),this.name="model-mesh",this.onMeshTrimGroupChanged=e=>{this.setTrimsForMeshGroup(e)},this.updateTrimVisibilityForViewmode=e=>{if(e!==this.meshTrimUniforms.isPanoMode){this.meshTrimUniforms.isPanoMode=e;for(const e of this.meshTrimData.meshTrimsByMeshGroup.keys)this.setTrimsForMeshGroup(e)}},this.updateMeshTrim=e=>{this.meshTrimUniforms.setMeshTrim(e),this.setTrimsForMeshGroup(e.meshGroup)},this._renderMode=b.k.Hidden}async init(e,t){w||(T.Mesh.prototype.raycast=x.uL,T.BufferGeometry.prototype.computeBoundsTree=x.Xy,T.BufferGeometry.prototype.disposeBoundsTree=x.sn,w=!0),this.engine=t,this.market=t.market;const[i,n,c,p,g,y,S,C,k,D]=await Promise.all([t.getModuleBySymbol(r.y.WEBGL_RENDERER),t.getModuleBySymbol(r.y.RAYCASTER),t.getModule(h.default),t.market.waitForData(d.T),t.getModuleBySymbol(r.y.INPUT),t.getModule(l.default),t.market.waitForData(a.M_),t.market.waitForData(f.O),t.market.waitForData(u.Z),t.getModuleBySymbol(r.y.SWEEP_PANO)]),R=await t.getModuleBySymbol(r.y.SETTINGS);this.appData=await t.market.waitForData(o.pu),this.sweepData=k,this.viewmodeData=C;const O=i.getScene(),B=c.getSignedUrls(),F=p.model,L=F.uuid,P=t.claimRenderLayer(this.name);this.panoRenderer=D.getRenderer();const E=new ee.s;Q.z.setMaxVaryings(i.maxVaryings),this.chunkVisibiltyChecker=new ChunkVisibilityChecker(O,n.picking,S);const U=F.tileset&&R.tryGetProperty(_.iT,!1)&&!(0,ae.Q0)()?await Promise.all([s.e(47),s.e(670),s.e(674),s.e(321)]).then(s.bind(s,33161)):await Promise.all([s.e(47),s.e(670),s.e(674),s.e(321)]).then(s.bind(s,46151));this.modelMesh=await U.createModelMesh({uuid:L,urls:B,renderLayer:P,engine:t,settings:_.ZP,modelData:p,roomMeshData:E,chunkFactory:(e,t,s,i)=>{const r=new Q.z(e,t,s,i,!0);if(this.meshTrimUniforms){const t=this.meshTrimUniforms.getSharedFloorUniforms(e);r.setMaterialsUniform(t)}return r},chunkVisibilityChecker:this.chunkVisibiltyChecker}),this.engine.market.register(this,ee.s,E);let I=Promise.resolve();const A=this.modelMesh;this.setupMarketData(A.chunks,k);let z=e.startingMode;switch(null===z&&(z=this.viewmodeData.transition.active?this.viewmodeData.transition.to:this.viewmodeData.currentMode),z){case M.Ey.Dollhouse:case M.Ey.Floorplan:case M.Ey.Mesh:this.setRenderMode(b.k.Mesh);break;default:this.setRenderMode(b.k.PanoramaMesh)}this.modelTextureLoader=new MeshTextureLoader(e.textureLOD,B,this.modelMesh,O.camera,S,i.cwfRenderer,y,t,this.chunkVisibiltyChecker,i),this.setTextureStreamMode(e.textureLOD),I=this.modelMesh.initTextureLoader(this.modelTextureLoader,p.model.textures),n.setupOctree(this.modelMesh.boundingBox),this.modelMesh.registerCollision(g),this.renderer=new ModelRenderer(O.scene,this.modelMesh,this.modelMesh,this.panoRenderer,this.meshData,this.sweepData,this.appData,e),await t.addComponent(this,this.renderer),await I,this.bindings.push(this.engine.subscribe(m.Z,(e=>{this.renderer.updateExistingTexture(e.sweepId,e.renderTarget.texture)}))),this.bindings.push(t.commandBinder.addBinding(v.n,this.setPreviewPosition.bind(this)),t.subscribe(ne.zq,(()=>{this.modelTextureLoader.onWebGLContextLost()})),t.subscribe(ne.Xq,(()=>{this.modelTextureLoader.onWebGLContextRestored()}))),e.meshTrimEnabled?await this.bindMeshTrimListeners():this.bindMeshTrimListeners()}onUpdate(e){this.modelMesh.onUpdate(),this.modelTextureLoader&&!_.ZP.debugPauseTexStream&&this.modelTextureLoader.update(e),this.chunkVisibiltyChecker&&this.chunkVisibiltyChecker.update(),this.meshData.meshTextureOpacity.active&&(this.meshData.meshTextureOpacity.updateProgress(this.viewmodeData.transition.progress),this.meshData.commit());const t=performance.now()/1e3;for(const e of this.modelMesh.chunks)e.setTime(t)}setupMarketData(e,t){var s;const i=new Map,r=new Map,o=new T.Box3;e.forEach((e=>{e.geometry.boundingBox&&o.union(e.geometry.boundingBox),i.set(e.meshGroup,(i.get(e.meshGroup)||[]).concat(e)),r.set(e.meshSubgroup,(r.get(e.meshSubgroup)||[]).concat(e))}));const a=o.clone(),h=new T.Box3;t.iterate((e=>{e.isUnplaced()||(h.setFromCenterAndSize(e.position,n.f.UNIT),a.union(h))}));const d=new C._(0,[...o.min.toArray(),...o.max.toArray()],[...a.min.toArray(),...a.max.toArray()]);for(const[e,t]of i.entries()){const i=new T.Box3;t.forEach((e=>{e.geometry.boundingBox&&i.union(e.geometry.boundingBox)})),d.meshGroups.floors.add({meshGroup:e,boundingBox:i,parentMeshGroup:null});const o=[...new Set(t.map((e=>e.meshSubgroup)))].sort(((e,t)=>t-e));d.meshGroups.roomsByFloor.set(e,o);const n=d.meshGroups.rooms;for(const t of o){const i=new T.Box3;(r.get(t)||[]).forEach((e=>{e.geometry.boundingBox&&i.union(e.geometry.boundingBox)}));const o={meshGroup:t,boundingBox:i,parentMeshGroup:e},a=n.get(t);a?a.parentMeshGroup=Math.min(null!==(s=a.parentMeshGroup)&&void 0!==s?s:1/0,e):n.set(t,o)}d.meshGroupVisuals.floorOpacity.set(e,1),d.meshGroupVisuals.floorFadeDist.set(e,0)}this.meshData=d,this.market.register(this,C._,this.meshData)}async bindMeshTrimListeners(){this.meshTrimData=await this.engine.market.waitForData(c.Z),this.meshTrimUniforms=new MeshTrimUniforms(this.viewmodeData.isPano());const{meshTrimsByMeshGroup:e}=this.meshTrimData;this.meshTrimData.onMeshGroupChanged(this.onMeshTrimGroupChanged),this.meshTrimData.onMeshTrimChanged(this.updateMeshTrim),this.bindings.push(this.engine.subscribe(p.Z,(e=>{e.fromMode===M.Ey.Panorama&&this.updateTrimVisibilityForViewmode(e.toMode===M.Ey.Panorama)})),this.engine.subscribe(g.Z,(e=>{this.updateTrimVisibilityForViewmode(e.toMode===M.Ey.Panorama)}))),e.keys.forEach((e=>{this.setTrimsForMeshGroup(e)})),this.setMaterialsUniforms(k.eh)}setTrimsForMeshGroup(e){const t=this.meshTrimData.getTrimsForMeshGroup(e);this.meshTrimUniforms.updateMeshTrimArrays(e,t),this.setMaterialsUniforms(e)}setMaterialsUniforms(e){const t=`${e}`;if(t===`${k.eh}`)this.modelMesh.chunks.forEach((e=>{const t=this.meshTrimUniforms.getSharedFloorUniforms(e.meshGroup);e.setMaterialsUniform(t)}));else{const s=this.meshTrimUniforms.getSharedFloorUniforms(e);this.modelMesh.chunks.forEach((e=>{`${e.meshGroup}`===t&&e.setMaterialsUniform(s)}))}}async setPreviewPosition(e){const t=e.enabled&&e.previewCirclePosition?e.previewCirclePosition:null,s=e.size?e.size:.3;for(const e of this.modelMesh.chunks)e.setMeshPreviewSphere(t,s)}stats(){const e={};return e.textureCount=this.modelTextureLoader.textureCount,e}getRenderMode(){return this._renderMode}setRenderMode(e,t=y.Q9){let s=1;switch(e){case b.k.Hidden:s=1,this.modelMesh.visible=!1;break;case b.k.Mesh:s=1,this.modelMesh.visible=!0;break;case b.k.PanoramaMesh:s=0,this.modelMesh.visible=!0;break;case b.k.PanoramaCube:s=0,this.modelMesh.visible=!1;break;default:throw new Error(`unknown mode ${e}!`)}const i=this.meshData.meshTextureOpacity;i.value===s&&i.easing===t||this.meshData.meshTextureOpacity.modifyAnimation(this.meshData.meshTextureOpacity.value,s,100,t),this.log.debug(`setRenderMode from ${this._renderMode} to ${e}`),this._renderMode=e}setTextureLimits(e,t){this.modelMesh.setTextureQuality(this.modelTextureLoader,e,t)}setTextureStreamMode(e){switch(e){case S.l.NONE:this.modelTextureLoader.autoLoadTiles=!1;break;case S.l.RAYCAST:this.modelTextureLoader.autoLoadTiles=!0}}setSide(e,t){const s=Q.z.setSide(e);t(),Q.z.setSide(s)}}},46151:(e,t,s)=>{"use strict";s.r(t),s.d(t,{createModelMesh:()=>T});var i=s(43585),r=s(33299),o=s(37675),n=s(40603);class MeshCreationException extends n.y{constructor(e){super(e),this.name="MeshCreationException"}}var a=s(2212),h=s(54374),d=s(89741);class FloorMesh extends a.Object3D{constructor(e,t=r.o.ALL){super(),this.renderLayer=t,this.roomMeshes=new d.Z((e=>e.meshSubgroup)),this.boundingBox=new a.Box3,this.size=new a.Vector3,this.center=new a.Vector3,this._chunks=[],this.built=!1,this.name=`FloorMesh:${e}`,this.meshGroup=e}dispose(){this.reset(),this.roomMeshes.clear()}reset(){for(const e of this.roomMeshes)e.dispose(),this.remove(e);this._chunks.length=0,this.built=!1}addChunk(e){const t=this.getOrCreateRoomMesh(e.meshSubgroup);this._chunks.push(e),t.addChunk(e)}build(){if(this.built)throw new Error("build() should only be called once");this.boundingBox.makeEmpty();for(const e of this.roomMeshes)this.add(e),this.boundingBox.union(e.boundingBox);this.center=this.boundingBox.getCenter(this.center),this.size=this.boundingBox.getSize(this.size),this.built=!0}get chunks(){return this._chunks}getOrCreateRoomMesh(e){let t=this.roomMeshes.get(e);return t||(t=new h.g(this.meshGroup,e,this.renderLayer),this.roomMeshes.add(t),this.add(t)),t}}var l=s(76177),u=s(83229),c=s(5477),m=s(3614),p=s(23616);const g=new c.Z("dam-loader");class DamLoader{constructor(){this.decoder=s(92011).uO}async load(e,t,s){g.time("download");const i=await t.getFile(e,{responseType:"arraybuffer",onProgress:s});return g.timeEnd("download"),this.parse(i)}parse(e){g.time("parse proto");const t=this.decoder.read(new m(e));g.timeEnd("parse proto"),g.time("convert to webgl");const s=this.convertProtobufToSceneObject(t);return g.timeEnd("convert to webgl"),s}convertProtobufToSceneObject(e){if(0===e.chunk.length)return g.warn("No chunks in damfile..."),[];const t=new a.Matrix4;return t.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),e.chunk.map((function(e){const s=new a.BufferGeometry;s.setAttribute("position",new a.BufferAttribute(new Float32Array(e.vertices.xyz,0,3),3)),e.vertices.uv.length>0&&s.setAttribute("uv",new a.BufferAttribute(new Float32Array(e.vertices.uv,0,2),2)),s.setIndex(new a.BufferAttribute(new Uint32Array(e.faces.faces,0,1),1)),s.applyMatrix4(t),s.computeBoundingBox();const{group:i,subgroup:r}=(0,p.xc)(e.chunk_name);return new o.z(i,r,s,e.material_name)}))}}var f=s(60050),M=s(2252);const y=new c.Z("mesh");class ModelMeshDam extends l.e{constructor(e,t,s=r.o.ALL){super(),this.renderLayer=s,this.floorMeshes=new d.Z((e=>e.meshGroup)),this.built=!1,this.uuid=e,this.name=`ModelMesh:${e}`,this.signedUrls=t,this.layers.mask=s.mask}dispose(){this.floorMeshes.mapElements((e=>{e.dispose(),this.remove(e)})),this.floorMeshes.clear(),this._chunks.length=0,this.built=!1}reset(){this.floorMeshes.mapElements((e=>{e.reset(),this.remove(e)})),this._chunks.length=0,this.built=!1}async load(e={}){const{roomMeshData:t}=e;(0,M.Q0)()&&(e.chunks=[]);let s=e.chunks?e.chunks:await class ModelLoader{static async load(e,t,s,i=0){const r=new DamLoader,o=(t.meshUrls?t.meshUrls:[{suffix:"_50k",extension:"dam"},{suffix:"",extension:"dam"}])[i];if(!o)return Promise.reject("No suitable model file found...");const{url:n,suffix:a,extension:h}=o,d=n?await n.get():`${e}${a}.${h}`;return r.load(d,t,s).catch((()=>this.load(e,t,s,++i)))}}.load(this.uuid,this.signedUrls,e.onProgress).catch((e=>{y.error(e);const t=e instanceof Error?e.message:"Failed to load model mesh";throw new MeshCreationException(t)}));if(0===s.length){y.warn("No geometry found for model, loading faux geometry, disabling outside view-mode");const e=new a.PlaneBufferGeometry(5,5,1,1);e.rotateX(-Math.PI/2),e.computeBoundingBox();const t=new o.z(0,0,e);t.forEachMaterial((e=>e.visible=!1)),s=[t]}s.forEach((e=>{this.addChunk(e)})),this.build(t)}addChunk(e){const t=this.getOrCreateFloorMesh(e.meshGroup);this._chunks.push(e),t.addChunk(e)}build(e){var t,s;if(this.built)throw new Error("build() should only be called once");let i=0,r=0;for(const e of this.floorMeshes){this.add(e);for(const r of e.roomMeshes)r.build(),r.geometry.boundsTree||null===(s=(t=r.geometry).computeBoundsTree)||void 0===s||s.call(t),i++;e.build(),r++}y.debug(`FloorMeshes: ${r} RoomMeshes: ${i} Chunks: ${this._chunks.length}`),this.boundingBox.makeEmpty();for(const e of this.floorMeshes)this.boundingBox.union(e.boundingBox);this.size=this.boundingBox.getSize(this.size),this.center=this.boundingBox.getCenter(this.center),e.root=this,e.floors=new Set(this.floorMeshes),e.rooms=this.roomMeshes,e.commit(),this.built=!0}get roomMeshes(){const e=new Set;for(const t of this.floorMeshes)for(const s of t.roomMeshes)e.add(s);return e}setSide(e){for(const t of this.floorMeshes)for(const s of t.roomMeshes)this.setSideRecursively(s,e)}async initTextureLoader(e,t){e.setModel(this,this.chunks,t,(()=>1/0)),await e.loadAll((0,u.qT)().min(f.V.Standard))}registerCollision(e){e.registerMesh(this,!0);for(const t of this.roomMeshes)e.registerSnappingMeshGeometry(t.name,t.geometry,{meshGroup:t.meshGroup})}setTextureQuality(e,t,s){e.setQuality(t,s)}onUpdate(){}setSideRecursively(e,t){e instanceof a.Mesh&&e.material&&e.material instanceof a.MeshBasicMaterial&&(e.material.side=t);for(const s of e.children)this.setSideRecursively(s,t)}getOrCreateFloorMesh(e){let t=this.floorMeshes.get(e);return t||(t=new FloorMesh(e,this.renderLayer),this.floorMeshes.add(t),this.add(t)),t}}async function T({uuid:e,urls:t,renderLayer:s,engine:r,roomMeshData:o}){const n=new ModelMeshDam(e,t,s);return await n.load({roomMeshData:o,onProgress:e=>{r.broadcast(new i.Z(e.loaded,e.total))}}),n}},68013:(e,t,s)=>{"use strict";s.d(t,{t:()=>a});var i=s(87100),r=s(17403),o=s(2252),n=s(60050);const a={urlTemplateToken:"<file>",hideMenu:"1"!==(0,i.eY)("dmenu","0"),debug:"1"===(0,i.eY)("debugTiles","0"),displayBoxBounds:!1,initialMaxLOD:0,maxLOD:n.V.High,loadSiblings:!0,displayActiveTiles:!1,autoDisableRendererCulling:!0,optimizeRaycast:!1,stopAtEmptyTiles:!1,statsTiles:!1,statsTileset:!0,statsTextures:!1,statsTextureStream:!1,errorTarget:Number((0,i.eY)("errorTarget",(0,o.tq)()?6:4)),disableTileUpdates:!1,errorMultiplierRaycastOcclusion:.1,errorMultiplierHiddenFloors:.01,disposeModel:!1,limitMemoryUsage:(0,o.tq)(),allocatedMegsBeforeLimitingLod:350,lruMinExtraTiles:(0,o.tq)()?0:100,lruMaxTiles:800,lruUnloadPercent:.05,tileAssetRequestPriority:r.RequestPriority.MEDIUM,downloadQueueConcurrency:8,parseQueueConcurrency:10,snappingMaxLOD:n.V.Standard}},33161:(e,t,s)=>{"use strict";s.r(t),s.d(t,{createModelMesh:()=>Z});var i=s(14877),r=s(15099),o=s(69524),n=s(14547),a=s(2212),h=s(20725),d=s(56483),l=s(37675),u=s(83229),c=s(43585),m=s(76177),p=s(54374),g=s(88965),f=s(5477),M=s(41038),y=s(91283),T=s(68013),x=s(91183),w=s(18527),v=s(60050);class MttrDownloadQueue extends w.Z{constructor(e,t,s,i){super(),this.urlSigner=e,this.modelUrls=t,this.onProgress=i,this.priorityCallback=s}add(e,t){return super.add(e,(async e=>{var s,i,r;if(null===(s=null==e?void 0:e.content)||void 0===s?void 0:s.uri){const s=e.content.uri;try{const o=null===(i=this.onProgress)||void 0===i?void 0:i.bind(this,e);if(e.content.uri=await this.urlSigner(s),(null===(r=e.extras)||void 0===r?void 0:r.level)===v.V.Min)return t(e).then((e=>o?function(e,t){if(e.ok&&e.body){const s=e.body.getReader(),i=e.headers.get("Content-Length");let r=i?+i:0,o=0!==r,n=0;const a=new ReadableStream({async start(e){for(;;){const{done:i,value:a}=await s.read();if(a&&(n+=a.byteLength,e.enqueue(a)),i&&(r=n,o=!0),null==t||t(new ProgressEvent("progress",{lengthComputable:o,loaded:n,total:r})),i){e.close();break}}}});e=new Response(a)}return e}(e,o):e));{const s=window.fetch;try{return window.fetch=async(e,t)=>{const s=await this.modelUrls.getFile(e,{responseType:"blob",priority:T.t.tileAssetRequestPriority,onProgress:o,signal:null==t?void 0:t.signal});return new Response(s)},t(e)}finally{window.fetch=s}}}finally{e.content.uri=s}}}))}}var b=s(23616);const S=new a.Vector3,C=(new a.Matrix4).set(1,0,0,0,0,0,-1,0,0,1,0,0,0,0,0,1),k=C.clone().invert();function D(e,t){if(!1!==t(e)&&e.children)for(const s of e.children)D(s,t)}function R(e,t){const{box:s,boxTransformInverse:i}=function(e){let t=O.get(e);if(!t){const s=e.boundingVolume.box,i=new a.Box3,r=new a.Matrix4,o=new a.Vector3(s[3],s[4],s[5]),n=new a.Vector3(s[6],s[7],s[8]),h=new a.Vector3(s[9],s[10],s[11]),d=o.length(),l=n.length(),u=h.length();o.normalize(),n.normalize(),h.normalize(),0===d&&o.crossVectors(n,h),0===l&&n.crossVectors(o,h),0===u&&h.crossVectors(o,n),r.set(o.x,n.x,h.x,s[0],o.y,n.y,h.y,s[1],o.z,n.z,h.z,s[2],0,0,0,1).invert(),i.min.set(-d,-l,-u),i.max.set(d,l,u),t={box:i,boxTransformInverse:r},O.set(e,t)}return t}(t);return S.copy(e).applyMatrix4(C).applyMatrix4(i),s.containsPoint(S)}const O=new WeakMap;var B=s(33299),F=s(81080);class MTTRMeshBvh{constructor(e){this.parser=e,this.name="MTTR_three_mesh_bvh"}async loadMesh(e){const t=async(t,s)=>{var i,r;const o=this.parser.json.meshes[e].primitives[s];if(null===(i=o.extensions)||void 0===i?void 0:i.MTTR_three_mesh_bvh){const e=null===(r=o.extensions)||void 0===r?void 0:r.MTTR_three_mesh_bvh,s={roots:(await Promise.all(e.roots.map((e=>this.parser.loadAccessor(e))))).map((e=>{const t=e.array;return t.byteLength!==t.buffer.byteLength?t.slice().buffer:t.buffer})),index:new Uint8Array(0)};t.geometry.boundsTree=F.r.deserialize(s,t.geometry,{setIndex:!1})}},s=[],i=await this.loadMeshInternal(e);if(i)if("Group"===i.type){const e=i;s.push(...e.children.map(((e,s)=>t(e,s))))}else"Mesh"===i.type&&s.push(t(i,0));return await Promise.all(s),i}async loadMeshInternal(e){const t=this.parser,s=t,i=this.parser.json.meshes[e],r=i.primitives,o=[];for(let e=0,i=r.length;e<i;e++){const i=void 0===r[e].material?t.createDefaultMaterial(s.cache):t.getDependency("material",r[e].material);o.push(i)}return o.push(t.loadGeometries(r)),Promise.all(o).then((function(s){const o=s.slice(0,s.length-1),n=s[s.length-1],h=[];for(let s=0,a=n.length;s<a;s++){const a=n[s],d=r[s];let l;const u=o[s];if(d.mode!==L.TRIANGLES&&void 0!==d.mode)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+d.mode);l=new p.g(0,0,B.o.DEFAULT),l.geometry=a,l.material=u,l.name=t.createUniqueName(i.name||"mesh_"+e),P(l,i),t.assignFinalMaterial(l),h.push(l)}if(1===h.length)return h[0];const d=new a.Group;for(let e=0,t=h.length;e<t;e++)d.add(h[e]);return d}))}}const L={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123};function P(e,t){void 0!==t.extras&&"object"==typeof t.extras&&Object.assign(e.userData,t.extras)}var _=s(10338),E=s(17047);class CrossModelTextureCache{constructor(e){this.parser=e,this.name="CrossModelTextureCache"}static addToLoader(e){e.pluginCallbacks.unshift((e=>new CrossModelTextureCache(e)))}loadTexture(e){var t;const s=this.parser,i=s.json,r=i.textures[e];let o=r.source;Object.keys(r.extensions).forEach((e=>o=o||r.extensions[e].source));const n=null===(t=i.images[o])||void 0===t?void 0:t.uri;if(void 0===n)return null;const a=U.get(n);if(a)return a;let h=s._invokeOne((t=>t===this?null:t.loadTexture&&t.loadTexture(e)));h||(h=s.loadTexture(e));const d=h.then((e=>{const t=()=>{U.delete(n),null==e||e.removeEventListener("dispose",t)};return null==e||e.addEventListener("dispose",t),e}));return U.set(n,d),d}}const U=new Map;var I=s(69138);let A,z;function G(e,t,s,i){return A||(A=new MttrKTX2Loader(s,i),A.setTranscoderPath("libs/basis/"),A.detectSupport(e),A.manager=t,A.preload(),A)}class MttrKTX2Loader extends I.KTX2Loader{constructor(e,t){super(),this.urlSigner=e,this.modelUrls=t,this.taskCache=new WeakMap}load(e,t,s,i){const r=new a.CompressedTexture([],0,0);return this.urlSigner(e).then((async e=>{const i=await this.modelUrls.getFile(e,{onProgress:s,responseType:"arraybuffer",priority:T.t.tileAssetRequestPriority});let o=this.taskCache.get(i);if(!o){o={promise:this._createTexture([i])},this.taskCache.set(i,o)}const n=await o.promise;r.copy(n),r.needsUpdate=!0,t(r)})).catch(i),r}preload(){this.init()}}var V,Q=s(28180),N=s(31013),$=s(37796);class MttrParseQueue extends w.Z{constructor(){super(...arguments),this.prioritizeBy=V.FRUSTUM_ERROR_THRESH,this.priorityCallback=(e,t)=>{switch(this.prioritizeBy){case V.FRUSTUM_ERROR_THRESH:return this.sortBySelectors(e,t,[e=>Number(e.__inFrustum),e=>Number(e.__error<=T.t.errorTarget),e=>e.__error,e=>e.__distanceFromCamera]);default:return this.defaultPriorityCallback(e,t)}}}sortBySelectors(e,t,s){for(const i of s){const s=this.compareTile(e,t,i);if(null!==s)return s}return 0}compareTile(e,t,s){const i=s(e),r=s(t);return i===r?null:i>r?1:-1}defaultPriorityCallback(e,t){return e.__depth!==t.__depth?e.__depth>t.__depth?-1:1:e.__inFrustum!==t.__inFrustum?e.__inFrustum?1:-1:e.__used!==t.__used?e.__used?1:-1:e.__error!==t.__error?e.__error>t.__error?1:-1:e.__distanceFromCamera!==t.__distanceFromCamera?e.__distanceFromCamera>t.__distanceFromCamera?-1:1:0}}!function(e){e.DEFAULT="DEFAULT",e.FRUSTUM_ERROR_THRESH="FRUSTUM_ERROR_THRESH"}(V||(V={}));const q=new f.Z("tiled-mesh"),j=(y.Jk,y.br,y.yX,y.tE);y.ig;class MttrTileLoader{constructor(e,t,s,i,r,o){this.container=e,this.threeRenderer=t,this.chunkFactory=s,this.tilesetInfo=i,this.commandBinder=r,this.modelUrls=o,this.name="MttrTileLoader",this.loadStats={startTimes:{start:0,tileset:0,lod0:0},timings:{tileset:"",lod0:""}},this.lodDeferreds=[],this.tileProgress=new WeakMap,this.onChunksLoaded=new Set,this.onChunksUnloaded=new Set,this.tileSetLoaded=!1,this.minimalLoaded=!1,this.minimalTileCount=0,this.signUrl=async e=>{if(e.startsWith("blob"))return e;return(await this.tilesetInfo.urlTemplate.get()).replace(T.t.urlTemplateToken,e)},this.onTileDownloadProgress=(e,t)=>{this.tileProgress.set(e,t.lengthComputable?t.loaded/t.total:0),this.checkLoadStatus()},this.checkLoadStatus=(()=>{const e=[];let t=!1,s=!1;return(0,$.P)((()=>{t&&s||!this.tileSetLoaded||(0===e.length&&(e.push([],[]),this.tilesRenderer.traverse(((t,s,i)=>{var r;const o=null===(r=t.extras)||void 0===r?void 0:r.level;return 0!==o&&1!==o||e[o].push(t),!1}),null)),t||(t=this.notifyIfFullyLoaded(0,e,!0),t&&(q.debug("LOD0 fully downloaded, allow showing more lods"),this.minimalLoaded=!0,this.minimalTileCount=e[0].length,this.loadStats.timings.lod0=(performance.now()-this.loadStats.startTimes.lod0).toFixed(1)+"ms")),s||(s=this.notifyIfFullyLoaded(1,e,!1),s&&(e.length=0)))}),16)})()}async init(){this.loadStats.startTimes.start=performance.now();const e=await this.signUrl(this.tilesetInfo.rootFilename);this.tilesRenderer=new M.I(e);const t=function(e,t,s,i){z||(z=new _.DRACOLoader,z.setDecoderPath("libs/draco/gltf/"),z.preload());const r=new E.GLTFLoader(t);r.setDRACOLoader(z),r.register((e=>new MTTRMeshBvh(e))),CrossModelTextureCache.addToLoader(r);const o=G(e,t,s,i);return r.setKTX2Loader(o),r}(this.threeRenderer,this.tilesRenderer.manager,this.signUrl,this.modelUrls);this.configureTilesRenderer(this.tilesRenderer,t)}setSize(e,t,s){this.tilesRenderer.setCamera(e),this.tilesRenderer.setResolution(e,t,s)}notifyOnChunksLoaded(e){return(0,x.k1)((()=>this.onChunksLoaded.add(e)),(()=>this.onChunksLoaded.delete(e)),!0)}notifyOnChunksUnloaded(e){return(0,x.k1)((()=>this.onChunksUnloaded.add(e)),(()=>this.onChunksUnloaded.delete(e)),!0)}notifyOnLodProgress(e,t){this.getLodDeferred(e).progress(t)}awaitLod(e){return this.getLodDeferred(e).nativePromise()}getLodDeferred(e){return this.lodDeferreds[e]||(this.lodDeferreds[e]=new N.Q)}update(){const{minimalLoaded:e,tilesRenderer:t}=this;e?(t.displayActiveTiles=T.t.displayActiveTiles,t.loadSiblings=T.t.loadSiblings,t.optimizeRaycast=T.t.optimizeRaycast,t.stopAtEmptyTiles=T.t.stopAtEmptyTiles,t.autoDisableRendererCulling=T.t.autoDisableRendererCulling,t.downloadQueue.maxJobs=T.t.downloadQueueConcurrency,t.parseQueue.maxJobs=T.t.parseQueueConcurrency):(t.loadSiblings=!0,t.downloadQueue.maxJobs=1/0,t.parseQueue.maxJobs=1/0),t.errorTarget=T.t.errorTarget,t.lruCache.maxSize=e?Math.max(T.t.lruMaxTiles,this.minimalTileCount):1/0,t.update(),t.lruCache.minSize=T.t.lruMinExtraTiles+t.lruCache.usedSet.size,t.lruCache.unloadPercent=T.t.lruUnloadPercent}getDownloadParseStatus(){return this.tilesRenderer.stats}configureTilesRenderer(e,t){const s=e.calculateError.bind(e);e.calculateError=e=>{s(e),this.adjustScreenSpaceError&&(e.__error=this.adjustScreenSpaceError(e.__error,e))},e.manager.addHandler(/\gltf$/,t),e.manager.addHandler(/\glb$/,t),e.errorTarget=T.t.errorTarget,e.loadSiblings=T.t.loadSiblings,e.stopAtEmptyTiles=T.t.stopAtEmptyTiles,e.displayActiveTiles=T.t.displayActiveTiles;const i=e.preprocessNode.bind(e);e.preprocessNode=function(e,t,s){return i(e,t,"")},this.configurePriorityQueues(),this.container.add(e.group);const r=(new a.Quaternion).setFromAxisAngle(new a.Vector3(-1,0,0),a.MathUtils.degToRad(90));this.container.quaternion.copy(r),this.container.updateMatrixWorld(!0),e.onLoadTileSet=this.onLoadTileset.bind(this),e.onLoadModel=this.onLoadModel.bind(this),e.onDisposeModel=this.onDisposeModel.bind(this);const o=e.setTileActive.bind(e);e.setTileActive=(e,t)=>{o(e,t),this.onTileActiveChange&&this.onTileActiveChange(e,t)};const n=e.setTileVisible.bind(e);e.setTileVisible=(e,t)=>{n(e,t),this.onTileVisibleChange&&this.onTileVisibleChange(e,t)};const h=e.tileInView.bind(e);e.tileInView=e=>{var t;let s=-1;for(let i=e.parent;i;i=i.parent){const e=null===(t=i.extras)||void 0===t?void 0:t.level;if("number"==typeof e){s=e;break}}return!(s>=(this.minimalLoaded?T.t.maxLOD:T.t.initialMaxLOD))&&h(e)}}configurePriorityQueues(){const{tilesRenderer:e}=this;e.downloadQueue=new MttrDownloadQueue(this.signUrl,this.modelUrls,e.downloadQueue.priorityCallback,this.onTileDownloadProgress),e.parseQueue=new MttrParseQueue;const t=e=>{this.commandBinder.issueCommand(new Q._("mesh/tiled/priorityQueue",e,100))};e.parseQueue.schedulingCallback=t,e.downloadQueue.schedulingCallback=t}async onLoadModel(e,t){const s=function(e,t,s){var i;const r=[],o=(null===(i=t.extras)||void 0===i?void 0:i.id)||""+e.id;return e.name=o,e.traverse((e=>{var i;if(e.matrixAutoUpdate=!1,e.updateMatrix(),e instanceof p.g){const{group:n,subgroup:h,chunkIndex:d}=(0,b.xc)(`${o}-${e.name}`),l=e.material,u=l.map;let c=null==u?void 0:u.name;c||(c=l.name.replace(".jpg","")),u&&(u.encoding=a.LinearEncoding);const m=s(n,h,e.geometry,c);m.textureLODInfo=function(e,t){if(t&&(null==t?void 0:t.maxTextureSize)&&(null==t?void 0:t.texelSize)&&(null==t?void 0:t.textureScale)&&t.textureScale>0){const s=t.textureScale;return{name:e,maxTexelSize:.001*t.texelSize,maxTextureSize:t.maxTextureSize,minTexelSize:1/s*t.texelSize*.001,minTextureSize:s*t.maxTextureSize,minScale:s}}return null}(c,t.extras)||void 0,m.lod=(null===(i=t.extras)||void 0===i?void 0:i.level)||0,m.chunkIndex=d,m.notifyOnMaterialUpdated((t=>{e.material=t}));const p={};p.map=u,e.buildWithTileChunk(m),e.material=m.setMaterialsUniform(p),m.name=e.name,m.embeddedTexture=p.map,r.push(m)}})),e.matrixWorld.copy(e.matrix),e.matrixWorld.premultiply(k),e.children.forEach((e=>e.updateMatrixWorld(!0))),r}(e,t,this.chunkFactory);for(const e of s)this.container.addChunk(e);for(const e of this.onChunksLoaded.values())e(s,t);this.onModelLoaded&&this.onModelLoaded(e,t),await new Promise((e=>setTimeout(e,0))),this.checkLoadStatus()}onDisposeModel(e,t){e.traverse((e=>{if((0,g.oR)(e)){const s=e.chunks;if(!s)return void q.error("Missing chunks from RoomMesh");for(const e of s)this.container.removeChunk(e);for(const e of this.onChunksUnloaded.values())e(s,t)}})),this.onModelUnloaded&&this.onModelUnloaded(e,t),e.traverse((e=>{(0,g.oR)(e)&&e.reset()}))}onLoadTileset(e,t){var s;const i=!this.loadStats.startTimes.lod0;let r="";i&&(r=(performance.now()-this.loadStats.startTimes.start).toFixed(1),this.loadStats.timings.tileset=r+"ms");const o=null===(s=t.match(/[^/]*\.json/))||void 0===s?void 0:s[0];q.debug(`Tileset ${o} load${i?`: ${r}ms`:""}`,e),i&&(this.loadStats.startTimes.lod0=performance.now()),this.tileSetLoaded=!0,this.onTilesetLoaded&&this.onTilesetLoaded(e,t),this.tilesRenderer.update()}notifyIfFullyLoaded(e,t,s){if(!t[e])return!1;const i=t[e],r=i.filter((e=>e.__loadingState!==j)),o=this.getLodDeferred(e);return s&&o.notify(i.reduce(((e,t)=>e+(this.tileProgress.get(t)||0)/i.length),0)),0===r.length&&o.resolve(),0===r.length}}class ModelMeshTiled extends m.e{constructor(e,t=B.o.ALL){super(),this.uuid=e,this.renderLayer=t,this.boundingBox=new a.Box3,this.size=new a.Vector3,this.center=new a.Vector3,this.bindings=[],this.roomMeshesByTile=new Map,this.activeRoomMeshes=new Set,this.visibleRoomMeshes=new Set,this.activeTiles=new Set,this.tileActiveDescendantCounts=new WeakMap,this.tilesByChunkId=new Map,this.isActiveRoomMeshFilter=e=>this.activeRoomMeshes.has(e),this.isActiveRoomMeshSnapFilter=e=>{var t,s,i;const r=null===(t=e.meta)||void 0===t?void 0:t.tile;if(r){const{snappingMaxLOD:e}=T.t,t=null!==(i=null===(s=r.extras)||void 0===s?void 0:s.level)&&void 0!==i?i:1/0;if(t===e&&(this.tileActiveDescendantCounts.get(r)||0)>0||t<=e&&this.activeTiles.has(r))return!0}return!1},this.layers.mask=t.mask}dispose(){this.bindings.forEach((e=>e.cancel())),this.bindings=[]}async load(e,t,s,i,r,a,d,l,u){this.renderer=t,this.tilesetInfo=r,a.root=this,T.t.maxLOD=r.maxLOD,this.tileLoader=new MttrTileLoader(this,t.threeRenderer,d,r,e.commandBinder,u),await this.tileLoader.init(),this.tileLoader.setSize(s,i.width,i.height),this.bindings.push(e.subscribe(h.a,(e=>{this.tileLoader.setSize(s,e.width,e.height)}))),this.tileLoader.onModelLoaded=(e,t)=>{let s=this.roomMeshesByTile.get(t);s||(s=[],this.roomMeshesByTile.set(t,s)),e.traverse((e=>{e.layers.mask=this.renderLayer.mask,(0,g.oR)(e)&&(a.rooms.add(e),s.push(e),this.inputIni&&this.registerMeshForCollision(this.inputIni,e,t))})),a.commit()},this.tileLoader.onModelUnloaded=(e,t)=>{e.traverse((e=>{e instanceof p.g&&(a.rooms.delete(e),this.inputIni&&this.unregisterMeshFromCollision(this.inputIni,e))})),a.commit(),this.tileLoader.onTileActiveChange(t,!1),this.tileLoader.onTileVisibleChange(t,!1),this.roomMeshesByTile.delete(t)},this.tileLoader.onTileActiveChange=(e,t)=>{var s;const i=t?"add":"delete";null===(s=this.roomMeshesByTile.get(e))||void 0===s||s.forEach((e=>{this.activeRoomMeshes[i](e)})),this.activeTiles[i](e);for(let s=e.parent;s;s=s.parent){const e=this.tileActiveDescendantCounts.get(s)||0;this.tileActiveDescendantCounts.set(s,e+(t?1:-1))}},this.tileLoader.onTileVisibleChange=(e,t)=>{var s;null===(s=this.roomMeshesByTile.get(e))||void 0===s||s.forEach((e=>{this.visibleRoomMeshes[t?"add":"delete"](e)}))},this.initTileLodAdjustments(this.tileLoader,l),this.tileLoader.notifyOnLodProgress(0,(t=>{e.broadcast(new c.Z(t,1))})),this.tileLoader.update(),await this.tileLoader.awaitLod(T.t.initialMaxLOD),this.tileLoader.tilesRenderer.getBounds(this.boundingBox),this.boundingBox.applyMatrix4(k),this.boundingBox.getSize(this.size),this.boundingBox.getCenter(this.center),e.broadcast(new o.em(n.Y.StreamingMesh)),e.broadcast(new o.em(n.Y.StreamingTexture))}initTextureLoader(e,t){return(0,u.qT)().limitStreamingBelow(this.tilesetInfo.maxLOD),e.autoLoadTiles=!1,e.setModel(this,this._chunks,t,(()=>T.t.limitMemoryUsage?T.t.allocatedMegsBeforeLimitingLod*2**20:1/0)),this.bindings.push(this.tileLoader.notifyOnChunksLoaded((t=>{e.addChunkSlots(t);for(const e of this.onChunksLoaded.values())e(t)})),this.tileLoader.notifyOnChunksUnloaded((t=>{e.removeChunks(t)}))),e.allowTextureDownload=()=>{const{downloading:e,parsing:t}=this.tileLoader.getDownloadParseStatus();return 0===e&&0===t},Promise.resolve()}initTileLodAdjustments(e,t){const s=this.tilesByChunkId,i=new Map;let r=0;this.bindings.push(e.notifyOnChunksLoaded(((e,t)=>{for(const i of e)s.set(i.id,t)})),t.notifyOnNewSighting(((e,t)=>{r++;const o=s.get(e.id);if(o){for(let e=o.parent;e;e=e.parent)i.set(e,r);D(o,(e=>!(e!==o&&!R(t.point,e))&&(i.set(e,r),!0)))}})),this.tileLoader.notifyOnChunksUnloaded((e=>{for(const t of e)s.delete(t.id),t.dispose()}))),e.adjustScreenSpaceError=(e,t)=>{var s,o;if(1!==T.t.errorMultiplierRaycastOcclusion){(null!==(s=i.get(t))&&void 0!==s?s:-1/0)<r-d.EJ.sightingMaxAge&&(e*=T.t.errorMultiplierRaycastOcclusion)}if(1!==T.t.errorMultiplierHiddenFloors){(null===(o=this.roomMeshesByTile.get(t))||void 0===o?void 0:o.some((e=>e.chunks.some((e=>e.getOpacity()>d.xx.FADE_DEPTH_WRITE_THRESHOLD)))))||(e*=T.t.errorMultiplierHiddenFloors)}return e}}registerCollision(e){this.inputIni=e,this.tileLoader.tilesRenderer.forEachLoadedModel(((t,s)=>{t.traverse((t=>{(0,g.oR)(t)&&this.registerMeshForCollision(e,t,s)}))}))}registerMeshForCollision(e,t,s){e.registerMesh(t,!0,this.isActiveRoomMeshFilter),t.chunks[0].lod<=T.t.snappingMaxLOD&&e.registerSnappingMeshGeometry(t.name,t.geometry,{tile:s,meshGroup:t.meshGroup},this.isActiveRoomMeshSnapFilter)}unregisterMeshFromCollision(e,t){e.unregisterMesh(t),e.unregisterSnappingMeshGeometry(t.name)}addChunk(e){this._chunks.push(e)}removeChunk(e){const t=this._chunks.indexOf(e);this._chunks.splice(t,1)}onUpdate(){T.t.disableTileUpdates||(this.tileLoader.update(),this.checkDispose());const e=T.t.maxLOD;if(this.renderer.estimatedGPUMemoryAllocated()>2**20*(T.t.limitMemoryUsage?T.t.allocatedMegsBeforeLimitingLod:1/0)&&T.t.maxLOD>0&&T.t.maxLOD--,T.t.maxLOD!==e){const e=Math.min(T.t.maxLOD,this.tilesetInfo.maxLOD);(0,u.qT)().limitStreamingBelow(e)}}setTextureQuality(e,t,s){e.setQuality(u.S7.LOW,s)}get visibleChunks(){const e=this.visibleRoomMeshes;return{*[Symbol.iterator](){for(const t of e)for(const e of t.chunks)yield e}}}checkDispose(){if(T.t.disposeModel){const e=this.tileLoader.tilesRenderer,t=e;for(const e of t.cameras)t.deleteCamera(e);const s=.001,i=new a.OrthographicCamera(-s,s,s,-s,s,2*s);i.position.set(0,-1e4,0),i.rotation.setFromVector3(new a.Vector3(0,-1,0)),i.updateMatrix(),i.updateMatrixWorld(),this.tileLoader.setSize(i,100,100),e.lruCache.minSize=0,e.lruCache.unloadPercent=1,e.lruCache.markAllUnused(),e.update(),e.dispose(),l.z.disposeShared(),T.t.disableTileUpdates=!0}}}async function Z({uuid:e,engine:t,renderLayer:s,settings:o,modelData:n,roomMeshData:a,chunkFactory:h,chunkVisibilityChecker:d,urls:l}){o.flipDownload=!1,o.flipUpload=!1;const u=new ModelMeshTiled(e,s),[c,m]=await Promise.all([t.getModuleBySymbol(i.y.WEBGL_RENDERER),t.market.waitForData(r.M_)]);return await u.load(t,c,c.getCamera(),m,n.model.tileset,a,h,d,l),u}},23251:(e,t,s)=>{"use strict";s.d(t,{e:()=>h,d:()=>d});var i=s(2212);const r=s(56483).ZP.sightingMaxAge,o=new i.Color;let n,a=-1;const h=(e,t)=>{n||(n=new i.InstancedMesh(new i.SphereBufferGeometry(.005,8,4),new i.MeshBasicMaterial,r),l(n));const s=new i.Matrix4;return({point:i,distance:h})=>{s.makeScale(h,h,h).setPosition(i),n.setMatrixAt(++a%r,s),n.instanceMatrix.needsUpdate=!0;for(let t=r;t--;)n.setColorAt((a-t+r)%r,o.set(e).multiplyScalar(1-t/r));n.instanceColor&&(n.instanceColor.needsUpdate=!0),n.parent||t.scene.add(n)}},d=()=>{var e;n&&(null===(e=n.parent)||void 0===e||e.remove(n),l(n))};function l(e){const t=(new i.Matrix4).makeScale(0,0,0);for(let s=0;s<r;s++)e.setMatrixAt(s,t)}},23616:(e,t,s)=>{"use strict";s.d(t,{xc:()=>r,ko:()=>o,k7:()=>n});var i=s(2212);function r(e){const t=e.match(/group([0-9]+)/),s=e.match(/sub([0-9]+)/),i=e.match(/type([0-9]+)/),r=e.match(/mirror([0-9]+)/),o=e.match(/window([0-9]+)/),n=e.match(/chunk([0-9]+)/),a=e.match(/_chunk([0-9]+)/),h=i?parseInt(i[1],10):r&&!isNaN(parseInt(r[1],10))?100:o&&!isNaN(parseInt(o[1],10))?101:0;return{group:t?parseInt(t[1],10):0,subgroup:s?parseInt(s[1],10):0,chunkIndex:n?parseInt(n[1],10):0,nodeIndex:a?parseInt(a[1],10):0,type:h}}function o(e,t=!1){let s=e.getAttribute("barycentric");if(s)return s;const r=(e.getIndex()||e.getAttribute("position")).count/3,o=[];for(let e=0;e<r;e++){const s=t?1:0;e%2==0?o.push(0,0,1,0,1,0,1,0,s):o.push(0,1,0,0,0,1,1,0,s)}const n=new Float32Array(o);return s=new i.BufferAttribute(n,3),e.setAttribute("barycentric",s),s}function n(e=16777215*Math.random(),t=1){const s=function(e,t,s,i=1){const r=document.createElement("canvas");r.width=t,r.height=s;const o=r.getContext("2d");return o.fillStyle=`rgba(${255*e.r|0},${255*e.g|0},${255*e.b|0}, ${255*i|0})`,o.fillRect(0,0,t,s),r}(new i.Color(e),1,1,t),r=new i.CubeTexture([s,s,s,s,s,s]);return r.format=i.RGBAFormat,r.needsUpdate=!0,r}},46265:(e,t,s)=>{"use strict";s.d(t,{MU:()=>JsonStoreStore});var i,r=s(81402),o=s(78804);!function(e){e.GET="GET",e.POST="POST",e.PATCH="PATCH",e.PUT="PUT",e.DELETE="DELETE",e.OPTIONS="OPTIONS"}(i||(i={}));class ReadOnlyStore extends class Auth{constructor(){this._options={responseType:"json"}}get options(){const e=this._options;return e.headers=(0,o.m)(this.url,this._options.headers||{}),e}}{constructor(e){super(),this.config=e,this.url=e.path}async read(){const{deserialize:e}=this.config;let t=null;return this.config.cachedData&&this.config.cachedData.data?t=this.config.cachedData.data:(t=await this.config.queue.get(this.config.path,this.options),this.config.cachedData&&(this.config.cachedData.data=t)),e(t)}clearCache(){this.config.cachedData&&(this.config.cachedData.data=null)}}class JsonStoreStore extends ReadOnlyStore{constructor(e){super(e),this.config=e,this.acceptsPartial=!1,this.config.batchUpdate="batchUpdate"in this.config&&this.config.batchUpdate}async create(e){throw Error("Not implemented")}updateBatch(e,t){const{serialize:s}=this.config,r=[],o=[...new Set([...Object.keys(e),...Object.keys(t)])];for(const s of o){e[s]||t[s]||r.push(this.config.queue.delete(`${this.config.path}/${s}`,this.options))}const n=s(e,t),a=Object.assign(Object.assign({},this.options),{body:n});return r.push(this.config.queue.request(this.config.httpMethod||i.POST,this.config.path,a)),Promise.all(r)}updateInternal(e,t){const{serialize:s}=this.config,o=[],n=Object.assign({},this.options),a=Object.keys(e),h=Object.keys(t),d=(0,r.XN)(a.concat(h));for(const r in d){const a=d[r],h=e[a]||t[a];if(h){const e={};e[a]=h;const r={},d=t[a];d&&(r[a]=d);const l=s(e,r);n.body=l,o.push(this.config.queue.request(this.config.httpMethod||i.POST,this.config.path,n))}else o.push(this.config.queue.delete(`${this.config.path}/${a}`,this.options))}return Promise.all(o)}async update(e,t){this.clearCache(),await(this.config.batchUpdate?this.updateBatch(e,t||{}):this.updateInternal(e,t||{}))}async delete(e){throw Error("Not implemented")}}},27717:(e,t,s)=>{"use strict";s.d(t,{Z:()=>PanoRenderTargetResizedMessage});var i=s(4117);class PanoRenderTargetResizedMessage extends i.v{constructor(e,t,s){super(),this.size=e,this.sweepId=t,this.renderTarget=s}}}}]);